# CipherLink - Self contained data url based secret sharing tool

## Overview

This tool lets you share secret with a password or key exchange with zero infrastructure and only requires a browser. It doesnt even require a network connection. It is not audited, and just for fun, I make no guarentees on security and take no responsibility anything you do with it.

The goal was to make this small and simple so it's easy to scan and audit the code yourself without trusting a huge codebase or complicated build tooling.

## How to use

Build it by running build.py. Or use the build output url at the end of this section. Always build the url yourself or get it from this readme.

## Key exchange
Input your secret message, and generate a shareable url (it will be big). Send that url to the recipient. Then, on a different channel, they will reply with some data (a public key). Eg, send the data url by email, and  they should reply on whatsapp. If they reply by the same channel you sent the url on, ignore the data and request they use a different channel. This is to authenticate them.

## Password
Input your secret message, and a password and generate a shareable url (it will be big). Send that url to the recipient. Then, on a different channel, send the password. Eg, send the data url by email, and password on whatsapp, set to disappear.

## URLs
Copy this url into your browser bar to use the tool:
Password tool:
```url
data:text/html;base64,PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsaW5pdGlhbC1zY2FsZT0xIiAvPgo8dGl0bGU+Q2lwaGVyTGluazwvdGl0bGU+CjxzdHlsZT4KICBib2R5IHsKICAgIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIFNlZ29lIFVJLCBSb2JvdG8sIEFyaWFsLCBzYW5zLXNlcmlmOwogICAgbWFyZ2luOiAycmVtOwogICAgbGluZS1oZWlnaHQ6IDEuNAogIH0KCiAgdGV4dGFyZWEgewogICAgd2lkdGg6IDEwMCU7CiAgICBtaW4taGVpZ2h0OiA4cmVtCiAgfQoKICBpbnB1dCwKICBidXR0b24sCiAgdGV4dGFyZWEgewogICAgZm9udDogaW5oZXJpdDsKICAgIHBhZGRpbmc6IC41cmVtOwogICAgYm9yZGVyOiAxcHggc29saWQgI2NjYzsKICAgIGJvcmRlci1yYWRpdXM6IC40cmVtCiAgfQoKICBidXR0b24gewogICAgY3Vyc29yOiBwb2ludGVyCiAgfQoKICAucm93IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IC41cmVtOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbjogLjVyZW0gMAogIH0KCiAgLm91dCB7CiAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgICBib3JkZXI6IDFweCBkYXNoZWQgI2RkZDsKICAgIHBhZGRpbmc6IDFyZW07CiAgICBib3JkZXItcmFkaXVzOiAuNXJlbTsKICAgIGJhY2tncm91bmQ6ICNmYWZhZmE7CiAgICB3b3JkLWJyZWFrOiBicmVhay1hbGwKICB9Cjwvc3R5bGU+Cgo8Ym9keT4KICA8aDE+Q2lwaGVyTGluazwvaDE+CiAgPHA+U2VuZCBzZWNyZXRzIHdpdGggYSBTZWxmLWNvbnRhaW5lZCBkYXRhIFVSTCB1c2luZyBQQktERjIgKyBBRVMtR0NNLjwvcD4KICA8cD4KICAgIDxzdHJvbmc+V2FybmluZzo8L3N0cm9uZz4gVXNlIHRoaXMgdG9vbCBhdCB5b3VyIG93biByaXNrLiBBbHdheXMgZW5zdXJlIHlvdSBnb3QgdGhlIGxpbmsgZnJvbQogICAgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL2hpbGxhYy9DaXBoZXJMaW5rIj5odHRwczovL2dpdGh1Yi5jb20vaGlsbGFjL0NpcGhlckxpbms8L2E+IGFuZCB2ZXQgdGhlIGNvZGUgeW91cnNlbGYuCiAgPC9wPgogIDxwPk1ha2Ugc3VyZSB0byB1c2UgYSBzdHJvbmcgcGFzc3dvcmQuIFRoaXMgdG9vbCBkb2VzIG5vdCBlbmZvcmNlIGFueSBwYXNzd29yZCBzdHJlbmd0aCByZXF1aXJlbWVudHMuPC9wPgogIDxwPk1ha2Ugc3VyZSB5b3Ugc2VuZCB0aGUgcGFzc3dvcmQgb3ZlciBhIGRpZmZlcmVudCBjaGFubmVsIHRvIHRoZSBkYXRhIHVybC4gT3IgZWxzZSB5b3UncmUganVzdCBzZW5kaW5nIHBsYWluIHRleHQuCiAgICBFZyBzZW5kIGRhdGEgdXJsIG9uIGVtYWlsIGFuZCBwYXNzd29yZCBvbiB3aGF0c2FwcCBhcyBhIGRpc2FwcGVlcmluZyBtZXNzYWdlLjwvcD4KCiAgPGxhYmVsPlNlY3JldDwvbGFiZWw+CiAgPHRleHRhcmVhIGlkPSJzZWNyZXQiIHBsYWNlaG9sZGVyPSJUeXBlIHlvdXIgc2VjcmV0IGhlcmUuLi4iPjwvdGV4dGFyZWE+CgogIDxkaXYgY2xhc3M9InJvdyI+CiAgICA8bGFiZWwgZm9yPSJwdyI+UGFzc3dvcmQ6PC9sYWJlbD4KICAgIDxpbnB1dCBpZD0icHciIHR5cGU9InBhc3N3b3JkIiBwbGFjZWhvbGRlcj0iUGFzc3dvcmQiIC8+CiAgICA8YnV0dG9uIGlkPSJnZW5lcmF0ZS1wdyI+R2VuIHN0cm9uZyBwYXNzd29yZDwvYnV0dG9uPgogIDwvZGl2PgogIDxidXR0b24gaWQ9ImdvIj5FbmNyeXB0IG1lc3NhZ2U8L2J1dHRvbj4KCiAgPGgzPk91dHB1dDwvaDM+CiAgPGRpdiBjbGFzcz0icm93Ij4KICAgIDxidXR0b24gaWQ9ImNvcHktcHciIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImNvcHktYnRuIiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDAuNXJlbTsiPkNvcHkgUGFzc3dvcmQ8L2J1dHRvbj4KICAgIDxidXR0b24gaWQ9ImNvcHktdXJsIiBjbGFzcz0iY29weS1idG4iIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+Q29weSBVUkw8L2J1dHRvbj4KICA8L2Rpdj4KCiAgPGRpdiBpZD0idXJsIiBjbGFzcz0ib3V0Ij48L2Rpdj4KCiAgPHRlbXBsYXRlIGlkPSJkZWNvZGUtdGVtcGxhdGUiPgogICAgPCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsaW5pdGlhbC1zY2FsZT0xIiAvPgo8dGl0bGU+Q2lwaGVyTGluazwvdGl0bGU+CjxzdHlsZT4KICAgIGJvZHkgewogICAgICAgIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIFNlZ29lIFVJLCBSb2JvdG8sIEFyaWFsLCBzYW5zLXNlcmlmOwogICAgICAgIG1hcmdpbjogMnJlbTsKICAgICAgICBsaW5lLWhlaWdodDogMS40CiAgICB9CgogICAgaW5wdXQsCiAgICBidXR0b24sCiAgICB0ZXh0YXJlYSB7CiAgICAgICAgZm9udDogaW5oZXJpdDsKICAgICAgICBwYWRkaW5nOiAuNXJlbTsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjY2NjOwogICAgICAgIGJvcmRlci1yYWRpdXM6IC40cmVtCiAgICB9CgogICAgYnV0dG9uIHsKICAgICAgICBjdXJzb3I6IHBvaW50ZXIKICAgIH0KCiAgICAucm93IHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGdhcDogLjVyZW07CiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICBtYXJnaW46IC41cmVtIDAKICAgIH0KCiAgICAub3V0IHsKICAgICAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgICAgICAgYm9yZGVyOiAxcHggZGFzaGVkICNkZGQ7CiAgICAgICAgcGFkZGluZzogMXJlbTsKICAgICAgICBib3JkZXItcmFkaXVzOiAuNXJlbTsKICAgICAgICBiYWNrZ3JvdW5kOiAjZmFmYWZhCiAgICB9Cjwvc3R5bGU+Cgo8Ym9keT4KICAgIDxoMT5DaXBoZXJMaW5rPC9oMT4KICAgIDxwPkVudGVyIHBhc3N3b3JkIHRvIGRlY3J5cHQ8L3A+CiAgICA8Zm9ybSBpZD0iZm9ybSI+CiAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICAgICAgPGlucHV0IGlkPSJwdyIgdHlwZT0icGFzc3dvcmQiIHBsYWNlaG9sZGVyPSJQYXNzd29yZCIgcmVxdWlyZWQgLz4KICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPSJzdWJtaXQiPkRlY3J5cHQ8L2J1dHRvbj4KICAgICAgICA8L2Rpdj4KICAgIDwvZm9ybT4KICAgIDxkaXYgaWQ9InN0YXR1cyI+PC9kaXY+CiAgICA8cCBpZD0iYWR2ZXJ0IiBzdHlsZT0iZGlzcGxheTogbm9uZTsiPklmIHlvdSB3YW50IHRvIHVzZSB0aGlzIHRvb2wgdG8gc2VuZCBzZWNyZXRzIHlvdXJzZWxmLCBnbyB0byA8YQogICAgICAgICAgICBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vaGlsbGFjL0NpcGhlckxpbmsiPmh0dHBzOi8vZ2l0aHViLmNvbS9oaWxsYWMvQ2lwaGVyTGluazwvYT48L3A+CgogICAgPGgzPlJlc3VsdDwvaDM+CiAgICA8ZGl2IGlkPSJvdXQiIGNsYXNzPSJvdXQiPjwvZGl2PgoKICAgIDxzY3JpcHQgdHlwZT0ibW9kdWxlLXNvdXJjZSIgaWQ9ImFlczI1NmdjbS1zY3JpcHQiPgogICAgICAgIF9fSU5DTFVERV9BRVMyNTZHQ01fSlNfMl9fCiAgICA8L3NjcmlwdD4KCiAgICA8c2NyaXB0IHR5cGU9Im1vZHVsZS1zb3VyY2UiIGlkPSJwYmtkZjItc2NyaXB0Ij4KICAgICAgICBfX0lOQ0xVREVfUEJLREYyX0pTXzJfXwogICAgPC9zY3JpcHQ+CgogICAgPHNjcmlwdCB0eXBlPSJtb2R1bGUtc291cmNlIiBpZD0iaG1hYy1zY3JpcHQiPgogICAgICAgIF9fSU5DTFVERV9ITUFDX0pTXzJfXwogICAgPC9zY3JpcHQ+CgogICAgPHNjcmlwdCB0eXBlPSJtb2R1bGUiPgogICAgICAgIGNvbnN0ICQgPSAocykgPT4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzKTsKCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gbG9hZElubGluZU1vZHVsZShpZCkgewogICAgICAgICAgICBjb25zdCBjb2RlID0gJCgnIycgKyBpZCkudGV4dENvbnRlbnQ7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW2NvZGVdLCB7IHR5cGU6ICd0ZXh0L2phdmFzY3JpcHQnIH0pKTsKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGltcG9ydCh1cmwpOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgYWVzMjU2Z2NtID0gYXdhaXQgbG9hZElubGluZU1vZHVsZSgnYWVzMjU2Z2NtLXNjcmlwdCcpOwogICAgICAgIGNvbnN0IHBia2RmMiA9IGF3YWl0IGxvYWRJbmxpbmVNb2R1bGUoJ3Bia2RmMi1zY3JpcHQnKTsKICAgICAgICBjb25zdCBobWFjID0gYXdhaXQgbG9hZElubGluZU1vZHVsZSgnaG1hYy1zY3JpcHQnKTsKCiAgICAgICAgLy8gPT09IEZpbGxlZCBieSB0aGUgZ2VuZXJhdG9yID09PQogICAgICAgIGNvbnN0IENJUEhFUlRFWFRfQjY0ID0gIl9fQ0lQSEVSVEVYVF9CNjRfXyI7CiAgICAgICAgY29uc3QgSVZfQjY0ID0gIl9fSVZfQjY0X18iOwogICAgICAgIGNvbnN0IFNBTFRfQjY0ID0gIl9fU0FMVF9CNjRfXyI7CiAgICAgICAgY29uc3QgVEFHX0I2NCA9ICJfX1RBR19CNjRfXyI7CiAgICAgICAgY29uc3QgSVRFUkFUSU9OUyA9IF9fSVRFUkFUSU9OU19fOwoKICAgICAgICBjb25zdCBlbmMgPSBuZXcgVGV4dEVuY29kZXIoKTsKICAgICAgICBjb25zdCBkZWMgPSBuZXcgVGV4dERlY29kZXIoKTsKCiAgICAgICAgY29uc3QgYjY0VG9CeXRlcyA9IChiNjQpID0+IFVpbnQ4QXJyYXkuZnJvbShhdG9iKGI2NCksIGMgPT4gYy5jaGFyQ29kZUF0KDApKTsKCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gZGVjcnlwdFNlY3JldChwYXNzd29yZCkgewogICAgICAgICAgICBjb25zdCBzYWx0ID0gYjY0VG9CeXRlcyhTQUxUX0I2NCk7CiAgICAgICAgICAgIGNvbnN0IGl2ID0gYjY0VG9CeXRlcyhJVl9CNjQpOwogICAgICAgICAgICBjb25zdCBjaXBoZXJ0ZXh0ID0gYjY0VG9CeXRlcyhDSVBIRVJURVhUX0I2NCk7CiAgICAgICAgICAgIGNvbnN0IHRhZyA9IGI2NFRvQnl0ZXMoVEFHX0I2NCk7CgogICAgICAgICAgICAvLyBEZXJpdmUga2V5IHVzaW5nIHB1cmUgSlMgUEJLREYyCiAgICAgICAgICAgIGNvbnN0IGtleSA9IHBia2RmMi5wYmtkZjIoewogICAgICAgICAgICAgICAgcGFzc3dvcmQ6IGVuYy5lbmNvZGUocGFzc3dvcmQpLAogICAgICAgICAgICAgICAgc2FsdDogc2FsdCwKICAgICAgICAgICAgICAgIGl0ZXJhdGlvbnM6IElURVJBVElPTlMsCiAgICAgICAgICAgICAgICBka0xlbjogMzIsIC8vIDI1NiBiaXRzIGZvciBBRVMtMjU2CiAgICAgICAgICAgICAgICBtYWtlSGFzaEZuOiBobWFjLm1ha2VIbWFjU2hhMjU2Rm5SYXcKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgLy8gRGVjcnlwdCB1c2luZyBBRVMtR0NNCiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhZXMyNTZnY20uYWVzMjU2R2NtRGVjcnlwdCh7CiAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgaXY6IGl2LAogICAgICAgICAgICAgICAgICAgIGNpcGhlcnRleHQ6IGNpcGhlcnRleHQsCiAgICAgICAgICAgICAgICAgICAgdGFnOiB0YWcKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmICghcmVzdWx0Lm9rKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJEZWNyeXB0aW9uIGZhaWxlZCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBkZWMuZGVjb2RlKHJlc3VsdC5wbGFpbnRleHQpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkRlY3J5cHRpb24gZmFpbGVkICh3cm9uZyBwYXNzd29yZCBvciBjb3JydXB0ZWQgZGF0YSkuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICQoIiNmb3JtIikuYWRkRXZlbnRMaXN0ZW5lcigic3VibWl0IiwgYXN5bmMgKGUpID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCBzdGF0dXMgPSAkKCIjc3RhdHVzIik7CiAgICAgICAgICAgIGNvbnN0IG91dCA9ICQoIiNvdXQiKTsKICAgICAgICAgICAgc3RhdHVzLnRleHRDb250ZW50ID0gIkRlY3J5cHRpbmcuLi4iOwogICAgICAgICAgICBvdXQudGV4dENvbnRlbnQgPSAiIjsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHB3ID0gJCgiI3B3IikudmFsdWU7CiAgICAgICAgICAgICAgICBjb25zdCBwbGFpbnRleHQgPSBhd2FpdCBkZWNyeXB0U2VjcmV0KHB3KTsKICAgICAgICAgICAgICAgIG91dC50ZXh0Q29udGVudCA9IHBsYWludGV4dDsKICAgICAgICAgICAgICAgIHN0YXR1cy50ZXh0Q29udGVudCA9ICJTdWNjZXNzLiI7CiAgICAgICAgICAgICAgICAkKCIjYWR2ZXJ0Iikuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgc3RhdHVzLnRleHRDb250ZW50ID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIDwvc2NyaXB0Pgo8L2JvZHk+Cgo8L2h0bWw+CiAgPC90ZW1wbGF0ZT4KCiAgPCEtLSBub25zZW5zZSB0eXBlIHRvIGF2b2lkIGV4ZWN1dGlvbiAtLT4KICA8c2NyaXB0IHR5cGU9Im1vZHVsZS1zb3VyY2UiIGlkPSJhZXMyNTZnY20tc2NyaXB0Ij4KICAgIAoKY29uc3QgUiA9IDB4ZTEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDBuOyAKCmZ1bmN0aW9uIHRvVTgodikgewogIHJldHVybiB2IGluc3RhbmNlb2YgVWludDhBcnJheSA/IHYgOiBuZXcgVWludDhBcnJheSh2KTsKfQpmdW5jdGlvbiB4b3JCeXRlcyhhLCBiKSB7CiAgY29uc3Qgb3V0ID0gbmV3IFVpbnQ4QXJyYXkoYS5sZW5ndGgpOwogIGZvciAobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykgb3V0W2ldID0gYVtpXSBeIGJbaV07CiAgcmV0dXJuIG91dDsKfQpmdW5jdGlvbiB6ZXJvKG4pIHsKICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkobik7Cn0KCmZ1bmN0aW9uIGJ5dGVzVG9CaWdJbnRCRShiKSB7CiAgbGV0IHggPSAwbjsKICBmb3IgKGxldCBpID0gMDsgaSA8IGIubGVuZ3RoOyBpKyspIHggPSAoeCA8PCA4bikgfCBCaWdJbnQoYltpXSk7CiAgcmV0dXJuIHg7Cn0KZnVuY3Rpb24gYmlnSW50VG9CeXRlc0JFKHgsIGxlbikgewogIGNvbnN0IG91dCA9IG5ldyBVaW50OEFycmF5KGxlbik7CiAgZm9yIChsZXQgaSA9IGxlbiAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICBvdXRbaV0gPSBOdW1iZXIoeCAmIDB4ZmZuKTsKICAgIHggPj49IDhuOwogIH0KICByZXR1cm4gb3V0Owp9Cgpjb25zdCBiNjRUb1U4ID0gKGI2NCkgPT4gVWludDhBcnJheS5mcm9tKGF0b2IoYjY0KSwgKGMpID0+IGMuY2hhckNvZGVBdCgwKSk7Cgpjb25zdCBTID0gYjY0VG9VOCgKICAiWTN4M2UvSnJiOFV3QVdjci90ZXJkc3FDeVgzNldVZndyZFNpcjV5a2NzQzMvWk1tTmovM3pEU2w1ZkZ4MkRFVkJNY2p3eGlXQlpvSEVvRGk2eWV5ZFFtRExCb2JibHFnVWp2V3N5bmpMNFJUMFFEdElQeXhXMnJMdmpsS1RGalAwTytxKzBOTk00VkYrUUovVUR5ZnFGR2pRSStTblRqMXZMYmFJUkQvODlMTkRCUHNYNWRFRjhTbmZqMWtYUmx6WUlGUDNDSXFrSWhHN3JnVTNsNEwyK0F5T2dwSkJpUmN3dE9zWXBHVjVIbm55RGR0amRWT3FXeFc5T3BsZXE0SXVuZ2xMaHltdE1ibzNYUWZTNzJMaW5BK3RXWklBL1lPWVRWWHVZYkJIWjdoK0pnUmFkbU9sSnNlaCtuT1ZTamZqS0dKRGIvbVFtaEJtUzBQc0ZTN0ZnPT0iCik7CmNvbnN0IFJjb24gPSBiNjRUb1U4KCJBQUVDQkFnUUlFQ0FHelpzMkt0Tm1nPT0iKTsKCmZ1bmN0aW9uIHJvdFdvcmQodykgewogIHJldHVybiBbd1sxXSwgd1syXSwgd1szXSwgd1swXV07Cn0KZnVuY3Rpb24gc3ViV29yZCh3KSB7CiAgcmV0dXJuIHcubWFwKCh4KSA9PiBTW3hdKTsKfQoKZnVuY3Rpb24ga2V5RXhwYW5kMjU2KGtleSkgewogIGtleSA9IHRvVTgoa2V5KTsKICBpZiAoa2V5Lmxlbmd0aCAhPT0gMzIpIHRocm93IG5ldyBFcnJvcigiQUVTLTI1NiBrZXkgbXVzdCBiZSAzMiBieXRlcyIpOwoKICBjb25zdCBOayA9IDgsCiAgICBOYiA9IDQsCiAgICBOciA9IDE0OwogIGNvbnN0IHcgPSBuZXcgVWludDhBcnJheShOYiAqIChOciArIDEpICogNCk7CiAgdy5zZXQoa2V5KTsKICBjb25zdCB0ZW1wID0gWzAsIDAsIDAsIDBdOwogIGxldCBieXRlc0dlbmVyYXRlZCA9IDMyOwogIGxldCByY29uSXRlciA9IDE7CgogIHdoaWxlIChieXRlc0dlbmVyYXRlZCA8IHcubGVuZ3RoKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgdGVtcFtpXSA9IHdbYnl0ZXNHZW5lcmF0ZWQgLSA0ICsgaV07CiAgICBpZiAoKGJ5dGVzR2VuZXJhdGVkIC8gNCkgJSBOayA9PT0gMCkgewogICAgICBsZXQgdCA9IHJvdFdvcmQodGVtcCk7CiAgICAgIHQgPSBzdWJXb3JkKHQpOwogICAgICB0WzBdIF49IFJjb25bcmNvbkl0ZXIrK107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB0ZW1wW2ldID0gdFtpXTsKICAgIH0gZWxzZSBpZiAoKGJ5dGVzR2VuZXJhdGVkIC8gNCkgJSBOayA9PT0gNCkgewogICAgICBsZXQgdCA9IHN1YldvcmQodGVtcCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB0ZW1wW2ldID0gdFtpXTsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgIHdbYnl0ZXNHZW5lcmF0ZWRdID0gd1tieXRlc0dlbmVyYXRlZCAtIDMyXSBeIHRlbXBbaV07CiAgICAgIGJ5dGVzR2VuZXJhdGVkKys7CiAgICB9CiAgfQogIHJldHVybiB3OyAKfQoKZnVuY3Rpb24gYWRkUm91bmRLZXkocywgcmssIHJvdW5kKSB7CiAgZm9yIChsZXQgYyA9IDA7IGMgPCA0OyBjKyspIHsKICAgIHNbMCArIDQgKiBjXSBePSBya1tyb3VuZCAqIDE2ICsgNCAqIGMgKyAwXTsKICAgIHNbMSArIDQgKiBjXSBePSBya1tyb3VuZCAqIDE2ICsgNCAqIGMgKyAxXTsKICAgIHNbMiArIDQgKiBjXSBePSBya1tyb3VuZCAqIDE2ICsgNCAqIGMgKyAyXTsKICAgIHNbMyArIDQgKiBjXSBePSBya1tyb3VuZCAqIDE2ICsgNCAqIGMgKyAzXTsKICB9Cn0KZnVuY3Rpb24gc3ViQnl0ZXMocykgewogIGZvciAobGV0IGkgPSAwOyBpIDwgMTY7IGkrKykgc1tpXSA9IFNbc1tpXV07Cn0KZnVuY3Rpb24gc2hpZnRSb3dzKHMpIHsKICBjb25zdCB0ID0gcy5zbGljZSgpOwogIHNbMV0gPSB0WzVdOwogIHNbNV0gPSB0WzldOwogIHNbOV0gPSB0WzEzXTsKICBzWzEzXSA9IHRbMV07CiAgc1syXSA9IHRbMTBdOwogIHNbNl0gPSB0WzE0XTsKICBzWzEwXSA9IHRbMl07CiAgc1sxNF0gPSB0WzZdOwogIHNbM10gPSB0WzE1XTsKICBzWzddID0gdFszXTsKICBzWzExXSA9IHRbN107CiAgc1sxNV0gPSB0WzExXTsKfQpmdW5jdGlvbiB4dGltZSh4KSB7CiAgcmV0dXJuICgoeCA8PCAxKSBeICh4ICYgMHg4MCA/IDB4MWIgOiAwKSkgJiAweGZmOwp9CmZ1bmN0aW9uIG1peENvbHVtbnMocykgewogIGZvciAobGV0IGMgPSAwOyBjIDwgNDsgYysrKSB7CiAgICBjb25zdCBpID0gNCAqIGM7CiAgICBjb25zdCBhMCA9IHNbaV0sCiAgICAgIGExID0gc1tpICsgMV0sCiAgICAgIGEyID0gc1tpICsgMl0sCiAgICAgIGEzID0gc1tpICsgM107CiAgICBjb25zdCByMCA9IHh0aW1lKGEwKSBeIChhMSBeIHh0aW1lKGExKSkgXiBhMiBeIGEzOwogICAgY29uc3QgcjEgPSBhMCBeIHh0aW1lKGExKSBeIChhMiBeIHh0aW1lKGEyKSkgXiBhMzsKICAgIGNvbnN0IHIyID0gYTAgXiBhMSBeIHh0aW1lKGEyKSBeIChhMyBeIHh0aW1lKGEzKSk7CiAgICBjb25zdCByMyA9IGEwIF4geHRpbWUoYTApIF4gYTEgXiBhMiBeIHh0aW1lKGEzKTsKICAgIHNbaV0gPSByMCAmIDB4ZmY7CiAgICBzW2kgKyAxXSA9IHIxICYgMHhmZjsKICAgIHNbaSArIDJdID0gcjIgJiAweGZmOwogICAgc1tpICsgM10gPSByMyAmIDB4ZmY7CiAgfQp9CmZ1bmN0aW9uIGFlc0VuY3J5cHRCbG9jayhyaywgYmxvY2sxNikgewogIGNvbnN0IE5yID0gMTQ7CiAgY29uc3QgcyA9IG5ldyBVaW50OEFycmF5KGJsb2NrMTYpOwogIGFkZFJvdW5kS2V5KHMsIHJrLCAwKTsKICBmb3IgKGxldCByb3VuZCA9IDE7IHJvdW5kIDwgTnI7IHJvdW5kKyspIHsKICAgIHN1YkJ5dGVzKHMpOwogICAgc2hpZnRSb3dzKHMpOwogICAgbWl4Q29sdW1ucyhzKTsKICAgIGFkZFJvdW5kS2V5KHMsIHJrLCByb3VuZCk7CiAgfQogIHN1YkJ5dGVzKHMpOwogIHNoaWZ0Um93cyhzKTsKICBhZGRSb3VuZEtleShzLCByaywgTnIpOwogIHJldHVybiBzOwp9CgpmdW5jdGlvbiBpbmMzMihjb3VudGVyMTYpIHsKICBjb25zdCBvdXQgPSBjb3VudGVyMTYuc2xpY2UoKTsKICAKICBsZXQgY2FycnkgPSAxOwogIGZvciAobGV0IGkgPSAxNTsgaSA+PSAxMjsgaS0tKSB7CiAgICBjb25zdCB2ID0gKG91dFtpXSB8IDApICsgY2Fycnk7CiAgICBvdXRbaV0gPSB2ICYgMHhmZjsKICAgIGNhcnJ5ID0gdiA+Pj4gODsKICAgIGlmICghY2FycnkpIGJyZWFrOwogIH0KICByZXR1cm4gb3V0Owp9CgpmdW5jdGlvbiBnaGFzaE11bHRpcGx5KHgxMjgsIHkxMjgpIHsKICBsZXQgWiA9IDBuOwogIGxldCBWID0geTEyODsKICBmb3IgKGxldCBpID0gMDsgaSA8IDEyODsgaSsrKSB7CiAgICBjb25zdCBiaXQgPSAoeDEyOCA+PiBCaWdJbnQoMTI3IC0gaSkpICYgMW47CiAgICBpZiAoYml0KSBaIF49IFY7CiAgICBpZiAoKFYgJiAxbikgPT09IDBuKSB7CiAgICAgIFYgPj49IDFuOwogICAgfSBlbHNlIHsKICAgICAgViA9IChWID4+IDFuKSBeIFI7CiAgICB9CiAgfQogIHJldHVybiBaOwp9CgpmdW5jdGlvbiBnaGFzaChILCBBLCBDKSB7CiAgCiAgZnVuY3Rpb24gcGFkMTYodTgpIHsKICAgIGNvbnN0IHJlbSA9IHU4Lmxlbmd0aCAlIDE2OwogICAgcmV0dXJuIHJlbSA/IG5ldyBVaW50OEFycmF5KFsuLi51OCwgLi4ubmV3IFVpbnQ4QXJyYXkoMTYgLSByZW0pXSkgOiB1ODsKICB9CiAgY29uc3QgQV8gPSBwYWQxNihBKTsKICBjb25zdCBDXyA9IHBhZDE2KEMpOwoKICBsZXQgWSA9IDBuOwogIGNvbnN0IEhuID0gYnl0ZXNUb0JpZ0ludEJFKEgpOwoKICBmb3IgKGxldCBvZmYgPSAwOyBvZmYgPCBBXy5sZW5ndGg7IG9mZiArPSAxNikgewogICAgY29uc3QgWGkgPSBieXRlc1RvQmlnSW50QkUoQV8uc3ViYXJyYXkob2ZmLCBvZmYgKyAxNikpOwogICAgWSA9IGdoYXNoTXVsdGlwbHkoWSBeIFhpLCBIbik7CiAgfQogIGZvciAobGV0IG9mZiA9IDA7IG9mZiA8IENfLmxlbmd0aDsgb2ZmICs9IDE2KSB7CiAgICBjb25zdCBYaSA9IGJ5dGVzVG9CaWdJbnRCRShDXy5zdWJhcnJheShvZmYsIG9mZiArIDE2KSk7CiAgICBZID0gZ2hhc2hNdWx0aXBseShZIF4gWGksIEhuKTsKICB9CgogIGNvbnN0IGxlbkJsb2NrID0gbmV3IFVpbnQ4QXJyYXkoMTYpOwogIGNvbnN0IGFCaXRzID0gQmlnSW50KEEubGVuZ3RoKSAqIDhuOwogIGNvbnN0IGNCaXRzID0gQmlnSW50KEMubGVuZ3RoKSAqIDhuOwogIGxlbkJsb2NrLnNldChiaWdJbnRUb0J5dGVzQkUoYUJpdHMsIDgpLCAwKTsKICBsZW5CbG9jay5zZXQoYmlnSW50VG9CeXRlc0JFKGNCaXRzLCA4KSwgOCk7CgogIFkgPSBnaGFzaE11bHRpcGx5KFkgXiBieXRlc1RvQmlnSW50QkUobGVuQmxvY2spLCBIbik7CiAgcmV0dXJuIGJpZ0ludFRvQnl0ZXNCRShZLCAxNik7Cn0KCmZ1bmN0aW9uIGdjdHIocmssIGljYiwgaW5wdXQpIHsKICAKICBpZiAoaW5wdXQubGVuZ3RoID09PSAwKSByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoMCk7CiAgY29uc3Qgb3V0ID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQubGVuZ3RoKTsKICBsZXQgY3RyID0gaWNiLnNsaWNlKCk7CiAgZm9yIChsZXQgb2ZmID0gMDsgb2ZmIDwgaW5wdXQubGVuZ3RoOyBvZmYgKz0gMTYpIHsKICAgIGN0ciA9IGluYzMyKGN0cik7CiAgICBjb25zdCBrZXlzdHJlYW0gPSBhZXNFbmNyeXB0QmxvY2socmssIGN0cik7CiAgICBjb25zdCBjaHVuayA9IGlucHV0LnN1YmFycmF5KG9mZiwgTWF0aC5taW4ob2ZmICsgMTYsIGlucHV0Lmxlbmd0aCkpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaHVuay5sZW5ndGg7IGkrKykgewogICAgICBvdXRbb2ZmICsgaV0gPSBjaHVua1tpXSBeIGtleXN0cmVhbVtpXTsKICAgIH0KICB9CiAgcmV0dXJuIG91dDsKfQoKZXhwb3J0IGZ1bmN0aW9uIGFlczI1NkdjbUVuY3J5cHQoewogIGtleSwKICBpdiwKICBwbGFpbnRleHQsCiAgYWFkID0gbmV3IFVpbnQ4QXJyYXkoMCksCiAgdGFnTGVuZ3RoID0gMTYsCn0pIHsKICBrZXkgPSB0b1U4KGtleSk7CiAgaXYgPSB0b1U4KGl2KTsKICBwbGFpbnRleHQgPSB0b1U4KHBsYWludGV4dCk7CiAgYWFkID0gdG9VOChhYWQpOwogIGlmIChrZXkubGVuZ3RoICE9PSAzMikgdGhyb3cgbmV3IEVycm9yKCJBRVMtMjU2IGtleSBtdXN0IGJlIDMyIGJ5dGVzIik7CiAgaWYgKHRhZ0xlbmd0aCAhPT0gMTYpCiAgICB0aHJvdyBuZXcgRXJyb3IoIk9ubHkgMTI4LWJpdCB0YWdzIHN1cHBvcnRlZCBpbiB0aGlzIHJlZmVyZW5jZSIpOwoKICBjb25zdCByayA9IGtleUV4cGFuZDI1NihrZXkpOwogIGNvbnN0IEggPSBhZXNFbmNyeXB0QmxvY2socmssIHplcm8oMTYpKTsgCgogIGxldCBKMDsKICBpZiAoaXYubGVuZ3RoID09PSAxMikgewogICAgSjAgPSBuZXcgVWludDhBcnJheSgxNik7CiAgICBKMC5zZXQoaXYsIDApOwogICAgSjBbMTVdID0gMTsgCiAgfSBlbHNlIHsKICAgIGNvbnN0IFMgPSBnaGFzaChILCBuZXcgVWludDhBcnJheSgwKSwgaXYpOwogICAgSjAgPSBTOyAKICB9CgogIGNvbnN0IGNpcGhlcnRleHQgPSBnY3RyKHJrLCBKMCwgcGxhaW50ZXh0KTsgCiAgY29uc3QgUyA9IGdoYXNoKEgsIGFhZCwgY2lwaGVydGV4dCk7CiAgY29uc3QgdGFnID0geG9yQnl0ZXMoYWVzRW5jcnlwdEJsb2NrKHJrLCBKMCksIFMpLnN1YmFycmF5KDAsIHRhZ0xlbmd0aCk7CgogIHJldHVybiB7IGNpcGhlcnRleHQsIHRhZyB9Owp9CgpleHBvcnQgZnVuY3Rpb24gYWVzMjU2R2NtRGVjcnlwdCh7CiAga2V5LAogIGl2LAogIGNpcGhlcnRleHQsCiAgYWFkID0gbmV3IFVpbnQ4QXJyYXkoMCksCiAgdGFnLAp9KSB7CiAga2V5ID0gdG9VOChrZXkpOwogIGl2ID0gdG9VOChpdik7CiAgY2lwaGVydGV4dCA9IHRvVTgoY2lwaGVydGV4dCk7CiAgYWFkID0gdG9VOChhYWQpOwogIHRhZyA9IHRvVTgodGFnKTsKICBpZiAoa2V5Lmxlbmd0aCAhPT0gMzIpIHRocm93IG5ldyBFcnJvcigiQUVTLTI1NiBrZXkgbXVzdCBiZSAzMiBieXRlcyIpOwogIGlmICh0YWcubGVuZ3RoICE9PSAxNikKICAgIHRocm93IG5ldyBFcnJvcigiT25seSAxMjgtYml0IHRhZ3Mgc3VwcG9ydGVkIGluIHRoaXMgcmVmZXJlbmNlIik7CgogIGNvbnN0IHJrID0ga2V5RXhwYW5kMjU2KGtleSk7CiAgY29uc3QgSCA9IGFlc0VuY3J5cHRCbG9jayhyaywgemVybygxNikpOwoKICBsZXQgSjA7CiAgaWYgKGl2Lmxlbmd0aCA9PT0gMTIpIHsKICAgIEowID0gbmV3IFVpbnQ4QXJyYXkoMTYpOwogICAgSjAuc2V0KGl2LCAwKTsKICAgIEowWzE1XSA9IDE7CiAgfSBlbHNlIHsKICAgIEowID0gZ2hhc2goSCwgbmV3IFVpbnQ4QXJyYXkoMCksIGl2KTsKICB9CgogIGNvbnN0IFMgPSBnaGFzaChILCBhYWQsIGNpcGhlcnRleHQpOwogIGNvbnN0IGV4cGVjdGVkVGFnID0geG9yQnl0ZXMoYWVzRW5jcnlwdEJsb2NrKHJrLCBKMCksIFMpLnN1YmFycmF5KAogICAgMCwKICAgIHRhZy5sZW5ndGgKICApOwoKICBpZiAoZXhwZWN0ZWRUYWcubGVuZ3RoICE9PSB0YWcubGVuZ3RoKSByZXR1cm4geyBvazogZmFsc2UsIHBsYWludGV4dDogbnVsbCB9OwogIGxldCBkaWZmID0gMDsKICBmb3IgKGxldCBpID0gMDsgaSA8IHRhZy5sZW5ndGg7IGkrKykgZGlmZiB8PSBleHBlY3RlZFRhZ1tpXSBeIHRhZ1tpXTsKICBpZiAoZGlmZiAhPT0gMCkgcmV0dXJuIHsgb2s6IGZhbHNlLCBwbGFpbnRleHQ6IG51bGwgfTsKCiAgY29uc3QgcGxhaW50ZXh0ID0gZ2N0cihyaywgSjAsIGNpcGhlcnRleHQpOwogIHJldHVybiB7IG9rOiB0cnVlLCBwbGFpbnRleHQgfTsKfQoKICA8L3NjcmlwdD4KCiAgPHNjcmlwdCB0eXBlPSJtb2R1bGUtc291cmNlIiBpZD0icGJrZGYyLXNjcmlwdCI+CiAgICAKCmNvbnN0IHRvVTggPSAodikgPT4gKHYgaW5zdGFuY2VvZiBVaW50OEFycmF5ID8gdiA6IG5ldyBVaW50OEFycmF5KHYpKTsKY29uc3QgY29uY2F0ID0gKGEsIGIpID0+IHsKICBjb25zdCBvdXQgPSBuZXcgVWludDhBcnJheShhLmxlbmd0aCArIGIubGVuZ3RoKTsKICBvdXQuc2V0KGEsIDApOwogIG91dC5zZXQoYiwgYS5sZW5ndGgpOwogIHJldHVybiBvdXQ7Cn07CmNvbnN0IGkzMmJlID0gKHgpID0+CiAgbmV3IFVpbnQ4QXJyYXkoWwogICAgKHggPj4+IDI0KSAmIDB4ZmYsCiAgICAoeCA+Pj4gMTYpICYgMHhmZiwKICAgICh4ID4+PiA4KSAmIDB4ZmYsCiAgICB4ICYgMHhmZiwKICBdKTsKCmV4cG9ydCBmdW5jdGlvbiBwYmtkZjIoeyBwYXNzd29yZCwgc2FsdCwgaXRlcmF0aW9ucywgZGtMZW4sIG1ha2VIYXNoRm4gfSkgewogIGNvbnN0IFAgPSB0b1U4KHBhc3N3b3JkKTsKICBjb25zdCBTID0gdG9VOChzYWx0KTsKICBpZiAoIU51bWJlci5pc0ludGVnZXIoaXRlcmF0aW9ucykgfHwgaXRlcmF0aW9ucyA8PSAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIml0ZXJhdGlvbnMgbXVzdCBiZSBhIHBvc2l0aXZlIGludGVnZXIiKTsKICB9CiAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKGRrTGVuKSB8fCBka0xlbiA8PSAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImRrTGVuIG11c3QgYmUgYSBwb3NpdGl2ZSBpbnRlZ2VyIik7CiAgfQoKICBjb25zdCBoTGVuID0gMzI7IAogIGNvbnN0IGwgPSBNYXRoLmNlaWwoZGtMZW4gLyBoTGVuKTsKICBjb25zdCByID0gZGtMZW4gLSAobCAtIDEpICogaExlbjsKCiAgY29uc3QgUFJGID0gbWFrZUhhc2hGbihQKTsKICBjb25zdCBESyA9IG5ldyBVaW50OEFycmF5KGRrTGVuKTsKICBjb25zdCBibG9ja0J1ZiA9IG5ldyBVaW50OEFycmF5KGhMZW4pOyAKCiAgZm9yIChsZXQgaSA9IDE7IGkgPD0gbDsgaSsrKSB7CiAgICAKICAgIGNvbnN0IFUxID0gUFJGKGNvbmNhdChTLCBpMzJiZShpKSkpOwogICAgYmxvY2tCdWYuc2V0KFUxKTsKICAgIGxldCBVcHJldiA9IFUxOwogICAgZm9yIChsZXQgaiA9IDI7IGogPD0gaXRlcmF0aW9uczsgaisrKSB7CiAgICAgIFVwcmV2ID0gUFJGKFVwcmV2KTsKICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBoTGVuOyBrKyspIGJsb2NrQnVmW2tdIF49IFVwcmV2W2tdOwogICAgfQogICAgY29uc3Qgb2Zmc2V0ID0gKGkgLSAxKSAqIGhMZW47CiAgICBESy5zZXQoYmxvY2tCdWYuc3ViYXJyYXkoMCwgaSA9PT0gbCA/IHIgOiBoTGVuKSwgb2Zmc2V0KTsKICB9CiAgCiAgYmxvY2tCdWYuZmlsbCgwKTsKICByZXR1cm4gREs7Cn0KCiAgPC9zY3JpcHQ+CgogIDxzY3JpcHQgdHlwZT0ibW9kdWxlLXNvdXJjZSIgaWQ9ImhtYWMtc2NyaXB0Ij4KICAgICAgICAKY29uc3QgdG9VOCA9ICh2KSA9PiAodiBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgPyB2IDogbmV3IFVpbnQ4QXJyYXkodikpOwpjb25zdCBjb25jYXQgPSAoYSwgYikgPT4gewogIGNvbnN0IG91dCA9IG5ldyBVaW50OEFycmF5KGEubGVuZ3RoICsgYi5sZW5ndGgpOwogIG91dC5zZXQoYSwgMCk7CiAgb3V0LnNldChiLCBhLmxlbmd0aCk7CiAgcmV0dXJuIG91dDsKfTsKY29uc3QgaTMyYmUgPSAoeCkgPT4KICBuZXcgVWludDhBcnJheShbCiAgICAoeCA+Pj4gMjQpICYgMHhmZiwKICAgICh4ID4+PiAxNikgJiAweGZmLAogICAgKHggPj4+IDgpICYgMHhmZiwKICAgIHggJiAweGZmLAogIF0pOwoKY29uc3QgSyA9IG5ldyBVaW50MzJBcnJheShbCiAgMHg0MjhhMmY5OCwgMHg3MTM3NDQ5MSwgMHhiNWMwZmJjZiwgMHhlOWI1ZGJhNSwgMHgzOTU2YzI1YiwgMHg1OWYxMTFmMSwKICAweDkyM2Y4MmE0LCAweGFiMWM1ZWQ1LCAweGQ4MDdhYTk4LCAweDEyODM1YjAxLCAweDI0MzE4NWJlLCAweDU1MGM3ZGMzLAogIDB4NzJiZTVkNzQsIDB4ODBkZWIxZmUsIDB4OWJkYzA2YTcsIDB4YzE5YmYxNzQsIDB4ZTQ5YjY5YzEsIDB4ZWZiZTQ3ODYsCiAgMHgwZmMxOWRjNiwgMHgyNDBjYTFjYywgMHgyZGU5MmM2ZiwgMHg0YTc0ODRhYSwgMHg1Y2IwYTlkYywgMHg3NmY5ODhkYSwKICAweDk4M2U1MTUyLCAweGE4MzFjNjZkLCAweGIwMDMyN2M4LCAweGJmNTk3ZmM3LCAweGM2ZTAwYmYzLCAweGQ1YTc5MTQ3LAogIDB4MDZjYTYzNTEsIDB4MTQyOTI5NjcsIDB4MjdiNzBhODUsIDB4MmUxYjIxMzgsIDB4NGQyYzZkZmMsIDB4NTMzODBkMTMsCiAgMHg2NTBhNzM1NCwgMHg3NjZhMGFiYiwgMHg4MWMyYzkyZSwgMHg5MjcyMmM4NSwgMHhhMmJmZThhMSwgMHhhODFhNjY0YiwKICAweGMyNGI4YjcwLCAweGM3NmM1MWEzLCAweGQxOTJlODE5LCAweGQ2OTkwNjI0LCAweGY0MGUzNTg1LCAweDEwNmFhMDcwLAogIDB4MTlhNGMxMTYsIDB4MWUzNzZjMDgsIDB4Mjc0ODc3NGMsIDB4MzRiMGJjYjUsIDB4MzkxYzBjYjMsIDB4NGVkOGFhNGEsCiAgMHg1YjljY2E0ZiwgMHg2ODJlNmZmMywgMHg3NDhmODJlZSwgMHg3OGE1NjM2ZiwgMHg4NGM4NzgxNCwgMHg4Y2M3MDIwOCwKICAweDkwYmVmZmZhLCAweGE0NTA2Y2ViLCAweGJlZjlhM2Y3LCAweGM2NzE3OGYyLApdKTsKY29uc3QgUk9UUiA9ICh4LCBuKSA9PiAoeCA+Pj4gbikgfCAoeCA8PCAoMzIgLSBuKSk7CmNvbnN0IENoID0gKHgsIHksIHopID0+ICh4ICYgeSkgXiAofnggJiB6KTsKY29uc3QgTWFqID0gKHgsIHksIHopID0+ICh4ICYgeSkgXiAoeCAmIHopIF4gKHkgJiB6KTsKY29uc3QgU2lnbWEwID0gKHgpID0+IFJPVFIoeCwgMikgXiBST1RSKHgsIDEzKSBeIFJPVFIoeCwgMjIpOwpjb25zdCBTaWdtYTEgPSAoeCkgPT4gUk9UUih4LCA2KSBeIFJPVFIoeCwgMTEpIF4gUk9UUih4LCAyNSk7CmNvbnN0IHNpZ21hMCA9ICh4KSA9PiBST1RSKHgsIDcpIF4gUk9UUih4LCAxOCkgXiAoeCA+Pj4gMyk7CmNvbnN0IHNpZ21hMSA9ICh4KSA9PiBST1RSKHgsIDE3KSBeIFJPVFIoeCwgMTkpIF4gKHggPj4+IDEwKTsKCmV4cG9ydCBmdW5jdGlvbiBzaGEyNTYobXNnVTgpIHsKICBjb25zdCBtID0gdG9VOChtc2dVOCk7CiAgCiAgbGV0IGgwID0gMHg2YTA5ZTY2NywKICAgIGgxID0gMHhiYjY3YWU4NSwKICAgIGgyID0gMHgzYzZlZjM3MiwKICAgIGgzID0gMHhhNTRmZjUzYTsKICBsZXQgaDQgPSAweDUxMGU1MjdmLAogICAgaDUgPSAweDliMDU2ODhjLAogICAgaDYgPSAweDFmODNkOWFiLAogICAgaDcgPSAweDViZTBjZDE5OwoKICBjb25zdCBiaXRMZW5IaSA9IE1hdGguZmxvb3IoKG0ubGVuZ3RoIC8gMHgyMDAwMDAwMCkgPj4+IDApOyAKICBjb25zdCBiaXRMZW5MbyA9ICgobS5sZW5ndGggPj4+IDApICogOCkgPj4+IDA7IAogIGNvbnN0IGsgPSAtKG0ubGVuZ3RoICsgOSkgJiA2MzsKICBjb25zdCBwYWRkZWQgPSBuZXcgVWludDhBcnJheShtLmxlbmd0aCArIDEgKyBrICsgOCk7CiAgcGFkZGVkLnNldChtLCAwKTsKICBwYWRkZWRbbS5sZW5ndGhdID0gMHg4MDsKICAKICBwYWRkZWRbcGFkZGVkLmxlbmd0aCAtIDhdID0gKGJpdExlbkhpID4+PiAyNCkgJiAweGZmOwogIHBhZGRlZFtwYWRkZWQubGVuZ3RoIC0gN10gPSAoYml0TGVuSGkgPj4+IDE2KSAmIDB4ZmY7CiAgcGFkZGVkW3BhZGRlZC5sZW5ndGggLSA2XSA9IChiaXRMZW5IaSA+Pj4gOCkgJiAweGZmOwogIHBhZGRlZFtwYWRkZWQubGVuZ3RoIC0gNV0gPSBiaXRMZW5IaSAmIDB4ZmY7CiAgcGFkZGVkW3BhZGRlZC5sZW5ndGggLSA0XSA9IChiaXRMZW5MbyA+Pj4gMjQpICYgMHhmZjsKICBwYWRkZWRbcGFkZGVkLmxlbmd0aCAtIDNdID0gKGJpdExlbkxvID4+PiAxNikgJiAweGZmOwogIHBhZGRlZFtwYWRkZWQubGVuZ3RoIC0gMl0gPSAoYml0TGVuTG8gPj4+IDgpICYgMHhmZjsKICBwYWRkZWRbcGFkZGVkLmxlbmd0aCAtIDFdID0gYml0TGVuTG8gJiAweGZmOwoKICBjb25zdCBXID0gbmV3IFVpbnQzMkFycmF5KDY0KTsKCiAgZm9yIChsZXQgb2ZmID0gMDsgb2ZmIDwgcGFkZGVkLmxlbmd0aDsgb2ZmICs9IDY0KSB7CiAgICAKICAgIGZvciAobGV0IGkgPSAwOyBpIDwgMTY7IGkrKykgewogICAgICBjb25zdCBqID0gb2ZmICsgKGkgPDwgMik7CiAgICAgIFdbaV0gPQogICAgICAgIChwYWRkZWRbal0gPDwgMjQpIHwKICAgICAgICAocGFkZGVkW2ogKyAxXSA8PCAxNikgfAogICAgICAgIChwYWRkZWRbaiArIDJdIDw8IDgpIHwKICAgICAgICBwYWRkZWRbaiArIDNdOwogICAgfQogICAgZm9yIChsZXQgaSA9IDE2OyBpIDwgNjQ7IGkrKykgewogICAgICBXW2ldID0KICAgICAgICAoc2lnbWExKFdbaSAtIDJdKSArIFdbaSAtIDddICsgc2lnbWEwKFdbaSAtIDE1XSkgKyBXW2kgLSAxNl0pID4+PiAwOwogICAgfQoKICAgIGxldCBhID0gaDAsCiAgICAgIGIgPSBoMSwKICAgICAgYyA9IGgyLAogICAgICBkID0gaDMsCiAgICAgIGUgPSBoNCwKICAgICAgZiA9IGg1LAogICAgICBnID0gaDYsCiAgICAgIGggPSBoNzsKCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDY0OyBpKyspIHsKICAgICAgY29uc3QgdDEgPSAoaCArIFNpZ21hMShlKSArIENoKGUsIGYsIGcpICsgS1tpXSArIFdbaV0pID4+PiAwOwogICAgICBjb25zdCB0MiA9IChTaWdtYTAoYSkgKyBNYWooYSwgYiwgYykpID4+PiAwOwogICAgICBoID0gZzsKICAgICAgZyA9IGY7CiAgICAgIGYgPSBlOwogICAgICBlID0gKGQgKyB0MSkgPj4+IDA7CiAgICAgIGQgPSBjOwogICAgICBjID0gYjsKICAgICAgYiA9IGE7CiAgICAgIGEgPSAodDEgKyB0MikgPj4+IDA7CiAgICB9CgogICAgaDAgPSAoaDAgKyBhKSA+Pj4gMDsKICAgIGgxID0gKGgxICsgYikgPj4+IDA7CiAgICBoMiA9IChoMiArIGMpID4+PiAwOwogICAgaDMgPSAoaDMgKyBkKSA+Pj4gMDsKICAgIGg0ID0gKGg0ICsgZSkgPj4+IDA7CiAgICBoNSA9IChoNSArIGYpID4+PiAwOwogICAgaDYgPSAoaDYgKyBnKSA+Pj4gMDsKICAgIGg3ID0gKGg3ICsgaCkgPj4+IDA7CiAgfQoKICBjb25zdCBvdXQgPSBuZXcgVWludDhBcnJheSgzMik7CiAgY29uc3QgSCA9IFtoMCwgaDEsIGgyLCBoMywgaDQsIGg1LCBoNiwgaDddOwogIGZvciAobGV0IGkgPSAwOyBpIDwgODsgaSsrKSBvdXQuc2V0KGkzMmJlKEhbaV0pLCBpICogNCk7CiAgcmV0dXJuIG91dDsKfQoKZXhwb3J0IGZ1bmN0aW9uIG1ha2VIbWFjU2hhMjU2Rm5SYXcoa2V5KSB7CiAga2V5ID0gdG9VOChrZXkpOwogIGNvbnN0IGJsb2NrID0gNjQ7CiAgaWYgKGtleS5sZW5ndGggPiBibG9jaykga2V5ID0gc2hhMjU2KGtleSk7CiAgaWYgKGtleS5sZW5ndGggPCBibG9jaykgewogICAgY29uc3QgayA9IG5ldyBVaW50OEFycmF5KGJsb2NrKTsKICAgIGsuc2V0KGtleSk7CiAgICBrZXkgPSBrOwogIH0KICBjb25zdCBpcGFkID0gbmV3IFVpbnQ4QXJyYXkoYmxvY2spOwogIGNvbnN0IG9wYWQgPSBuZXcgVWludDhBcnJheShibG9jayk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBibG9jazsgaSsrKSB7CiAgICBpcGFkW2ldID0ga2V5W2ldIF4gMHgzNjsKICAgIG9wYWRbaV0gPSBrZXlbaV0gXiAweDVjOwogIH0KICByZXR1cm4gKG1zZykgPT4gc2hhMjU2KGNvbmNhdChvcGFkLCBzaGEyNTYoY29uY2F0KGlwYWQsIHRvVTgobXNnKSkpKSk7Cn0KCmV4cG9ydCBmdW5jdGlvbiBtYWtlSG1hY1NoYTI1NkZuKGtleSkgewogIGlmIChrZXkgPT0gbnVsbCB8fCBrZXkubGVuZ3RoID09PSAwKQogICAgdGhyb3cgbmV3IEVycm9yKCJITUFDIGtleSBtdXN0IGJlIG5vbi1lbXB0eSIpOwogIGNvbnN0IGhtYWMgPSBtYWtlSG1hY1NoYTI1NkZuUmF3KGtleSk7CiAgcmV0dXJuIChtc2cpID0+IGhtYWMobXNnKTsKfQoKICA8L3NjcmlwdD4KCiAgPHNjcmlwdCB0eXBlPSJtb2R1bGUiPgoKICAgIGNvbnN0ICQgPSAocykgPT4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzKTsKCiAgICBhc3luYyBmdW5jdGlvbiBsb2FkSW5saW5lTW9kdWxlKGlkKSB7CiAgICAgIGNvbnN0IGNvZGUgPSAkKCcjJyArIGlkKS50ZXh0Q29udGVudDsKICAgICAgY29uc3QgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChuZXcgQmxvYihbY29kZV0sIHsgdHlwZTogJ3RleHQvamF2YXNjcmlwdCcgfSkpOwogICAgICByZXR1cm4geyBtb2R1bGU6IGF3YWl0IGltcG9ydCh1cmwpLCBjb2RlIH07CiAgICB9CgogICAgY29uc3QgYWVzMjU2Z2NtID0gYXdhaXQgbG9hZElubGluZU1vZHVsZSgnYWVzMjU2Z2NtLXNjcmlwdCcpOwogICAgY29uc3QgcGJrZGYyID0gYXdhaXQgbG9hZElubGluZU1vZHVsZSgncGJrZGYyLXNjcmlwdCcpOwogICAgY29uc3QgaG1hYyA9IGF3YWl0IGxvYWRJbmxpbmVNb2R1bGUoJ2htYWMtc2NyaXB0Jyk7CgogICAgY29uc3QgREVDT0RFX1RFTVBMQVRFID0gJCgiI2RlY29kZS10ZW1wbGF0ZSIpLmlubmVySFRNTDsKCiAgICAvLyAtLS0gaGVscGVycyAtLS0KICAgIGNvbnN0IGVuYyA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgY29uc3QgYjY0ID0gKGJ1ZikgPT4gYnRvYShTdHJpbmcuZnJvbUNoYXJDb2RlKC4uLm5ldyBVaW50OEFycmF5KGJ1ZikpKTsKICAgIGNvbnN0IHJhbmQgPSAobikgPT4gY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhuZXcgVWludDhBcnJheShuKSk7CgogICAgYXN5bmMgZnVuY3Rpb24gZW5jcnlwdFNlY3JldChzZWNyZXQsIHBhc3N3b3JkLCBpdGVyYXRpb25zKSB7CiAgICAgIGNvbnN0IHNhbHQgPSByYW5kKDE2KTsKICAgICAgY29uc3QgaXYgPSByYW5kKDEyKTsKICAgICAgLy8gc3VidGxlIGlzIG5vdCBhdmFpbGFibGUgaW4gZGF0YSB1cmxzLiB1c2UgcHVyZSBKUyBpbXBsZW1lbnRhdGlvbnMuCiAgICAgIC8vIERlcml2ZSBrZXkgdXNpbmcgUEJLREYyCiAgICAgIGNvbnN0IGtleSA9IHBia2RmMi5tb2R1bGUucGJrZGYyKHsKICAgICAgICBwYXNzd29yZDogZW5jLmVuY29kZShwYXNzd29yZCksCiAgICAgICAgc2FsdDogc2FsdCwKICAgICAgICBpdGVyYXRpb25zOiBpdGVyYXRpb25zLAogICAgICAgIGRrTGVuOiAzMiwgLy8gMjU2IGJpdHMgZm9yIEFFUy0yNTYKICAgICAgICBtYWtlSGFzaEZuOiBobWFjLm1vZHVsZS5tYWtlSG1hY1NoYTI1NkZuUmF3CiAgICAgIH0pOwoKICAgICAgLy8gRW5jcnlwdCB1c2luZyBBRVMtR0NNCiAgICAgIGNvbnN0IHsgY2lwaGVydGV4dCwgdGFnIH0gPSBhZXMyNTZnY20ubW9kdWxlLmFlczI1NkdjbUVuY3J5cHQoewogICAgICAgIGtleToga2V5LAogICAgICAgIGl2OiBpdiwKICAgICAgICBwbGFpbnRleHQ6IGVuYy5lbmNvZGUoc2VjcmV0KQogICAgICB9KTsKCiAgICAgIHJldHVybiB7IGN0QjY0OiBiNjQoY2lwaGVydGV4dCksIGl2QjY0OiBiNjQoaXYpLCBzYWx0QjY0OiBiNjQoc2FsdCksIHRhZ0I2NDogYjY0KHRhZykgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBidWlsZERlY29kZUhUTUwodGVtcGxhdGUsIHsgY3RCNjQsIGl2QjY0LCBzYWx0QjY0LCB0YWdCNjQgfSwgaXRlcmF0aW9ucykgewogICAgICByZXR1cm4gdGVtcGxhdGUKICAgICAgICAucmVwbGFjZUFsbCgiX19DSVBIRVJURVhUX0I2NF9fIiwgY3RCNjQpCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fSVZfQjY0X18iLCBpdkI2NCkKICAgICAgICAucmVwbGFjZUFsbCgiX19TQUxUX0I2NF9fIiwgc2FsdEI2NCkKICAgICAgICAucmVwbGFjZUFsbCgiX19UQUdfQjY0X18iLCB0YWdCNjQpCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fSVRFUkFUSU9OU19fIiwgU3RyaW5nKGl0ZXJhdGlvbnMpKQogICAgICAgIC5yZXBsYWNlQWxsKCJfX0lOQ0xVREVfQUVTMjU2R0NNX0pTXzJfXyIsIGFlczI1NmdjbS5jb2RlKQogICAgICAgIC5yZXBsYWNlQWxsKCJfX0lOQ0xVREVfSE1BQ19KU18yX18iLCBobWFjLmNvZGUpCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fSU5DTFVERV9QQktERjJfSlNfMl9fIiwgcGJrZGYyLmNvZGUpOwogICAgfQoKICAgIGZ1bmN0aW9uIHRvRGF0YVVSTChodG1sKSB7CiAgICAgIC8vIEJhc2U2NC1lbmNvZGUgVVRGLTggc2FmZWx5CiAgICAgIGNvbnN0IHV0ZjggPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoaHRtbCk7CiAgICAgIGxldCBzID0gIiI7CiAgICAgIGZvciAoY29uc3QgYyBvZiB1dGY4KSBzICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYyk7CiAgICAgIGNvbnN0IGI2NCA9IGJ0b2Eocyk7CiAgICAgIHJldHVybiBgZGF0YTp0ZXh0L2h0bWw7YmFzZTY0LCR7YjY0fWA7CiAgICB9CgogICAgYXN5bmMgZnVuY3Rpb24gY29weVRvQ2xpcGJvYXJkKHRleHQsIGJ1dHRvbikgewogICAgICBjb25zdCBvcmlnaW5hbFRleHQgPSBidXR0b24udGV4dENvbnRlbnQ7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCk7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGNvbnN0IHRleHRhcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGV4dGFyZWEnKTsKICAgICAgICB0ZXh0YXJlYS52YWx1ZSA9IHRleHQ7CiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0ZXh0YXJlYSk7CiAgICAgICAgdGV4dGFyZWEuc2VsZWN0KCk7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRhcmVhKTsKICAgICAgfQogICAgICBidXR0b24udGV4dENvbnRlbnQgPSAiQ29waWVkISI7CiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIGJ1dHRvbi50ZXh0Q29udGVudCA9IG9yaWdpbmFsVGV4dDsKICAgICAgfSwgMjAwMCk7CiAgICB9CgogICAgJCgiI2NvcHktcHciKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgY29uc3QgcHcgPSAkKCIjcHciKS52YWx1ZTsKICAgICAgaWYgKHB3KSBjb3B5VG9DbGlwYm9hcmQocHcsICQoIiNjb3B5LXB3IikpOwogICAgfSk7CgogICAgJCgiI2NvcHktdXJsIikuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCAoKSA9PiB7CiAgICAgIGNvbnN0IHVybCA9ICQoIiN1cmwiKS50ZXh0Q29udGVudDsKICAgICAgaWYgKHVybCAmJiB1cmwgIT09ICJFbmNyeXB0aW5nLi4uIiAmJiAhdXJsLnN0YXJ0c1dpdGgoIkVycm9yOiIpKSB7CiAgICAgICAgY29weVRvQ2xpcGJvYXJkKHVybCwgJCgiI2NvcHktdXJsIikpOwogICAgICB9CiAgICB9KTsKCiAgICAkKCIjZ2VuZXJhdGUtcHciKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgY29uc3QgcHcgPSBiNjQocmFuZCgyNCkpLnJlcGxhY2UoL1wrL2csICdBJykucmVwbGFjZSgvXC8vZywgJ0InKS5yZXBsYWNlKC89L2csICcnKTsKICAgICAgJCgiI3B3IikudmFsdWUgPSBwdzsKICAgIH0pOwoKICAgICQoIiNnbyIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgYXN5bmMgKCkgPT4gewogICAgICBjb25zdCBzZWNyZXQgPSAoJCgiI3NlY3JldCIpLnZhbHVlIHx8ICIiKTsKICAgICAgY29uc3QgcHcgPSAoJCgiI3B3IikudmFsdWUgfHwgIiIpOwogICAgICBjb25zdCBpdGVycyA9IDUwMF8wMDA7CiAgICAgIGNvbnN0IG91dCA9ICQoIiN1cmwiKTsKICAgICAgY29uc3QgY29weVVybEJ0biA9ICQoIiNjb3B5LXVybCIpOwoKICAgICAgaWYgKCFwdykgeyBvdXQudGV4dENvbnRlbnQgPSAiUGxlYXNlIGVudGVyIGEgcGFzc3dvcmQuIjsgcmV0dXJuOyB9CgogICAgICBvdXQudGV4dENvbnRlbnQgPSAiRW5jcnlwdGluZy4uLiI7CiAgICAgIGNvcHlVcmxCdG4uc3R5bGUuZGlzcGxheSA9ICJub25lIjsKCiAgICAgIHRyeSB7CiAgICAgICAgY29uc3QgcGF5bG9hZCA9IGF3YWl0IGVuY3J5cHRTZWNyZXQoc2VjcmV0LCBwdywgaXRlcnMpOwogICAgICAgIGNvbnN0IGRlY29kZUhUTUwgPSBidWlsZERlY29kZUhUTUwoREVDT0RFX1RFTVBMQVRFLCBwYXlsb2FkLCBpdGVycyk7CiAgICAgICAgY29uc3QgdXJsID0gdG9EYXRhVVJMKGRlY29kZUhUTUwpOwogICAgICAgIG91dC50ZXh0Q29udGVudCA9IHVybDsKICAgICAgICBjb3B5VXJsQnRuLnN0eWxlLmRpc3BsYXkgPSAiaW5saW5lLWJsb2NrIjsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgb3V0LnRleHRDb250ZW50ID0gYEVycm9yOiAke2Vyci5tZXNzYWdlfWA7CiAgICAgICAgY29weVVybEJ0bi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwogICAgICB9CiAgICB9KTsKICA8L3NjcmlwdD4KPC9ib2R5PgoKPC9odG1sPg==
```
Key Exchange tool:
```url
data:text/html;base64,PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsaW5pdGlhbC1zY2FsZT0xIiAvPgo8dGl0bGU+Q2lwaGVyTGluayAtIEtleSBFeGNoYW5nZTwvdGl0bGU+CjxzdHlsZT4KICBib2R5IHsKICAgIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIFNlZ29lIFVJLCBSb2JvdG8sIEFyaWFsLCBzYW5zLXNlcmlmOwogICAgbWFyZ2luOiAycmVtOwogICAgbGluZS1oZWlnaHQ6IDEuNAogIH0KCiAgdGV4dGFyZWEgewogICAgd2lkdGg6IDEwMCU7CiAgICBtaW4taGVpZ2h0OiA4cmVtCiAgfQoKICBpbnB1dCwKICBidXR0b24sCiAgdGV4dGFyZWEgewogICAgZm9udDogaW5oZXJpdDsKICAgIHBhZGRpbmc6IC41cmVtOwogICAgYm9yZGVyOiAxcHggc29saWQgI2NjYzsKICAgIGJvcmRlci1yYWRpdXM6IC40cmVtCiAgfQoKICBidXR0b24gewogICAgY3Vyc29yOiBwb2ludGVyCiAgfQoKICAucm93IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IC41cmVtOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbjogLjVyZW0gMAogIH0KCiAgLm91dCB7CiAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgICBib3JkZXI6IDFweCBkYXNoZWQgI2RkZDsKICAgIHBhZGRpbmc6IDFyZW07CiAgICBib3JkZXItcmFkaXVzOiAuNXJlbTsKICAgIGJhY2tncm91bmQ6ICNmYWZhZmE7CiAgICB3b3JkLWJyZWFrOiBicmVhay1hbGwKICB9CgogIC51cmwtb3V0cHV0IHsKICAgIG1heC1oZWlnaHQ6IDUuNGVtOwogICAgb3ZlcmZsb3cteTogYXV0bzsKICB9CgogIC5oaWRkZW4gewogICAgZGlzcGxheTogbm9uZTsKICB9CgogIC53YXJuIHsKICAgIGNvbG9yOiByZWQ7CiAgICBmb250LXdlaWdodDogYm9sZDsKICB9CgogIC5zdGVwIHsKICAgIG1hcmdpbjogMXJlbSAwOwogICAgcGFkZGluZzogMXJlbTsKICAgIGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7CiAgICBib3JkZXItcmFkaXVzOiAuNXJlbTsKICAgIGJhY2tncm91bmQ6ICNmOWY5Zjk7CiAgfQoKICAuc3RlcCBoMyB7CiAgICBtYXJnaW4tdG9wOiAwOwogIH0KPC9zdHlsZT4KCjxib2R5PgogIDxoMT5DaXBoZXJMaW5rIC0gS2V5IEV4Y2hhbmdlPC9oMT4KICA8cD5TZW5kIHNlY3JldHMgc2VjdXJlbHkgdXNpbmcgWDI1NTE5IGtleSBleGNoYW5nZSArIEFFUy1HQ00gZW5jcnlwdGlvbi48L3A+CiAgPHA+CiAgICA8c3Ryb25nPldhcm5pbmc6PC9zdHJvbmc+IFVzZSB0aGlzIHRvb2wgYXQgeW91ciBvd24gcmlzay4gQWx3YXlzIGVuc3VyZSB5b3UgZ290IHRoZSBsaW5rIGZyb20KICAgIDxhIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9oaWxsYWMvQ2lwaGVyTGluayI+aHR0cHM6Ly9naXRodWIuY29tL2hpbGxhYy9DaXBoZXJMaW5rPC9hPiBhbmQgdmV0IHRoZSBjb2RlIHlvdXJzZWxmLgogIDwvcD4KCiAgPCEtLSBTdGVwIDE6IEluaXRpYWwgbWVzc2FnZSBlbmNyeXB0aW9uIC0tPgogIDxkaXYgaWQ9InN0ZXAxIiBjbGFzcz0ic3RlcCI+CiAgICA8aDM+U3RlcCAxOiBFbnRlciB5b3VyIHNlY3JldCBtZXNzYWdlPC9oMz4KICAgIDxsYWJlbD5TZWNyZXQ8L2xhYmVsPgogICAgPHRleHRhcmVhIGlkPSJzZWNyZXQiIHBsYWNlaG9sZGVyPSJUeXBlIHlvdXIgc2VjcmV0IGhlcmUuLi4iPjwvdGV4dGFyZWE+CiAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICA8YnV0dG9uIGlkPSJlbmNyeXB0LWJ0biI+RW5jcnlwdCAmIEdlbmVyYXRlIEV4Y2hhbmdlIExpbms8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBpZD0ic2hvdy1zZWNyZXQtYnRuIiBjbGFzcz0iaGlkZGVuIj5TaG93IFNlY3JldDwvYnV0dG9uPgogICAgPC9kaXY+CiAgICA8ZGl2IGlkPSJ1cmwtb3V0cHV0IiBjbGFzcz0iaGlkZGVuIj4KICAgICAgPGg0PlNlbmQgdGhpcyBsaW5rIHRvIHRoZSByZWNpcGllbnQ6PC9oND4KICAgICAgPHA+V2FybmluZywgaXQncyBhIHZlcnkgbG9uZyBsaW5rITwvcD4KICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICA8YnV0dG9uIGlkPSJjb3B5LXVybCIgY2xhc3M9ImNvcHktYnRuIj5Db3B5IEV4Y2hhbmdlIExpbms8L2J1dHRvbj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXYgaWQ9InVybCIgY2xhc3M9Im91dCB1cmwtb3V0cHV0Ij48L2Rpdj4KICAgIDwvZGl2PgogIDwvZGl2PgoKICA8IS0tIFN0ZXAgMjogV2FpdCBmb3IgcmVjaXBpZW50J3MgcHVibGljIGtleSAtLT4KICA8ZGl2IGlkPSJzdGVwMiIgY2xhc3M9InN0ZXAgaGlkZGVuIj4KICAgIDxoMz5TdGVwIDI6IEVudGVyIHJlY2lwaWVudCdzIHB1YmxpYyBrZXk8L2gzPgogICAgPHA+VGhlIHJlY2lwaWVudCB3aWxsIHNlbmQgeW91IHRoZWlyIHB1YmxpYyBrZXkuPGJyIC8+CiAgICAgIDxiIGNsYXNzPSJ3YXJuIj5JbXBvcnRhbnQgV2FybmluZyEgUmVhZCB0aGlzIGZpcnN0PC9iPjxici8+CiAgICAgIE1ha2Ugc3VyZSB0aGV5IHNlbmQgaXQgb3ZlciBhIGRpZmZlcmVudCBjaGFubmVsIHRoYW4gdGhlIG9uZSB5b3Ugb3JpZ2luYWxseSBzZW50IHRoZQogICAgICBsaW5rIG9uIQogICAgICBFZywgaWYgeW91IHNlbnQgdGhlIGxpbmsgb24gZW1haWwsIGFzayB0aGVtIHRvIHNlbmQgdGhlaXIgcHVibGljIGtleSBvbiB3aGF0c2FwcC48YnIgLz4KICAgICAgSWdub3JlIGFueSBkYXRhIHRoZXkgc2VuZCBvbiB0aGUgb3JpZ2luYWwgY2hhbm5lbCBhbmQgcmVxdWVzdCB0aGV5IHVzZSBhIGRpZmZlcmVudCBjaGFubmVsLjxiciAvPgogICAgICBQYXN0ZSBpdCBiZWxvdzoKICAgIDwvcD4KICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgIDxsYWJlbCBmb3I9InJlY2lwaWVudC1wdWJrZXkiPlJlY2lwaWVudCdzIERhdGE6PC9sYWJlbD4KICAgICAgPGlucHV0IGlkPSJyZWNpcGllbnQtcHVia2V5IiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0iUGFzdGUgcmVjaXBpZW50J3MgcHVibGljIGtleSBoZXJlIiAvPgogICAgICA8YnV0dG9uIGlkPSJnZW5lcmF0ZS1lbmNyeXB0ZWQta2V5Ij5HZW5lcmF0ZSBFbmNyeXB0ZWQgS2V5PC9idXR0b24+CiAgICA8L2Rpdj4KICAgIDxkaXYgaWQ9ImVuY3J5cHRlZC1rZXktb3V0cHV0IiBjbGFzcz0iaGlkZGVuIj4KICAgICAgPGg0PlNlbmQgdGhpcyBlbmNyeXB0ZWQga2V5IGJhY2sgdG8gdGhlIHJlY2lwaWVudCBvbiB0aGUgc2FtZSBjaGFubmVsIHRoZXkgc2VudCB0aGVpciBkYXRhOjwvaDQ+CiAgICAgIDxkaXYgY2xhc3M9InJvdyI+CiAgICAgICAgPGJ1dHRvbiBpZD0iY29weS1lbmNyeXB0ZWQta2V5IiBjbGFzcz0iY29weS1idG4iPkNvcHkgRW5jcnlwdGVkIEtleTwvYnV0dG9uPgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBpZD0iZW5jcnlwdGVkLWtleSIgY2xhc3M9Im91dCI+PC9kaXY+CiAgICA8L2Rpdj4KICA8L2Rpdj4KCiAgPHRlbXBsYXRlIGlkPSJkZWNvZGUtdGVtcGxhdGUiPgogICAgPCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsaW5pdGlhbC1zY2FsZT0xIiAvPgo8dGl0bGU+Q2lwaGVyTGluayAtIFJlY2VpdmUgU2VjcmV0PC90aXRsZT4KPHN0eWxlPgogICAgYm9keSB7CiAgICAgICAgZm9udC1mYW1pbHk6IHN5c3RlbS11aSwgU2Vnb2UgVUksIFJvYm90bywgQXJpYWwsIHNhbnMtc2VyaWY7CiAgICAgICAgbWFyZ2luOiAycmVtOwogICAgICAgIGxpbmUtaGVpZ2h0OiAxLjQKICAgIH0KCiAgICB0ZXh0YXJlYSB7CiAgICAgICAgd2lkdGg6IDEwMCU7CiAgICAgICAgbWluLWhlaWdodDogOHJlbQogICAgfQoKICAgIGlucHV0LAogICAgYnV0dG9uLAogICAgdGV4dGFyZWEgewogICAgICAgIGZvbnQ6IGluaGVyaXQ7CiAgICAgICAgcGFkZGluZzogLjVyZW07CiAgICAgICAgYm9yZGVyOiAxcHggc29saWQgI2NjYzsKICAgICAgICBib3JkZXItcmFkaXVzOiAuNHJlbQogICAgfQoKICAgIGJ1dHRvbiB7CiAgICAgICAgY3Vyc29yOiBwb2ludGVyCiAgICB9CgogICAgLnJvdyB7CiAgICAgICAgZGlzcGxheTogZmxleDsKICAgICAgICBnYXA6IC41cmVtOwogICAgICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICAgICAgbWFyZ2luOiAuNXJlbSAwCiAgICB9CgogICAgLm91dCB7CiAgICAgICAgd2hpdGUtc3BhY2U6IHByZS13cmFwOwogICAgICAgIGJvcmRlcjogMXB4IGRhc2hlZCAjZGRkOwogICAgICAgIHBhZGRpbmc6IDFyZW07CiAgICAgICAgYm9yZGVyLXJhZGl1czogLjVyZW07CiAgICAgICAgYmFja2dyb3VuZDogI2ZhZmFmYTsKICAgICAgICB3b3JkLWJyZWFrOiBicmVhay1hbGwKICAgIH0KCiAgICAuaGlkZGVuIHsKICAgICAgICBkaXNwbGF5OiBub25lOwogICAgfQoKICAgIC5zdGVwIHsKICAgICAgICBtYXJnaW46IDFyZW0gMDsKICAgICAgICBwYWRkaW5nOiAxcmVtOwogICAgICAgIGJvcmRlcjogMXB4IHNvbGlkICNkZGQ7CiAgICAgICAgYm9yZGVyLXJhZGl1czogLjVyZW07CiAgICAgICAgYmFja2dyb3VuZDogI2Y5ZjlmOTsKICAgIH0KCiAgICAud2FybiB7CiAgICAgICAgY29sb3I6IHJlZDsKICAgICAgICBmb250LXdlaWdodDogYm9sZDsKICAgIH0KCiAgICAuc3RlcCBoMyB7CiAgICAgICAgbWFyZ2luLXRvcDogMDsKICAgIH0KCiAgICAuc3VjY2VzcyB7CiAgICAgICAgYmFja2dyb3VuZDogI2U4ZjVlODsKICAgICAgICBib3JkZXItY29sb3I6ICM0Y2FmNTA7CiAgICB9Cjwvc3R5bGU+Cgo8Ym9keT4KICAgIDxoMT5DaXBoZXJMaW5rIC0gUmVjZWl2ZSBTZWNyZXQ8L2gxPgogICAgPHA+WW91J3ZlIHJlY2VpdmVkIGFuIGVuY3J5cHRlZCBtZXNzYWdlLiBGb2xsb3cgdGhlIHN0ZXBzIGJlbG93IHRvIGRlY3J5cHQgaXQgc2VjdXJlbHkuPC9wPgoKICAgIDwhLS0gU3RlcCAxOiBHZW5lcmF0ZSBhbmQgc2hhcmUgcHVibGljIGtleSAtLT4KICAgIDxkaXYgaWQ9InN0ZXAxIiBjbGFzcz0ic3RlcCI+CiAgICAgICAgPGgzPlN0ZXAgMTogR2VuZXJhdGUgeW91ciBwdWJsaWMga2V5PC9oMz4KICAgICAgICA8cD5DbGljayB0aGUgYnV0dG9uIGJlbG93IHRvIGdlbmVyYXRlIHlvdXIgcHVibGljIGtleSwgdGhlbiBzZW5kIGl0IGJhY2sgdG8gdGhlIHNlbmRlci48YnIgLz4KICAgICAgICAgICAgPGIgY2xhc3M9Indhcm4iPkltcG9ydGFudCBXYXJuaW5nISBSZWFkIFRoaXMgZmlyc3Q8L2I+PGJyIC8+CiAgICAgICAgICAgIE1ha2Ugc3VyZSB5b3Ugc2VuZCBpdCBvdmVyIGEgZGlmZmVyZW50IGNoYW5uZWwgdGhhbiB0aGUgb25lIHlvdSByZWNlaXZlZCB0aGUgbGluayBvbiE8YnIgLz4KICAgICAgICAgICAgRWcsIGlmIHlvdSByZWNlaXZlZCB0aGUgbGluayBvbiBlbWFpbCwgc2VuZCB0aGlzIGRhdGEgb24gd2hhdHNhcHAuPGJyIC8+CiAgICAgICAgPC9wPgogICAgICAgIDxidXR0b24gaWQ9ImdlbmVyYXRlLWtleXBhaXIiPkdlbmVyYXRlIE15IFB1YmxpYyBLZXk8L2J1dHRvbj4KCiAgICAgICAgPGRpdiBpZD0icHVia2V5LW91dHB1dCIgY2xhc3M9ImhpZGRlbiI+CiAgICAgICAgICAgIDxoND5TZW5kIHRoaXMgcHVibGljIGtleSBiYWNrIHRvIHRoZSBzZW5kZXI6PC9oND4KICAgICAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICAgICAgICAgIDxidXR0b24gaWQ9ImNvcHktcHVia2V5IiBjbGFzcz0iY29weS1idG4iPkNvcHkgTXkgUHVibGljIEtleTwvYnV0dG9uPgogICAgICAgICAgICA8L2Rpdj4KICAgICAgICAgICAgPGRpdiBpZD0ibXktcHVia2V5IiBjbGFzcz0ib3V0Ij48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgIDwvZGl2PgoKICAgIDwhLS0gU3RlcCAyOiBSZWNlaXZlIGVuY3J5cHRlZCBrZXkgLS0+CiAgICA8ZGl2IGlkPSJzdGVwMiIgY2xhc3M9InN0ZXAgaGlkZGVuIj4KICAgICAgICA8aDM+U3RlcCAyOiBFbnRlciB0aGUgZW5jcnlwdGVkIGtleTwvaDM+CiAgICAgICAgPHA+VGhlIHNlbmRlciB3aWxsIHNlbmQgeW91IGFuIGVuY3J5cHRlZCBrZXkuIFBhc3RlIGl0IGJlbG93OjwvcD4KICAgICAgICA8ZGl2IGNsYXNzPSJyb3ciPgogICAgICAgICAgICA8bGFiZWwgZm9yPSJlbmNyeXB0ZWQta2V5LWlucHV0Ij5FbmNyeXB0ZWQgS2V5OjwvbGFiZWw+CiAgICAgICAgICAgIDxpbnB1dCBpZD0iZW5jcnlwdGVkLWtleS1pbnB1dCIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9IlBhc3RlIGVuY3J5cHRlZCBrZXkgaGVyZSIgLz4KICAgICAgICAgICAgPGJ1dHRvbiBpZD0iZGVjcnlwdC1tZXNzYWdlIj5EZWNyeXB0IE1lc3NhZ2U8L2J1dHRvbj4KICAgICAgICA8L2Rpdj4KICAgIDwvZGl2PgoKICAgIDwhLS0gU3RlcCAzOiBTaG93IGRlY3J5cHRlZCBtZXNzYWdlIC0tPgogICAgPGRpdiBpZD0ic3RlcDMiIGNsYXNzPSJzdGVwIGhpZGRlbiBzdWNjZXNzIj4KICAgICAgICA8aDM+U3RlcCAzOiBZb3VyIGRlY3J5cHRlZCBtZXNzYWdlPC9oMz4KICAgICAgICA8cD5JZiB5b3Ugd2FudCB0byB1c2UgdGhpcyB0b29sIHRvIHNlbmQgc2VjcmV0cyB5b3Vyc2VsZiwgZ28gdG8gPGEKICAgICAgICAgICAgICAgIGhyZWY9Imh0dHBzOi8vZ2l0aHViLmNvbS9oaWxsYWMvQ2lwaGVyTGluayI+aHR0cHM6Ly9naXRodWIuY29tL2hpbGxhYy9DaXBoZXJMaW5rPC9hPjwvcD4KICAgICAgICA8ZGl2IGlkPSJkZWNyeXB0ZWQtbWVzc2FnZSIgY2xhc3M9Im91dCI+PC9kaXY+CiAgICA8L2Rpdj4KCiAgICA8c2NyaXB0IHR5cGU9Im1vZHVsZS1zb3VyY2UiIGlkPSJhZXMyNTZnY20tc2NyaXB0Ij4KICAgICAgICBfX0lOQ0xVREVfQUVTMjU2R0NNX0pTXzJfXwogICAgPC9zY3JpcHQ+CgogICAgPHNjcmlwdCB0eXBlPSJtb2R1bGUtc291cmNlIiBpZD0iaG1hYy1zY3JpcHQiPgogICAgICAgIF9fSU5DTFVERV9ITUFDX0pTXzJfXwogICAgPC9zY3JpcHQ+CgogICAgPHNjcmlwdCB0eXBlPSJtb2R1bGUtc291cmNlIiBpZD0iaGtkZi1zY3JpcHQiPgogICAgICAgIF9fSU5DTFVERV9IS0RGX0pTXzJfXwogICAgPC9zY3JpcHQ+CgogICAgPHNjcmlwdCB0eXBlPSJtb2R1bGUtc291cmNlIiBpZD0ieDI1NTE5LXNjcmlwdCI+CiAgICAgICAgX19JTkNMVURFX1gyNTUxOV9KU18yX18KICAgIDwvc2NyaXB0PgoKICAgIDxzY3JpcHQgdHlwZT0ibW9kdWxlIj4KICAgICAgICBjb25zdCAkID0gKHMpID0+IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iocyk7CgogICAgICAgIGFzeW5jIGZ1bmN0aW9uIGxvYWRJbmxpbmVNb2R1bGUoaWQpIHsKICAgICAgICAgICAgY29uc3QgY29kZSA9ICQoJyMnICsgaWQpLnRleHRDb250ZW50OwogICAgICAgICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFtjb2RlXSwgeyB0eXBlOiAndGV4dC9qYXZhc2NyaXB0JyB9KSk7CiAgICAgICAgICAgIHJldHVybiB7IG1vZHVsZTogYXdhaXQgaW1wb3J0KHVybCksIGNvZGUgfTsKICAgICAgICB9CgogICAgICAgIGNvbnN0IGFlczI1NmdjbSA9IGF3YWl0IGxvYWRJbmxpbmVNb2R1bGUoJ2FlczI1NmdjbS1zY3JpcHQnKTsKICAgICAgICBjb25zdCBobWFjID0gYXdhaXQgbG9hZElubGluZU1vZHVsZSgnaG1hYy1zY3JpcHQnKTsKICAgICAgICBjb25zdCBoa2RmID0gYXdhaXQgbG9hZElubGluZU1vZHVsZSgnaGtkZi1zY3JpcHQnKTsKICAgICAgICBjb25zdCB4MjU1MTkgPSBhd2FpdCBsb2FkSW5saW5lTW9kdWxlKCd4MjU1MTktc2NyaXB0Jyk7CgogICAgICAgIC8vIEVtYmVkZGVkIGRhdGEKICAgICAgICBjb25zdCBDSVBIRVJURVhUX0I2NCA9ICJfX0NJUEhFUlRFWFRfQjY0X18iOwogICAgICAgIGNvbnN0IElWX0I2NCA9ICJfX0lWX0I2NF9fIjsKICAgICAgICBjb25zdCBUQUdfQjY0ID0gIl9fVEFHX0I2NF9fIjsKICAgICAgICBjb25zdCBQVUJBX0I2NCA9ICJfX1BVQkFfQjY0X18iOwogICAgICAgIGNvbnN0IFNBTFRfQjY0ID0gIl9fU0FMVF9CNjRfXyI7CgogICAgICAgIC8vIEdsb2JhbCBzdGF0ZQogICAgICAgIGxldCBteVByaXZhdGVLZXkgPSBudWxsOwogICAgICAgIGxldCBteVB1YmxpY0tleSA9IG51bGw7CiAgICAgICAgbGV0IHNoYXJlZEtleSA9IG51bGw7CgogICAgICAgIC8vIC0tLSBoZWxwZXJzIC0tLQogICAgICAgIGNvbnN0IGVuYyA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgICAgIGNvbnN0IGRlYyA9IG5ldyBUZXh0RGVjb2RlcigpOwogICAgICAgIGNvbnN0IGI2NCA9IChidWYpID0+IGJ0b2EoU3RyaW5nLmZyb21DaGFyQ29kZSguLi5uZXcgVWludDhBcnJheShidWYpKSk7CiAgICAgICAgY29uc3QgdW5iNjQgPSAoc3RyKSA9PiBuZXcgVWludDhBcnJheShbLi4uYXRvYihzdHIpXS5tYXAoYyA9PiBjLmNoYXJDb2RlQXQoMCkpKTsKCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gY29weVRvQ2xpcGJvYXJkKHRleHQsIGJ1dHRvbikgewogICAgICAgICAgICBjb25zdCBvcmlnaW5hbFRleHQgPSBidXR0b24udGV4dENvbnRlbnQ7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh0ZXh0KTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBjb25zdCB0ZXh0YXJlYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3RleHRhcmVhJyk7CiAgICAgICAgICAgICAgICB0ZXh0YXJlYS52YWx1ZSA9IHRleHQ7CiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRhcmVhKTsKICAgICAgICAgICAgICAgIHRleHRhcmVhLnNlbGVjdCgpOwogICAgICAgICAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICAgICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGV4dGFyZWEpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJ1dHRvbi50ZXh0Q29udGVudCA9ICJDb3BpZWQhIjsKICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgICAgICAgICBidXR0b24udGV4dENvbnRlbnQgPSBvcmlnaW5hbFRleHQ7CiAgICAgICAgICAgIH0sIDIwMDApOwogICAgICAgIH0KCiAgICAgICAgLy8gRXZlbnQgbGlzdGVuZXJzCiAgICAgICAgJCgiI2dlbmVyYXRlLWtleXBhaXIiKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIC8vIEdlbmVyYXRlIFgyNTUxOSBrZXlwYWlyCiAgICAgICAgICAgICAgICBjb25zdCBrZXlwYWlyID0geDI1NTE5Lm1vZHVsZS5nZW5lcmF0ZUtleVBhaXIoKTsKICAgICAgICAgICAgICAgIG15UHJpdmF0ZUtleSA9IGtleXBhaXIuc2VjcmV0S2V5OwogICAgICAgICAgICAgICAgbXlQdWJsaWNLZXkgPSBrZXlwYWlyLnB1YmxpY0tleTsKCiAgICAgICAgICAgICAgICAvLyBHZW5lcmF0ZSBzaGFyZWQgc2VjcmV0IGltbWVkaWF0ZWx5IGFuZCBkZXJpdmUga2V5CiAgICAgICAgICAgICAgICBjb25zdCBzZW5kZXJQdWJLZXkgPSB1bmI2NChQVUJBX0I2NCk7CiAgICAgICAgICAgICAgICBjb25zdCBzaGFyZWRTZWNyZXQgPSB4MjU1MTkubW9kdWxlLnNoYXJlZEtleShteVByaXZhdGVLZXksIHNlbmRlclB1YktleSk7CiAgICAgICAgICAgICAgICBzaGFyZWRLZXkgPSBoa2RmLm1vZHVsZS5oa2RmKAogICAgICAgICAgICAgICAgICAgIHNoYXJlZFNlY3JldCwKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNhbHQ6IHVuYjY0KFNBTFRfQjY0KSwKICAgICAgICAgICAgICAgICAgICAgICAgaW5mbzogZW5jLmVuY29kZSgiQ2lwaGVyTGluay1LZXlEZXJpdmF0aW9uIiksCiAgICAgICAgICAgICAgICAgICAgICAgIGxlbmd0aDogMzIKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIGhtYWMubW9kdWxlLm1ha2VIbWFjU2hhMjU2Rm4KICAgICAgICAgICAgICAgICk7CgogICAgICAgICAgICAgICAgLy8gU2hvdyBwdWJsaWMga2V5IHRvIHVzZXIKICAgICAgICAgICAgICAgICQoIiNteS1wdWJrZXkiKS50ZXh0Q29udGVudCA9IGI2NChteVB1YmxpY0tleSk7CiAgICAgICAgICAgICAgICAkKCIjcHVia2V5LW91dHB1dCIpLmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwogICAgICAgICAgICAgICAgJCgiI3N0ZXAyIikuY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7CiAgICAgICAgICAgICAgICAkKCIjZ2VuZXJhdGUta2V5cGFpciIpLmRpc2FibGVkID0gdHJ1ZTsKCiAgICAgICAgICAgICAgICAvLyBDbGVhbiB1cCBzaGFyZWQgc2VjcmV0IChrZWVwIHNoYXJlZEtleSBmb3IgbGF0ZXIpCiAgICAgICAgICAgICAgICBzaGFyZWRTZWNyZXQuZmlsbCgwKTsKICAgICAgICAgICAgICAgIG15UHJpdmF0ZUtleS5maWxsKDApOwogICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICAgICAgICAgIGFsZXJ0KGBFcnJvcjogJHtlcnIubWVzc2FnZX1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwoKICAgICAgICAkKCIjY29weS1wdWJrZXkiKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgICAgICAgY29uc3QgcHVia2V5ID0gJCgiI215LXB1YmtleSIpLnRleHRDb250ZW50OwogICAgICAgICAgICBpZiAocHVia2V5KSBjb3B5VG9DbGlwYm9hcmQocHVia2V5LCAkKCIjY29weS1wdWJrZXkiKSk7CiAgICAgICAgfSk7CgogICAgICAgICQoIiNkZWNyeXB0LW1lc3NhZ2UiKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGFzeW5jICgpID0+IHsKICAgICAgICAgICAgY29uc3QgZW5jcnlwdGVkS2V5SW5wdXQgPSAkKCIjZW5jcnlwdGVkLWtleS1pbnB1dCIpLnZhbHVlLnRyaW0oKTsKICAgICAgICAgICAgaWYgKCFlbmNyeXB0ZWRLZXlJbnB1dCkgewogICAgICAgICAgICAgICAgYWxlcnQoIlBsZWFzZSBlbnRlciB0aGUgZW5jcnlwdGVkIGtleS4iKTsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIC8vIFBhcnNlIGVuY3J5cHRlZCBrZXkgZGF0YQogICAgICAgICAgICAgICAgY29uc3QgZW5jcnlwdGVkS2V5RGF0YSA9IEpTT04ucGFyc2UoZW5jcnlwdGVkS2V5SW5wdXQpOwogICAgICAgICAgICAgICAgY29uc3QgeyBjdCwgaXYsIHRhZyB9ID0gZW5jcnlwdGVkS2V5RGF0YTsKCiAgICAgICAgICAgICAgICAvLyBEZWNyeXB0IHRoZSBtZXNzYWdlIGtleQogICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZUtleSA9IGFlczI1NmdjbS5tb2R1bGUuYWVzMjU2R2NtRGVjcnlwdCh7CiAgICAgICAgICAgICAgICAgICAga2V5OiBzaGFyZWRLZXksCiAgICAgICAgICAgICAgICAgICAgaXY6IHVuYjY0KGl2KSwKICAgICAgICAgICAgICAgICAgICBjaXBoZXJ0ZXh0OiB1bmI2NChjdCksCiAgICAgICAgICAgICAgICAgICAgdGFnOiB1bmI2NCh0YWcpCiAgICAgICAgICAgICAgICB9KTsKCiAgICAgICAgICAgICAgICBpZiAoIW1lc3NhZ2VLZXkub2sgfHwgbWVzc2FnZUtleS5wbGFpbnRleHQubGVuZ3RoICE9PSAzMikgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiRGVjcnlwdGlvbiBvZiBtZXNzYWdlIGtleSBmYWlsZWQiKTsKICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAvLyBEZWNyeXB0IHRoZSBhY3R1YWwgbWVzc2FnZQogICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IGFlczI1NmdjbS5tb2R1bGUuYWVzMjU2R2NtRGVjcnlwdCh7CiAgICAgICAgICAgICAgICAgICAga2V5OiBtZXNzYWdlS2V5LnBsYWludGV4dCwKICAgICAgICAgICAgICAgICAgICBpdjogdW5iNjQoSVZfQjY0KSwKICAgICAgICAgICAgICAgICAgICBjaXBoZXJ0ZXh0OiB1bmI2NChDSVBIRVJURVhUX0I2NCksCiAgICAgICAgICAgICAgICAgICAgdGFnOiB1bmI2NChUQUdfQjY0KQogICAgICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAgICAgaWYgKCFtZXNzYWdlLm9rKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJEZWNyeXB0aW9uIG9mIG1lc3NhZ2UgZmFpbGVkIik7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgLy8gU2hvdyBkZWNyeXB0ZWQgbWVzc2FnZQogICAgICAgICAgICAgICAgJCgiI2RlY3J5cHRlZC1tZXNzYWdlIikudGV4dENvbnRlbnQgPSBkZWMuZGVjb2RlKG1lc3NhZ2UucGxhaW50ZXh0KTsKICAgICAgICAgICAgICAgICQoIiNzdGVwMyIpLmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwoKICAgICAgICAgICAgICAgIC8vIENsZWFuIHVwIHNlbnNpdGl2ZSBkYXRhCiAgICAgICAgICAgICAgICBtZXNzYWdlS2V5LnBsYWludGV4dC5maWxsKDApOwogICAgICAgICAgICAgICAgc2hhcmVkS2V5LmZpbGwoMCk7CiAgICAgICAgICAgICAgICBteVByaXZhdGVLZXkuZmlsbCgwKTsKICAgICAgICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgICAgICAgICBhbGVydChgRXJyb3IgZGVjcnlwdGluZyBtZXNzYWdlOiAke2Vyci5tZXNzYWdlfWApOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CgogICAgPC9zY3JpcHQ+CjwvYm9keT4KCjwvaHRtbD4KICA8L3RlbXBsYXRlPgoKICA8c2NyaXB0IHR5cGU9Im1vZHVsZS1zb3VyY2UiIGlkPSJhZXMyNTZnY20tc2NyaXB0Ij4KICAgIAoKY29uc3QgUiA9IDB4ZTEwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDBuOyAKCmZ1bmN0aW9uIHRvVTgodikgewogIHJldHVybiB2IGluc3RhbmNlb2YgVWludDhBcnJheSA/IHYgOiBuZXcgVWludDhBcnJheSh2KTsKfQpmdW5jdGlvbiB4b3JCeXRlcyhhLCBiKSB7CiAgY29uc3Qgb3V0ID0gbmV3IFVpbnQ4QXJyYXkoYS5sZW5ndGgpOwogIGZvciAobGV0IGkgPSAwOyBpIDwgYS5sZW5ndGg7IGkrKykgb3V0W2ldID0gYVtpXSBeIGJbaV07CiAgcmV0dXJuIG91dDsKfQpmdW5jdGlvbiB6ZXJvKG4pIHsKICByZXR1cm4gbmV3IFVpbnQ4QXJyYXkobik7Cn0KCmZ1bmN0aW9uIGJ5dGVzVG9CaWdJbnRCRShiKSB7CiAgbGV0IHggPSAwbjsKICBmb3IgKGxldCBpID0gMDsgaSA8IGIubGVuZ3RoOyBpKyspIHggPSAoeCA8PCA4bikgfCBCaWdJbnQoYltpXSk7CiAgcmV0dXJuIHg7Cn0KZnVuY3Rpb24gYmlnSW50VG9CeXRlc0JFKHgsIGxlbikgewogIGNvbnN0IG91dCA9IG5ldyBVaW50OEFycmF5KGxlbik7CiAgZm9yIChsZXQgaSA9IGxlbiAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICBvdXRbaV0gPSBOdW1iZXIoeCAmIDB4ZmZuKTsKICAgIHggPj49IDhuOwogIH0KICByZXR1cm4gb3V0Owp9Cgpjb25zdCBiNjRUb1U4ID0gKGI2NCkgPT4gVWludDhBcnJheS5mcm9tKGF0b2IoYjY0KSwgKGMpID0+IGMuY2hhckNvZGVBdCgwKSk7Cgpjb25zdCBTID0gYjY0VG9VOCgKICAiWTN4M2UvSnJiOFV3QVdjci90ZXJkc3FDeVgzNldVZndyZFNpcjV5a2NzQzMvWk1tTmovM3pEU2w1ZkZ4MkRFVkJNY2p3eGlXQlpvSEVvRGk2eWV5ZFFtRExCb2JibHFnVWp2V3N5bmpMNFJUMFFEdElQeXhXMnJMdmpsS1RGalAwTytxKzBOTk00VkYrUUovVUR5ZnFGR2pRSStTblRqMXZMYmFJUkQvODlMTkRCUHNYNWRFRjhTbmZqMWtYUmx6WUlGUDNDSXFrSWhHN3JnVTNsNEwyK0F5T2dwSkJpUmN3dE9zWXBHVjVIbm55RGR0amRWT3FXeFc5T3BsZXE0SXVuZ2xMaHltdE1ibzNYUWZTNzJMaW5BK3RXWklBL1lPWVRWWHVZYkJIWjdoK0pnUmFkbU9sSnNlaCtuT1ZTamZqS0dKRGIvbVFtaEJtUzBQc0ZTN0ZnPT0iCik7CmNvbnN0IFJjb24gPSBiNjRUb1U4KCJBQUVDQkFnUUlFQ0FHelpzMkt0Tm1nPT0iKTsKCmZ1bmN0aW9uIHJvdFdvcmQodykgewogIHJldHVybiBbd1sxXSwgd1syXSwgd1szXSwgd1swXV07Cn0KZnVuY3Rpb24gc3ViV29yZCh3KSB7CiAgcmV0dXJuIHcubWFwKCh4KSA9PiBTW3hdKTsKfQoKZnVuY3Rpb24ga2V5RXhwYW5kMjU2KGtleSkgewogIGtleSA9IHRvVTgoa2V5KTsKICBpZiAoa2V5Lmxlbmd0aCAhPT0gMzIpIHRocm93IG5ldyBFcnJvcigiQUVTLTI1NiBrZXkgbXVzdCBiZSAzMiBieXRlcyIpOwoKICBjb25zdCBOayA9IDgsCiAgICBOYiA9IDQsCiAgICBOciA9IDE0OwogIGNvbnN0IHcgPSBuZXcgVWludDhBcnJheShOYiAqIChOciArIDEpICogNCk7CiAgdy5zZXQoa2V5KTsKICBjb25zdCB0ZW1wID0gWzAsIDAsIDAsIDBdOwogIGxldCBieXRlc0dlbmVyYXRlZCA9IDMyOwogIGxldCByY29uSXRlciA9IDE7CgogIHdoaWxlIChieXRlc0dlbmVyYXRlZCA8IHcubGVuZ3RoKSB7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgdGVtcFtpXSA9IHdbYnl0ZXNHZW5lcmF0ZWQgLSA0ICsgaV07CiAgICBpZiAoKGJ5dGVzR2VuZXJhdGVkIC8gNCkgJSBOayA9PT0gMCkgewogICAgICBsZXQgdCA9IHJvdFdvcmQodGVtcCk7CiAgICAgIHQgPSBzdWJXb3JkKHQpOwogICAgICB0WzBdIF49IFJjb25bcmNvbkl0ZXIrK107CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB0ZW1wW2ldID0gdFtpXTsKICAgIH0gZWxzZSBpZiAoKGJ5dGVzR2VuZXJhdGVkIC8gNCkgJSBOayA9PT0gNCkgewogICAgICBsZXQgdCA9IHN1YldvcmQodGVtcCk7CiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB0ZW1wW2ldID0gdFtpXTsKICAgIH0KICAgIGZvciAobGV0IGkgPSAwOyBpIDwgNDsgaSsrKSB7CiAgICAgIHdbYnl0ZXNHZW5lcmF0ZWRdID0gd1tieXRlc0dlbmVyYXRlZCAtIDMyXSBeIHRlbXBbaV07CiAgICAgIGJ5dGVzR2VuZXJhdGVkKys7CiAgICB9CiAgfQogIHJldHVybiB3OyAKfQoKZnVuY3Rpb24gYWRkUm91bmRLZXkocywgcmssIHJvdW5kKSB7CiAgZm9yIChsZXQgYyA9IDA7IGMgPCA0OyBjKyspIHsKICAgIHNbMCArIDQgKiBjXSBePSBya1tyb3VuZCAqIDE2ICsgNCAqIGMgKyAwXTsKICAgIHNbMSArIDQgKiBjXSBePSBya1tyb3VuZCAqIDE2ICsgNCAqIGMgKyAxXTsKICAgIHNbMiArIDQgKiBjXSBePSBya1tyb3VuZCAqIDE2ICsgNCAqIGMgKyAyXTsKICAgIHNbMyArIDQgKiBjXSBePSBya1tyb3VuZCAqIDE2ICsgNCAqIGMgKyAzXTsKICB9Cn0KZnVuY3Rpb24gc3ViQnl0ZXMocykgewogIGZvciAobGV0IGkgPSAwOyBpIDwgMTY7IGkrKykgc1tpXSA9IFNbc1tpXV07Cn0KZnVuY3Rpb24gc2hpZnRSb3dzKHMpIHsKICBjb25zdCB0ID0gcy5zbGljZSgpOwogIHNbMV0gPSB0WzVdOwogIHNbNV0gPSB0WzldOwogIHNbOV0gPSB0WzEzXTsKICBzWzEzXSA9IHRbMV07CiAgc1syXSA9IHRbMTBdOwogIHNbNl0gPSB0WzE0XTsKICBzWzEwXSA9IHRbMl07CiAgc1sxNF0gPSB0WzZdOwogIHNbM10gPSB0WzE1XTsKICBzWzddID0gdFszXTsKICBzWzExXSA9IHRbN107CiAgc1sxNV0gPSB0WzExXTsKfQpmdW5jdGlvbiB4dGltZSh4KSB7CiAgcmV0dXJuICgoeCA8PCAxKSBeICh4ICYgMHg4MCA/IDB4MWIgOiAwKSkgJiAweGZmOwp9CmZ1bmN0aW9uIG1peENvbHVtbnMocykgewogIGZvciAobGV0IGMgPSAwOyBjIDwgNDsgYysrKSB7CiAgICBjb25zdCBpID0gNCAqIGM7CiAgICBjb25zdCBhMCA9IHNbaV0sCiAgICAgIGExID0gc1tpICsgMV0sCiAgICAgIGEyID0gc1tpICsgMl0sCiAgICAgIGEzID0gc1tpICsgM107CiAgICBjb25zdCByMCA9IHh0aW1lKGEwKSBeIChhMSBeIHh0aW1lKGExKSkgXiBhMiBeIGEzOwogICAgY29uc3QgcjEgPSBhMCBeIHh0aW1lKGExKSBeIChhMiBeIHh0aW1lKGEyKSkgXiBhMzsKICAgIGNvbnN0IHIyID0gYTAgXiBhMSBeIHh0aW1lKGEyKSBeIChhMyBeIHh0aW1lKGEzKSk7CiAgICBjb25zdCByMyA9IGEwIF4geHRpbWUoYTApIF4gYTEgXiBhMiBeIHh0aW1lKGEzKTsKICAgIHNbaV0gPSByMCAmIDB4ZmY7CiAgICBzW2kgKyAxXSA9IHIxICYgMHhmZjsKICAgIHNbaSArIDJdID0gcjIgJiAweGZmOwogICAgc1tpICsgM10gPSByMyAmIDB4ZmY7CiAgfQp9CmZ1bmN0aW9uIGFlc0VuY3J5cHRCbG9jayhyaywgYmxvY2sxNikgewogIGNvbnN0IE5yID0gMTQ7CiAgY29uc3QgcyA9IG5ldyBVaW50OEFycmF5KGJsb2NrMTYpOwogIGFkZFJvdW5kS2V5KHMsIHJrLCAwKTsKICBmb3IgKGxldCByb3VuZCA9IDE7IHJvdW5kIDwgTnI7IHJvdW5kKyspIHsKICAgIHN1YkJ5dGVzKHMpOwogICAgc2hpZnRSb3dzKHMpOwogICAgbWl4Q29sdW1ucyhzKTsKICAgIGFkZFJvdW5kS2V5KHMsIHJrLCByb3VuZCk7CiAgfQogIHN1YkJ5dGVzKHMpOwogIHNoaWZ0Um93cyhzKTsKICBhZGRSb3VuZEtleShzLCByaywgTnIpOwogIHJldHVybiBzOwp9CgpmdW5jdGlvbiBpbmMzMihjb3VudGVyMTYpIHsKICBjb25zdCBvdXQgPSBjb3VudGVyMTYuc2xpY2UoKTsKICAKICBsZXQgY2FycnkgPSAxOwogIGZvciAobGV0IGkgPSAxNTsgaSA+PSAxMjsgaS0tKSB7CiAgICBjb25zdCB2ID0gKG91dFtpXSB8IDApICsgY2Fycnk7CiAgICBvdXRbaV0gPSB2ICYgMHhmZjsKICAgIGNhcnJ5ID0gdiA+Pj4gODsKICAgIGlmICghY2FycnkpIGJyZWFrOwogIH0KICByZXR1cm4gb3V0Owp9CgpmdW5jdGlvbiBnaGFzaE11bHRpcGx5KHgxMjgsIHkxMjgpIHsKICBsZXQgWiA9IDBuOwogIGxldCBWID0geTEyODsKICBmb3IgKGxldCBpID0gMDsgaSA8IDEyODsgaSsrKSB7CiAgICBjb25zdCBiaXQgPSAoeDEyOCA+PiBCaWdJbnQoMTI3IC0gaSkpICYgMW47CiAgICBpZiAoYml0KSBaIF49IFY7CiAgICBpZiAoKFYgJiAxbikgPT09IDBuKSB7CiAgICAgIFYgPj49IDFuOwogICAgfSBlbHNlIHsKICAgICAgViA9IChWID4+IDFuKSBeIFI7CiAgICB9CiAgfQogIHJldHVybiBaOwp9CgpmdW5jdGlvbiBnaGFzaChILCBBLCBDKSB7CiAgCiAgZnVuY3Rpb24gcGFkMTYodTgpIHsKICAgIGNvbnN0IHJlbSA9IHU4Lmxlbmd0aCAlIDE2OwogICAgcmV0dXJuIHJlbSA/IG5ldyBVaW50OEFycmF5KFsuLi51OCwgLi4ubmV3IFVpbnQ4QXJyYXkoMTYgLSByZW0pXSkgOiB1ODsKICB9CiAgY29uc3QgQV8gPSBwYWQxNihBKTsKICBjb25zdCBDXyA9IHBhZDE2KEMpOwoKICBsZXQgWSA9IDBuOwogIGNvbnN0IEhuID0gYnl0ZXNUb0JpZ0ludEJFKEgpOwoKICBmb3IgKGxldCBvZmYgPSAwOyBvZmYgPCBBXy5sZW5ndGg7IG9mZiArPSAxNikgewogICAgY29uc3QgWGkgPSBieXRlc1RvQmlnSW50QkUoQV8uc3ViYXJyYXkob2ZmLCBvZmYgKyAxNikpOwogICAgWSA9IGdoYXNoTXVsdGlwbHkoWSBeIFhpLCBIbik7CiAgfQogIGZvciAobGV0IG9mZiA9IDA7IG9mZiA8IENfLmxlbmd0aDsgb2ZmICs9IDE2KSB7CiAgICBjb25zdCBYaSA9IGJ5dGVzVG9CaWdJbnRCRShDXy5zdWJhcnJheShvZmYsIG9mZiArIDE2KSk7CiAgICBZID0gZ2hhc2hNdWx0aXBseShZIF4gWGksIEhuKTsKICB9CgogIGNvbnN0IGxlbkJsb2NrID0gbmV3IFVpbnQ4QXJyYXkoMTYpOwogIGNvbnN0IGFCaXRzID0gQmlnSW50KEEubGVuZ3RoKSAqIDhuOwogIGNvbnN0IGNCaXRzID0gQmlnSW50KEMubGVuZ3RoKSAqIDhuOwogIGxlbkJsb2NrLnNldChiaWdJbnRUb0J5dGVzQkUoYUJpdHMsIDgpLCAwKTsKICBsZW5CbG9jay5zZXQoYmlnSW50VG9CeXRlc0JFKGNCaXRzLCA4KSwgOCk7CgogIFkgPSBnaGFzaE11bHRpcGx5KFkgXiBieXRlc1RvQmlnSW50QkUobGVuQmxvY2spLCBIbik7CiAgcmV0dXJuIGJpZ0ludFRvQnl0ZXNCRShZLCAxNik7Cn0KCmZ1bmN0aW9uIGdjdHIocmssIGljYiwgaW5wdXQpIHsKICAKICBpZiAoaW5wdXQubGVuZ3RoID09PSAwKSByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoMCk7CiAgY29uc3Qgb3V0ID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQubGVuZ3RoKTsKICBsZXQgY3RyID0gaWNiLnNsaWNlKCk7CiAgZm9yIChsZXQgb2ZmID0gMDsgb2ZmIDwgaW5wdXQubGVuZ3RoOyBvZmYgKz0gMTYpIHsKICAgIGN0ciA9IGluYzMyKGN0cik7CiAgICBjb25zdCBrZXlzdHJlYW0gPSBhZXNFbmNyeXB0QmxvY2socmssIGN0cik7CiAgICBjb25zdCBjaHVuayA9IGlucHV0LnN1YmFycmF5KG9mZiwgTWF0aC5taW4ob2ZmICsgMTYsIGlucHV0Lmxlbmd0aCkpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaHVuay5sZW5ndGg7IGkrKykgewogICAgICBvdXRbb2ZmICsgaV0gPSBjaHVua1tpXSBeIGtleXN0cmVhbVtpXTsKICAgIH0KICB9CiAgcmV0dXJuIG91dDsKfQoKZXhwb3J0IGZ1bmN0aW9uIGFlczI1NkdjbUVuY3J5cHQoewogIGtleSwKICBpdiwKICBwbGFpbnRleHQsCiAgYWFkID0gbmV3IFVpbnQ4QXJyYXkoMCksCiAgdGFnTGVuZ3RoID0gMTYsCn0pIHsKICBrZXkgPSB0b1U4KGtleSk7CiAgaXYgPSB0b1U4KGl2KTsKICBwbGFpbnRleHQgPSB0b1U4KHBsYWludGV4dCk7CiAgYWFkID0gdG9VOChhYWQpOwogIGlmIChrZXkubGVuZ3RoICE9PSAzMikgdGhyb3cgbmV3IEVycm9yKCJBRVMtMjU2IGtleSBtdXN0IGJlIDMyIGJ5dGVzIik7CiAgaWYgKHRhZ0xlbmd0aCAhPT0gMTYpCiAgICB0aHJvdyBuZXcgRXJyb3IoIk9ubHkgMTI4LWJpdCB0YWdzIHN1cHBvcnRlZCBpbiB0aGlzIHJlZmVyZW5jZSIpOwoKICBjb25zdCByayA9IGtleUV4cGFuZDI1NihrZXkpOwogIGNvbnN0IEggPSBhZXNFbmNyeXB0QmxvY2socmssIHplcm8oMTYpKTsgCgogIGxldCBKMDsKICBpZiAoaXYubGVuZ3RoID09PSAxMikgewogICAgSjAgPSBuZXcgVWludDhBcnJheSgxNik7CiAgICBKMC5zZXQoaXYsIDApOwogICAgSjBbMTVdID0gMTsgCiAgfSBlbHNlIHsKICAgIGNvbnN0IFMgPSBnaGFzaChILCBuZXcgVWludDhBcnJheSgwKSwgaXYpOwogICAgSjAgPSBTOyAKICB9CgogIGNvbnN0IGNpcGhlcnRleHQgPSBnY3RyKHJrLCBKMCwgcGxhaW50ZXh0KTsgCiAgY29uc3QgUyA9IGdoYXNoKEgsIGFhZCwgY2lwaGVydGV4dCk7CiAgY29uc3QgdGFnID0geG9yQnl0ZXMoYWVzRW5jcnlwdEJsb2NrKHJrLCBKMCksIFMpLnN1YmFycmF5KDAsIHRhZ0xlbmd0aCk7CgogIHJldHVybiB7IGNpcGhlcnRleHQsIHRhZyB9Owp9CgpleHBvcnQgZnVuY3Rpb24gYWVzMjU2R2NtRGVjcnlwdCh7CiAga2V5LAogIGl2LAogIGNpcGhlcnRleHQsCiAgYWFkID0gbmV3IFVpbnQ4QXJyYXkoMCksCiAgdGFnLAp9KSB7CiAga2V5ID0gdG9VOChrZXkpOwogIGl2ID0gdG9VOChpdik7CiAgY2lwaGVydGV4dCA9IHRvVTgoY2lwaGVydGV4dCk7CiAgYWFkID0gdG9VOChhYWQpOwogIHRhZyA9IHRvVTgodGFnKTsKICBpZiAoa2V5Lmxlbmd0aCAhPT0gMzIpIHRocm93IG5ldyBFcnJvcigiQUVTLTI1NiBrZXkgbXVzdCBiZSAzMiBieXRlcyIpOwogIGlmICh0YWcubGVuZ3RoICE9PSAxNikKICAgIHRocm93IG5ldyBFcnJvcigiT25seSAxMjgtYml0IHRhZ3Mgc3VwcG9ydGVkIGluIHRoaXMgcmVmZXJlbmNlIik7CgogIGNvbnN0IHJrID0ga2V5RXhwYW5kMjU2KGtleSk7CiAgY29uc3QgSCA9IGFlc0VuY3J5cHRCbG9jayhyaywgemVybygxNikpOwoKICBsZXQgSjA7CiAgaWYgKGl2Lmxlbmd0aCA9PT0gMTIpIHsKICAgIEowID0gbmV3IFVpbnQ4QXJyYXkoMTYpOwogICAgSjAuc2V0KGl2LCAwKTsKICAgIEowWzE1XSA9IDE7CiAgfSBlbHNlIHsKICAgIEowID0gZ2hhc2goSCwgbmV3IFVpbnQ4QXJyYXkoMCksIGl2KTsKICB9CgogIGNvbnN0IFMgPSBnaGFzaChILCBhYWQsIGNpcGhlcnRleHQpOwogIGNvbnN0IGV4cGVjdGVkVGFnID0geG9yQnl0ZXMoYWVzRW5jcnlwdEJsb2NrKHJrLCBKMCksIFMpLnN1YmFycmF5KAogICAgMCwKICAgIHRhZy5sZW5ndGgKICApOwoKICBpZiAoZXhwZWN0ZWRUYWcubGVuZ3RoICE9PSB0YWcubGVuZ3RoKSByZXR1cm4geyBvazogZmFsc2UsIHBsYWludGV4dDogbnVsbCB9OwogIGxldCBkaWZmID0gMDsKICBmb3IgKGxldCBpID0gMDsgaSA8IHRhZy5sZW5ndGg7IGkrKykgZGlmZiB8PSBleHBlY3RlZFRhZ1tpXSBeIHRhZ1tpXTsKICBpZiAoZGlmZiAhPT0gMCkgcmV0dXJuIHsgb2s6IGZhbHNlLCBwbGFpbnRleHQ6IG51bGwgfTsKCiAgY29uc3QgcGxhaW50ZXh0ID0gZ2N0cihyaywgSjAsIGNpcGhlcnRleHQpOwogIHJldHVybiB7IG9rOiB0cnVlLCBwbGFpbnRleHQgfTsKfQoKICA8L3NjcmlwdD4KCiAgPHNjcmlwdCB0eXBlPSJtb2R1bGUtc291cmNlIiBpZD0iaG1hYy1zY3JpcHQiPgogICAgCmNvbnN0IHRvVTggPSAodikgPT4gKHYgaW5zdGFuY2VvZiBVaW50OEFycmF5ID8gdiA6IG5ldyBVaW50OEFycmF5KHYpKTsKY29uc3QgY29uY2F0ID0gKGEsIGIpID0+IHsKICBjb25zdCBvdXQgPSBuZXcgVWludDhBcnJheShhLmxlbmd0aCArIGIubGVuZ3RoKTsKICBvdXQuc2V0KGEsIDApOwogIG91dC5zZXQoYiwgYS5sZW5ndGgpOwogIHJldHVybiBvdXQ7Cn07CmNvbnN0IGkzMmJlID0gKHgpID0+CiAgbmV3IFVpbnQ4QXJyYXkoWwogICAgKHggPj4+IDI0KSAmIDB4ZmYsCiAgICAoeCA+Pj4gMTYpICYgMHhmZiwKICAgICh4ID4+PiA4KSAmIDB4ZmYsCiAgICB4ICYgMHhmZiwKICBdKTsKCmNvbnN0IEsgPSBuZXcgVWludDMyQXJyYXkoWwogIDB4NDI4YTJmOTgsIDB4NzEzNzQ0OTEsIDB4YjVjMGZiY2YsIDB4ZTliNWRiYTUsIDB4Mzk1NmMyNWIsIDB4NTlmMTExZjEsCiAgMHg5MjNmODJhNCwgMHhhYjFjNWVkNSwgMHhkODA3YWE5OCwgMHgxMjgzNWIwMSwgMHgyNDMxODViZSwgMHg1NTBjN2RjMywKICAweDcyYmU1ZDc0LCAweDgwZGViMWZlLCAweDliZGMwNmE3LCAweGMxOWJmMTc0LCAweGU0OWI2OWMxLCAweGVmYmU0Nzg2LAogIDB4MGZjMTlkYzYsIDB4MjQwY2ExY2MsIDB4MmRlOTJjNmYsIDB4NGE3NDg0YWEsIDB4NWNiMGE5ZGMsIDB4NzZmOTg4ZGEsCiAgMHg5ODNlNTE1MiwgMHhhODMxYzY2ZCwgMHhiMDAzMjdjOCwgMHhiZjU5N2ZjNywgMHhjNmUwMGJmMywgMHhkNWE3OTE0NywKICAweDA2Y2E2MzUxLCAweDE0MjkyOTY3LCAweDI3YjcwYTg1LCAweDJlMWIyMTM4LCAweDRkMmM2ZGZjLCAweDUzMzgwZDEzLAogIDB4NjUwYTczNTQsIDB4NzY2YTBhYmIsIDB4ODFjMmM5MmUsIDB4OTI3MjJjODUsIDB4YTJiZmU4YTEsIDB4YTgxYTY2NGIsCiAgMHhjMjRiOGI3MCwgMHhjNzZjNTFhMywgMHhkMTkyZTgxOSwgMHhkNjk5MDYyNCwgMHhmNDBlMzU4NSwgMHgxMDZhYTA3MCwKICAweDE5YTRjMTE2LCAweDFlMzc2YzA4LCAweDI3NDg3NzRjLCAweDM0YjBiY2I1LCAweDM5MWMwY2IzLCAweDRlZDhhYTRhLAogIDB4NWI5Y2NhNGYsIDB4NjgyZTZmZjMsIDB4NzQ4ZjgyZWUsIDB4NzhhNTYzNmYsIDB4ODRjODc4MTQsIDB4OGNjNzAyMDgsCiAgMHg5MGJlZmZmYSwgMHhhNDUwNmNlYiwgMHhiZWY5YTNmNywgMHhjNjcxNzhmMiwKXSk7CmNvbnN0IFJPVFIgPSAoeCwgbikgPT4gKHggPj4+IG4pIHwgKHggPDwgKDMyIC0gbikpOwpjb25zdCBDaCA9ICh4LCB5LCB6KSA9PiAoeCAmIHkpIF4gKH54ICYgeik7CmNvbnN0IE1haiA9ICh4LCB5LCB6KSA9PiAoeCAmIHkpIF4gKHggJiB6KSBeICh5ICYgeik7CmNvbnN0IFNpZ21hMCA9ICh4KSA9PiBST1RSKHgsIDIpIF4gUk9UUih4LCAxMykgXiBST1RSKHgsIDIyKTsKY29uc3QgU2lnbWExID0gKHgpID0+IFJPVFIoeCwgNikgXiBST1RSKHgsIDExKSBeIFJPVFIoeCwgMjUpOwpjb25zdCBzaWdtYTAgPSAoeCkgPT4gUk9UUih4LCA3KSBeIFJPVFIoeCwgMTgpIF4gKHggPj4+IDMpOwpjb25zdCBzaWdtYTEgPSAoeCkgPT4gUk9UUih4LCAxNykgXiBST1RSKHgsIDE5KSBeICh4ID4+PiAxMCk7CgpleHBvcnQgZnVuY3Rpb24gc2hhMjU2KG1zZ1U4KSB7CiAgY29uc3QgbSA9IHRvVTgobXNnVTgpOwogIAogIGxldCBoMCA9IDB4NmEwOWU2NjcsCiAgICBoMSA9IDB4YmI2N2FlODUsCiAgICBoMiA9IDB4M2M2ZWYzNzIsCiAgICBoMyA9IDB4YTU0ZmY1M2E7CiAgbGV0IGg0ID0gMHg1MTBlNTI3ZiwKICAgIGg1ID0gMHg5YjA1Njg4YywKICAgIGg2ID0gMHgxZjgzZDlhYiwKICAgIGg3ID0gMHg1YmUwY2QxOTsKCiAgY29uc3QgYml0TGVuSGkgPSBNYXRoLmZsb29yKChtLmxlbmd0aCAvIDB4MjAwMDAwMDApID4+PiAwKTsgCiAgY29uc3QgYml0TGVuTG8gPSAoKG0ubGVuZ3RoID4+PiAwKSAqIDgpID4+PiAwOyAKICBjb25zdCBrID0gLShtLmxlbmd0aCArIDkpICYgNjM7CiAgY29uc3QgcGFkZGVkID0gbmV3IFVpbnQ4QXJyYXkobS5sZW5ndGggKyAxICsgayArIDgpOwogIHBhZGRlZC5zZXQobSwgMCk7CiAgcGFkZGVkW20ubGVuZ3RoXSA9IDB4ODA7CiAgCiAgcGFkZGVkW3BhZGRlZC5sZW5ndGggLSA4XSA9IChiaXRMZW5IaSA+Pj4gMjQpICYgMHhmZjsKICBwYWRkZWRbcGFkZGVkLmxlbmd0aCAtIDddID0gKGJpdExlbkhpID4+PiAxNikgJiAweGZmOwogIHBhZGRlZFtwYWRkZWQubGVuZ3RoIC0gNl0gPSAoYml0TGVuSGkgPj4+IDgpICYgMHhmZjsKICBwYWRkZWRbcGFkZGVkLmxlbmd0aCAtIDVdID0gYml0TGVuSGkgJiAweGZmOwogIHBhZGRlZFtwYWRkZWQubGVuZ3RoIC0gNF0gPSAoYml0TGVuTG8gPj4+IDI0KSAmIDB4ZmY7CiAgcGFkZGVkW3BhZGRlZC5sZW5ndGggLSAzXSA9IChiaXRMZW5MbyA+Pj4gMTYpICYgMHhmZjsKICBwYWRkZWRbcGFkZGVkLmxlbmd0aCAtIDJdID0gKGJpdExlbkxvID4+PiA4KSAmIDB4ZmY7CiAgcGFkZGVkW3BhZGRlZC5sZW5ndGggLSAxXSA9IGJpdExlbkxvICYgMHhmZjsKCiAgY29uc3QgVyA9IG5ldyBVaW50MzJBcnJheSg2NCk7CgogIGZvciAobGV0IG9mZiA9IDA7IG9mZiA8IHBhZGRlZC5sZW5ndGg7IG9mZiArPSA2NCkgewogICAgCiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDE2OyBpKyspIHsKICAgICAgY29uc3QgaiA9IG9mZiArIChpIDw8IDIpOwogICAgICBXW2ldID0KICAgICAgICAocGFkZGVkW2pdIDw8IDI0KSB8CiAgICAgICAgKHBhZGRlZFtqICsgMV0gPDwgMTYpIHwKICAgICAgICAocGFkZGVkW2ogKyAyXSA8PCA4KSB8CiAgICAgICAgcGFkZGVkW2ogKyAzXTsKICAgIH0KICAgIGZvciAobGV0IGkgPSAxNjsgaSA8IDY0OyBpKyspIHsKICAgICAgV1tpXSA9CiAgICAgICAgKHNpZ21hMShXW2kgLSAyXSkgKyBXW2kgLSA3XSArIHNpZ21hMChXW2kgLSAxNV0pICsgV1tpIC0gMTZdKSA+Pj4gMDsKICAgIH0KCiAgICBsZXQgYSA9IGgwLAogICAgICBiID0gaDEsCiAgICAgIGMgPSBoMiwKICAgICAgZCA9IGgzLAogICAgICBlID0gaDQsCiAgICAgIGYgPSBoNSwKICAgICAgZyA9IGg2LAogICAgICBoID0gaDc7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2NDsgaSsrKSB7CiAgICAgIGNvbnN0IHQxID0gKGggKyBTaWdtYTEoZSkgKyBDaChlLCBmLCBnKSArIEtbaV0gKyBXW2ldKSA+Pj4gMDsKICAgICAgY29uc3QgdDIgPSAoU2lnbWEwKGEpICsgTWFqKGEsIGIsIGMpKSA+Pj4gMDsKICAgICAgaCA9IGc7CiAgICAgIGcgPSBmOwogICAgICBmID0gZTsKICAgICAgZSA9IChkICsgdDEpID4+PiAwOwogICAgICBkID0gYzsKICAgICAgYyA9IGI7CiAgICAgIGIgPSBhOwogICAgICBhID0gKHQxICsgdDIpID4+PiAwOwogICAgfQoKICAgIGgwID0gKGgwICsgYSkgPj4+IDA7CiAgICBoMSA9IChoMSArIGIpID4+PiAwOwogICAgaDIgPSAoaDIgKyBjKSA+Pj4gMDsKICAgIGgzID0gKGgzICsgZCkgPj4+IDA7CiAgICBoNCA9IChoNCArIGUpID4+PiAwOwogICAgaDUgPSAoaDUgKyBmKSA+Pj4gMDsKICAgIGg2ID0gKGg2ICsgZykgPj4+IDA7CiAgICBoNyA9IChoNyArIGgpID4+PiAwOwogIH0KCiAgY29uc3Qgb3V0ID0gbmV3IFVpbnQ4QXJyYXkoMzIpOwogIGNvbnN0IEggPSBbaDAsIGgxLCBoMiwgaDMsIGg0LCBoNSwgaDYsIGg3XTsKICBmb3IgKGxldCBpID0gMDsgaSA8IDg7IGkrKykgb3V0LnNldChpMzJiZShIW2ldKSwgaSAqIDQpOwogIHJldHVybiBvdXQ7Cn0KCmV4cG9ydCBmdW5jdGlvbiBtYWtlSG1hY1NoYTI1NkZuUmF3KGtleSkgewogIGtleSA9IHRvVTgoa2V5KTsKICBjb25zdCBibG9jayA9IDY0OwogIGlmIChrZXkubGVuZ3RoID4gYmxvY2spIGtleSA9IHNoYTI1NihrZXkpOwogIGlmIChrZXkubGVuZ3RoIDwgYmxvY2spIHsKICAgIGNvbnN0IGsgPSBuZXcgVWludDhBcnJheShibG9jayk7CiAgICBrLnNldChrZXkpOwogICAga2V5ID0gazsKICB9CiAgY29uc3QgaXBhZCA9IG5ldyBVaW50OEFycmF5KGJsb2NrKTsKICBjb25zdCBvcGFkID0gbmV3IFVpbnQ4QXJyYXkoYmxvY2spOwogIGZvciAobGV0IGkgPSAwOyBpIDwgYmxvY2s7IGkrKykgewogICAgaXBhZFtpXSA9IGtleVtpXSBeIDB4MzY7CiAgICBvcGFkW2ldID0ga2V5W2ldIF4gMHg1YzsKICB9CiAgcmV0dXJuIChtc2cpID0+IHNoYTI1Nihjb25jYXQob3BhZCwgc2hhMjU2KGNvbmNhdChpcGFkLCB0b1U4KG1zZykpKSkpOwp9CgpleHBvcnQgZnVuY3Rpb24gbWFrZUhtYWNTaGEyNTZGbihrZXkpIHsKICBpZiAoa2V5ID09IG51bGwgfHwga2V5Lmxlbmd0aCA9PT0gMCkKICAgIHRocm93IG5ldyBFcnJvcigiSE1BQyBrZXkgbXVzdCBiZSBub24tZW1wdHkiKTsKICBjb25zdCBobWFjID0gbWFrZUhtYWNTaGEyNTZGblJhdyhrZXkpOwogIHJldHVybiAobXNnKSA9PiBobWFjKG1zZyk7Cn0KCiAgPC9zY3JpcHQ+CgogIDxzY3JpcHQgdHlwZT0ibW9kdWxlLXNvdXJjZSIgaWQ9ImhrZGYtc2NyaXB0Ij4KICAgIGNvbnN0IHU4ID0gKHgpID0+ICh4IGluc3RhbmNlb2YgVWludDhBcnJheSA/IHggOiBuZXcgVWludDhBcnJheSh4KSk7CmNvbnN0IGNvbmNhdCA9ICguLi5hcnJzKSA9PiB7CiAgY29uc3QgdG90YWwgPSBhcnJzLnJlZHVjZSgobiwgYSkgPT4gbiArIGEubGVuZ3RoLCAwKTsKICBjb25zdCBvdXQgPSBuZXcgVWludDhBcnJheSh0b3RhbCk7CiAgbGV0IG9mZiA9IDA7CiAgZm9yIChjb25zdCBhIG9mIGFycnMpIHsKICAgIG91dC5zZXQoYSwgb2ZmKTsKICAgIG9mZiArPSBhLmxlbmd0aDsKICB9CiAgcmV0dXJuIG91dDsKfTsKCmV4cG9ydCBmdW5jdGlvbiBoa2RmRXh0cmFjdChzYWx0LCBpa20sIG1ha2VIbWFjU2hhMjU2Rm4pIHsKICAKICBjb25zdCB6ZXJvU2FsdCA9IG5ldyBVaW50OEFycmF5KDMyKTsKICBjb25zdCBzID0gc2FsdCAmJiBzYWx0Lmxlbmd0aCA/IHU4KHNhbHQpIDogemVyb1NhbHQ7CiAgY29uc3QgcHJrID0gbWFrZUhtYWNTaGEyNTZGbih1OChzKSkodTgoaWttKSk7IAogIHJldHVybiBwcms7Cn0KCmZ1bmN0aW9uIGhrZGZFeHBhbmQocHJrLCBpbmZvLCBsZW5ndGgsIG1ha2VIbWFjU2hhMjU2Rm4pIHsKICBpZiAoIWxlbmd0aCB8fCBsZW5ndGggPD0gMCkgdGhyb3cgbmV3IEVycm9yKCJIS0RGIGxlbmd0aCBtdXN0IGJlID4gMCIpOwogIGNvbnN0IGhhc2hMZW4gPSAzMjsKICBpZiAobGVuZ3RoID4gMjU1ICogaGFzaExlbikgdGhyb3cgbmV3IEVycm9yKCJIS0RGIGxlbmd0aCB0b28gbGFyZ2UiKTsKICBjb25zdCBobWFjID0gbWFrZUhtYWNTaGEyNTZGbih1OChwcmspKTsKICBjb25zdCBpID0gdTgoaW5mbyB8fCBuZXcgVWludDhBcnJheSgwKSk7CgogIGxldCB0ID0gbmV3IFVpbnQ4QXJyYXkoMCk7CiAgY29uc3Qgb2ttID0gbmV3IFVpbnQ4QXJyYXkobGVuZ3RoKTsKICBsZXQgcG9zID0gMDsKICBmb3IgKGxldCBjdHIgPSAxOyBwb3MgPCBsZW5ndGg7IGN0cisrKSB7CiAgICBjb25zdCBibG9jayA9IGhtYWMoY29uY2F0KHQsIGksIG5ldyBVaW50OEFycmF5KFtjdHJdKSkpOwogICAgY29uc3QgdGFrZSA9IE1hdGgubWluKGhhc2hMZW4sIGxlbmd0aCAtIHBvcyk7CiAgICBva20uc2V0KGJsb2NrLnN1YmFycmF5KDAsIHRha2UpLCBwb3MpOwogICAgcG9zICs9IHRha2U7CiAgICB0ID0gYmxvY2s7CiAgfQogIHJldHVybiBva207Cn0KCmV4cG9ydCBmdW5jdGlvbiBoa2RmKAogIGlrbSwKICB7IHNhbHQgPSBuZXcgVWludDhBcnJheSgwKSwgaW5mbyA9IG5ldyBVaW50OEFycmF5KDApLCBsZW5ndGggPSAzMiB9ID0ge30sCiAgbWFrZUhtYWNTaGEyNTZGbgopIHsKICBjb25zdCBwcmsgPSBoa2RmRXh0cmFjdChzYWx0LCBpa20sIG1ha2VIbWFjU2hhMjU2Rm4pOwogIHJldHVybiBoa2RmRXhwYW5kKHByaywgaW5mbywgbGVuZ3RoLCBtYWtlSG1hY1NoYTI1NkZuKTsKfQoKICA8L3NjcmlwdD4KCiAgPHNjcmlwdCB0eXBlPSJtb2R1bGUtc291cmNlIiBpZD0ieDI1NTE5LXNjcmlwdCI+CiAgICAKY29uc3QgUCA9ICgxbiA8PCAyNTVuKSAtIDE5bjsgCmNvbnN0IEEyNCA9IDEyMTY2NW47IAoKZXhwb3J0IGZ1bmN0aW9uIGxlQnl0ZXNUb0JpZ0ludChsZSkgewogIGxldCB4ID0gMG47CiAgZm9yIChsZXQgaSA9IGxlLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7CiAgICB4ID0gKHggPDwgOG4pIHwgQmlnSW50KGxlW2ldKTsKICB9CiAgcmV0dXJuIHg7Cn0KCmV4cG9ydCBmdW5jdGlvbiBiaWdJbnRUb0xlQnl0ZXMoeCwgbGVuID0gMzIpIHsKICBjb25zdCBvdXQgPSBuZXcgVWludDhBcnJheShsZW4pOwogIGxldCB2ID0geDsKICBmb3IgKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CiAgICBvdXRbaV0gPSBOdW1iZXIodiAmIDB4ZmZuKTsKICAgIHYgPj49IDhuOwogIH0KICByZXR1cm4gb3V0Owp9CgpmdW5jdGlvbiBjbGFtcFNjYWxhcihrKSB7CiAgY29uc3QgcyA9IG5ldyBVaW50OEFycmF5KGspOyAKICBzWzBdICY9IDI0ODsKICBzWzMxXSAmPSAxMjc7CiAgc1szMV0gfD0gNjQ7CiAgcmV0dXJuIHM7Cn0KCmNvbnN0IG1vZCA9IChhKSA9PiB7CiAgYSAlPSBQOwogIHJldHVybiBhID49IDBuID8gYSA6IGEgKyBQOwp9OwoKY29uc3QgYWRkID0gKGEsIGIpID0+IG1vZChhICsgYik7CmNvbnN0IHN1YiA9IChhLCBiKSA9PiBtb2QoYSAtIGIpOwpjb25zdCBtdWwgPSAoYSwgYikgPT4gbW9kKGEgKiBiKTsKY29uc3Qgc3FyID0gKGEpID0+IG1vZChhICogYSk7CgpmdW5jdGlvbiBwb3dNb2QoYmFzZSwgZXhwKSB7CiAgYmFzZSA9IG1vZChiYXNlKTsKICBsZXQgcmVzdWx0ID0gMW47CiAgd2hpbGUgKGV4cCA+IDBuKSB7CiAgICBpZiAoZXhwICYgMW4pIHJlc3VsdCA9IG1vZChyZXN1bHQgKiBiYXNlKTsKICAgIGJhc2UgPSBtb2QoYmFzZSAqIGJhc2UpOwogICAgZXhwID4+PSAxbjsKICB9CiAgcmV0dXJuIHJlc3VsdDsKfQoKY29uc3QgaW52ID0gKGEpID0+IHBvd01vZChhLCBQIC0gMm4pOwoKZnVuY3Rpb24gaXNBbGxaZXJvMzIodTgpIHsKICAKICBsZXQgYWNjID0gMDsKICBmb3IgKGxldCBpID0gMDsgaSA8IDMyOyBpKyspIGFjYyB8PSB1OFtpXTsKICByZXR1cm4gYWNjID09PSAwOwp9CgpmdW5jdGlvbiBjc3dhcChjb25kLCB4MiwgeDMpIHsKICBpZiAoY29uZCAhPT0gMG4gJiYgY29uZCAhPT0gMW4pCiAgICB0aHJvdyBuZXcgRXJyb3IoImNzd2FwOiBjb25kIG11c3QgYmUgMG4gb3IgMW4iKTsKICBjb25zdCBtYXNrID0gLWNvbmQ7IAogIGNvbnN0IHR4ID0gKHgyIF4geDMpICYgbWFzazsKICByZXR1cm4gW3gyIF4gdHgsIHgzIF4gdHhdOwp9CgpmdW5jdGlvbiBtb250Z29tZXJ5TGFkZGVyKHNjYWxhckJ5dGVzLCB1Qnl0ZXMpIHsKICBjb25zdCBrID0gbGVCeXRlc1RvQmlnSW50KGNsYW1wU2NhbGFyKHNjYWxhckJ5dGVzKSk7CiAgCiAgY29uc3QgdUxFID0gbmV3IFVpbnQ4QXJyYXkodUJ5dGVzKTsKICB1TEVbMzFdICY9IDB4N2Y7CiAgY29uc3QgeDEgPSBtb2QobGVCeXRlc1RvQmlnSW50KHVMRSkpOwoKICBsZXQgeDIgPSAxbiwKICAgIHoyID0gMG47CiAgbGV0IHgzID0geDEsCiAgICB6MyA9IDFuOwogIGxldCBzd2FwID0gMG47CgogIGZvciAobGV0IHQgPSAyNTQ7IHQgPj0gMDsgdC0tKSB7CiAgICBjb25zdCBrdCA9IChrID4+IEJpZ0ludCh0KSkgJiAxbjsKICAgIHN3YXAgXj0ga3Q7CiAgICBbeDIsIHgzXSA9IGNzd2FwKHN3YXAsIHgyLCB4Myk7CiAgICBbejIsIHozXSA9IGNzd2FwKHN3YXAsIHoyLCB6Myk7CiAgICBzd2FwID0ga3Q7CgogICAgY29uc3QgQSA9IGFkZCh4MiwgejIpOwogICAgY29uc3QgQUEgPSBzcXIoQSk7CiAgICBjb25zdCBCID0gc3ViKHgyLCB6Mik7CiAgICBjb25zdCBCQiA9IHNxcihCKTsKICAgIGNvbnN0IEUgPSBzdWIoQUEsIEJCKTsKICAgIGNvbnN0IEMgPSBhZGQoeDMsIHozKTsKICAgIGNvbnN0IEQgPSBzdWIoeDMsIHozKTsKICAgIGNvbnN0IERBID0gbXVsKEQsIEEpOwogICAgY29uc3QgQ0IgPSBtdWwoQywgQik7CiAgICBjb25zdCB4M24gPSBzcXIoYWRkKERBLCBDQikpOwogICAgY29uc3QgejNuID0gbXVsKHgxLCBzcXIoc3ViKERBLCBDQikpKTsKICAgIGNvbnN0IHgybiA9IG11bChBQSwgQkIpOwogICAgY29uc3QgejJuID0gbXVsKEUsIGFkZChBQSwgbXVsKEEyNCwgRSkpKTsKCiAgICB4MyA9IHgzbjsKICAgIHozID0gejNuOwogICAgeDIgPSB4Mm47CiAgICB6MiA9IHoybjsKICB9CgogIFt4MiwgeDNdID0gY3N3YXAoc3dhcCwgeDIsIHgzKTsKICBbejIsIHozXSA9IGNzd2FwKHN3YXAsIHoyLCB6Myk7CgogIGNvbnN0IHJlcyA9IG11bCh4MiwgaW52KHoyKSk7CiAgcmV0dXJuIGJpZ0ludFRvTGVCeXRlcyhyZXMsIDMyKTsKfQoKY29uc3QgYXNzZXJ0VTgzMiA9IChhcnIsIG5hbWUpID0+IHsKICBpZiAoIShhcnIgaW5zdGFuY2VvZiBVaW50OEFycmF5KSB8fCBhcnIubGVuZ3RoICE9PSAzMikgewogICAgdGhyb3cgbmV3IEVycm9yKGAke25hbWV9IG11c3QgYmUgVWludDhBcnJheSgzMilgKTsKICB9Cn07CgpleHBvcnQgZnVuY3Rpb24geDI1NTE5KHNjYWxhciwgdSkgewogIGFzc2VydFU4MzIoc2NhbGFyLCAic2NhbGFyIik7CiAgYXNzZXJ0VTgzMih1LCAidSIpOwogIHJldHVybiBtb250Z29tZXJ5TGFkZGVyKHNjYWxhciwgdSk7Cn0KCmV4cG9ydCBmdW5jdGlvbiBzaGFyZWRLZXkoc2VjcmV0S2V5LCBwdWJsaWNLZXkpIHsKICBjb25zdCBzcyA9IHgyNTUxOShzZWNyZXRLZXksIHB1YmxpY0tleSk7CiAgaWYgKGlzQWxsWmVybzMyKHNzKSkgewogICAgdGhyb3cgbmV3IEVycm9yKCJUaGUgb3BlcmF0aW9uIGZhaWxlZCBmb3IgYW4gb3BlcmF0aW9uLXNwZWNpZmljIHJlYXNvbiIpOwogIH0KICByZXR1cm4gc3M7Cn0KCmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZUtleVBhaXIoKSB7CiAgY29uc3Qgc2VjcmV0S2V5ID0gY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhuZXcgVWludDhBcnJheSgzMikpOwogIGNvbnN0IGNsYW1wZWQgPSBjbGFtcFNjYWxhcihzZWNyZXRLZXkpOwogIGNvbnN0IGJhc2VQb2ludCA9IG5ldyBVaW50OEFycmF5KDMyKTsKICBiYXNlUG9pbnRbMF0gPSA5OyAKICBjb25zdCBwdWJsaWNLZXkgPSB4MjU1MTkoY2xhbXBlZCwgYmFzZVBvaW50KTsKICByZXR1cm4geyBwdWJsaWNLZXksIHNlY3JldEtleTogY2xhbXBlZCB9Owp9CgogIDwvc2NyaXB0PgoKICA8c2NyaXB0IHR5cGU9Im1vZHVsZSI+CiAgICBjb25zdCAkID0gKHMpID0+IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iocyk7CgogICAgYXN5bmMgZnVuY3Rpb24gbG9hZElubGluZU1vZHVsZShpZCkgewogICAgICBjb25zdCBjb2RlID0gJCgnIycgKyBpZCkudGV4dENvbnRlbnQ7CiAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW2NvZGVdLCB7IHR5cGU6ICd0ZXh0L2phdmFzY3JpcHQnIH0pKTsKICAgICAgcmV0dXJuIHsgbW9kdWxlOiBhd2FpdCBpbXBvcnQodXJsKSwgY29kZSB9OwogICAgfQoKICAgIGNvbnN0IGFlczI1NmdjbSA9IGF3YWl0IGxvYWRJbmxpbmVNb2R1bGUoJ2FlczI1NmdjbS1zY3JpcHQnKTsKICAgIGNvbnN0IGhtYWMgPSBhd2FpdCBsb2FkSW5saW5lTW9kdWxlKCdobWFjLXNjcmlwdCcpOwogICAgY29uc3QgaGtkZiA9IGF3YWl0IGxvYWRJbmxpbmVNb2R1bGUoJ2hrZGYtc2NyaXB0Jyk7CiAgICBjb25zdCB4MjU1MTkgPSBhd2FpdCBsb2FkSW5saW5lTW9kdWxlKCd4MjU1MTktc2NyaXB0Jyk7CgogICAgY29uc3QgREVDT0RFX1RFTVBMQVRFID0gJCgiI2RlY29kZS10ZW1wbGF0ZSIpLmlubmVySFRNTDsKCiAgICAvLyBHbG9iYWwgc3RhdGUKICAgIGxldCBlbmNyeXB0aW9uS2V5ID0gbnVsbDsKICAgIGxldCBteVByaXZhdGVLZXkgPSBudWxsOwogICAgbGV0IG15UHVibGljS2V5ID0gbnVsbDsKICAgIGxldCBzYWx0ID0gbnVsbDsKCiAgICAvLyAtLS0gaGVscGVycyAtLS0KICAgIGNvbnN0IGVuYyA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgY29uc3QgYjY0ID0gKGJ1ZikgPT4gYnRvYShTdHJpbmcuZnJvbUNoYXJDb2RlKC4uLm5ldyBVaW50OEFycmF5KGJ1ZikpKTsKICAgIGNvbnN0IHVuYjY0ID0gKHN0cikgPT4gbmV3IFVpbnQ4QXJyYXkoWy4uLmF0b2Ioc3RyKV0ubWFwKGMgPT4gYy5jaGFyQ29kZUF0KDApKSk7CiAgICBjb25zdCByYW5kID0gKG4pID0+IGNyeXB0by5nZXRSYW5kb21WYWx1ZXMobmV3IFVpbnQ4QXJyYXkobikpOwoKICAgIGFzeW5jIGZ1bmN0aW9uIGVuY3J5cHRNZXNzYWdlKG1lc3NhZ2UpIHsKICAgICAgZW5jcnlwdGlvbktleSA9IHJhbmQoMzIpOwogICAgICBjb25zdCBpdiA9IHJhbmQoMTIpOwogICAgICBzYWx0ID0gcmFuZCgxNik7CgogICAgICBjb25zdCB7IGNpcGhlcnRleHQsIHRhZyB9ID0gYWVzMjU2Z2NtLm1vZHVsZS5hZXMyNTZHY21FbmNyeXB0KHsKICAgICAgICBrZXk6IGVuY3J5cHRpb25LZXksCiAgICAgICAgaXY6IGl2LAogICAgICAgIHBsYWludGV4dDogZW5jLmVuY29kZShtZXNzYWdlKQogICAgICB9KTsKCiAgICAgIHJldHVybiB7IGN0QjY0OiBiNjQoY2lwaGVydGV4dCksIGl2QjY0OiBiNjQoaXYpLCB0YWdCNjQ6IGI2NCh0YWcpLCBzYWx0QjY0OiBiNjQoc2FsdCkgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBidWlsZERlY29kZUhUTUwodGVtcGxhdGUsIHsgY3RCNjQsIGl2QjY0LCB0YWdCNjQsIHB1YkFCNjQsIHNhbHRCNjQgfSkgewogICAgICByZXR1cm4gdGVtcGxhdGUKICAgICAgICAucmVwbGFjZUFsbCgiX19DSVBIRVJURVhUX0I2NF9fIiwgY3RCNjQpCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fSVZfQjY0X18iLCBpdkI2NCkKICAgICAgICAucmVwbGFjZUFsbCgiX19UQUdfQjY0X18iLCB0YWdCNjQpCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fUFVCQV9CNjRfXyIsIHB1YkFCNjQpCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fU0FMVF9CNjRfXyIsIHNhbHRCNjQpCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fSU5DTFVERV9BRVMyNTZHQ01fSlNfMl9fIiwgYWVzMjU2Z2NtLmNvZGUpCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fSU5DTFVERV9ITUFDX0pTXzJfXyIsIGhtYWMuY29kZSkKICAgICAgICAucmVwbGFjZUFsbCgiX19JTkNMVURFX0hLREZfSlNfMl9fIiwgaGtkZi5jb2RlKQogICAgICAgIC5yZXBsYWNlQWxsKCJfX0lOQ0xVREVfWDI1NTE5X0pTXzJfXyIsIHgyNTUxOS5jb2RlKQogICAgfQoKICAgIGZ1bmN0aW9uIHRvRGF0YVVSTChodG1sKSB7CiAgICAgIGNvbnN0IHV0ZjggPSBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoaHRtbCk7CiAgICAgIGxldCBzID0gIiI7CiAgICAgIGZvciAoY29uc3QgYyBvZiB1dGY4KSBzICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoYyk7CiAgICAgIGNvbnN0IGI2NHVybCA9IGJ0b2Eocyk7CiAgICAgIHJldHVybiBgZGF0YTp0ZXh0L2h0bWw7YmFzZTY0LCR7YjY0dXJsfWA7CiAgICB9CgogICAgYXN5bmMgZnVuY3Rpb24gY29weVRvQ2xpcGJvYXJkKHRleHQsIGJ1dHRvbikgewogICAgICBjb25zdCBvcmlnaW5hbFRleHQgPSBidXR0b24udGV4dENvbnRlbnQ7CiAgICAgIHRyeSB7CiAgICAgICAgYXdhaXQgbmF2aWdhdG9yLmNsaXBib2FyZC53cml0ZVRleHQodGV4dCk7CiAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgIGNvbnN0IHRleHRhcmVhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgndGV4dGFyZWEnKTsKICAgICAgICB0ZXh0YXJlYS52YWx1ZSA9IHRleHQ7CiAgICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0ZXh0YXJlYSk7CiAgICAgICAgdGV4dGFyZWEuc2VsZWN0KCk7CiAgICAgICAgZG9jdW1lbnQuZXhlY0NvbW1hbmQoJ2NvcHknKTsKICAgICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKHRleHRhcmVhKTsKICAgICAgfQogICAgICBidXR0b24udGV4dENvbnRlbnQgPSAiQ29waWVkISI7CiAgICAgIHNldFRpbWVvdXQoKCkgPT4gewogICAgICAgIGJ1dHRvbi50ZXh0Q29udGVudCA9IG9yaWdpbmFsVGV4dDsKICAgICAgfSwgMjAwMCk7CiAgICB9CgogICAgLy8gRXZlbnQgbGlzdGVuZXJzCiAgICAkKCIjZW5jcnlwdC1idG4iKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGFzeW5jICgpID0+IHsKICAgICAgY29uc3Qgc2VjcmV0ID0gJCgiI3NlY3JldCIpLnZhbHVlLnRyaW0oKTsKICAgICAgaWYgKCFzZWNyZXQpIHsKICAgICAgICBhbGVydCgiUGxlYXNlIGVudGVyIGEgc2VjcmV0IG1lc3NhZ2UuIik7CiAgICAgICAgcmV0dXJuOwogICAgICB9CgogICAgICB0cnkgewogICAgICAgIC8vIEVuY3J5cHQgdGhlIG1lc3NhZ2UKICAgICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZW5jcnlwdE1lc3NhZ2Uoc2VjcmV0KTsKCiAgICAgICAgLy8gR2VuZXJhdGUgWDI1NTE5IGtleXBhaXIKICAgICAgICBjb25zdCBrZXlwYWlyID0geDI1NTE5Lm1vZHVsZS5nZW5lcmF0ZUtleVBhaXIoKTsKICAgICAgICBteVByaXZhdGVLZXkgPSBrZXlwYWlyLnNlY3JldEtleTsKICAgICAgICBteVB1YmxpY0tleSA9IGtleXBhaXIucHVibGljS2V5OwoKICAgICAgICAvLyBCdWlsZCBkZWNvZGUgdGVtcGxhdGUgd2l0aCBjaXBoZXJ0ZXh0IGFuZCBvdXIgcHVibGljIGtleQogICAgICAgIGNvbnN0IGRlY29kZUhUTUwgPSBidWlsZERlY29kZUhUTUwoREVDT0RFX1RFTVBMQVRFLCB7CiAgICAgICAgICAuLi5wYXlsb2FkLAogICAgICAgICAgcHViQUI2NDogYjY0KG15UHVibGljS2V5KQogICAgICAgIH0pOwoKICAgICAgICBjb25zdCB1cmwgPSB0b0RhdGFVUkwoZGVjb2RlSFRNTCk7CiAgICAgICAgJCgiI3VybCIpLnRleHRDb250ZW50ID0gdXJsOwoKICAgICAgICAvLyBVcGRhdGUgVUkKICAgICAgICAkKCIjc2VjcmV0IikuZGlzYWJsZWQgPSB0cnVlOwogICAgICAgICQoIiNlbmNyeXB0LWJ0biIpLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgICAgJCgiI3Nob3ctc2VjcmV0LWJ0biIpLmNsYXNzTGlzdC5yZW1vdmUoImhpZGRlbiIpOwogICAgICAgICQoIiN1cmwtb3V0cHV0IikuY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7CiAgICAgICAgJCgiI3N0ZXAyIikuY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7CgogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBhbGVydChgRXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7CiAgICAgIH0KICAgIH0pOwoKICAgICQoIiNzaG93LXNlY3JldC1idG4iKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgJCgiI3NlY3JldCIpLmRpc2FibGVkID0gISQoIiNzZWNyZXQiKS5kaXNhYmxlZDsKICAgICAgJCgiI3Nob3ctc2VjcmV0LWJ0biIpLnRleHRDb250ZW50ID0gJCgiI3NlY3JldCIpLmRpc2FibGVkID8gIlNob3cgU2VjcmV0IiA6ICJIaWRlIFNlY3JldCI7CiAgICB9KTsKCiAgICAkKCIjY29weS11cmwiKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgY29uc3QgdXJsID0gJCgiI3VybCIpLnRleHRDb250ZW50OwogICAgICBpZiAodXJsKSBjb3B5VG9DbGlwYm9hcmQodXJsLCAkKCIjY29weS11cmwiKSk7CiAgICB9KTsKCiAgICAkKCIjZ2VuZXJhdGUtZW5jcnlwdGVkLWtleSIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgYXN5bmMgKCkgPT4gewogICAgICBjb25zdCByZWNpcGllbnRQdWJLZXlCNjQgPSAkKCIjcmVjaXBpZW50LXB1YmtleSIpLnZhbHVlLnRyaW0oKTsKICAgICAgaWYgKCFyZWNpcGllbnRQdWJLZXlCNjQpIHsKICAgICAgICBhbGVydCgiUGxlYXNlIGVudGVyIHRoZSByZWNpcGllbnQncyBwdWJsaWMga2V5LiIpOwogICAgICAgIHJldHVybjsKICAgICAgfQoKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCByZWNpcGllbnRQdWJLZXkgPSB1bmI2NChyZWNpcGllbnRQdWJLZXlCNjQpOwoKICAgICAgICAvLyBHZW5lcmF0ZSBzaGFyZWQgc2VjcmV0CiAgICAgICAgY29uc3Qgc2hhcmVkU2VjcmV0ID0geDI1NTE5Lm1vZHVsZS5zaGFyZWRLZXkobXlQcml2YXRlS2V5LCByZWNpcGllbnRQdWJLZXkpOwoKICAgICAgICAvLyBEZXJpdmUgc2hhcmVkIGtleSB1c2luZyBoa2RmCiAgICAgICAgY29uc3Qgc2hhcmVkS2V5ID0gaGtkZi5tb2R1bGUuaGtkZigKICAgICAgICAgIHNoYXJlZFNlY3JldCwKICAgICAgICAgIHsKICAgICAgICAgICAgc2FsdDogc2FsdCwKICAgICAgICAgICAgaW5mbzogZW5jLmVuY29kZSgiQ2lwaGVyTGluay1LZXlEZXJpdmF0aW9uIiksCiAgICAgICAgICAgIGxlbmd0aDogMzIKICAgICAgICAgIH0sCiAgICAgICAgICBobWFjLm1vZHVsZS5tYWtlSG1hY1NoYTI1NkZuCiAgICAgICAgKTsKCiAgICAgICAgLy8gRW5jcnlwdCB0aGUgb3JpZ2luYWwgbWVzc2FnZSBrZXkKICAgICAgICBjb25zdCBpdiA9IHJhbmQoMTIpOwogICAgICAgIGNvbnN0IHsgY2lwaGVydGV4dCwgdGFnIH0gPSBhZXMyNTZnY20ubW9kdWxlLmFlczI1NkdjbUVuY3J5cHQoewogICAgICAgICAga2V5OiBzaGFyZWRLZXksCiAgICAgICAgICBpdjogaXYsCiAgICAgICAgICBwbGFpbnRleHQ6IGVuY3J5cHRpb25LZXkKICAgICAgICB9KTsKCiAgICAgICAgY29uc3QgZW5jcnlwdGVkS2V5RGF0YSA9IHsKICAgICAgICAgIGN0OiBiNjQoY2lwaGVydGV4dCksCiAgICAgICAgICBpdjogYjY0KGl2KSwKICAgICAgICAgIHRhZzogYjY0KHRhZykKICAgICAgICB9OwoKICAgICAgICAkKCIjZW5jcnlwdGVkLWtleSIpLnRleHRDb250ZW50ID0gSlNPTi5zdHJpbmdpZnkoZW5jcnlwdGVkS2V5RGF0YSk7CiAgICAgICAgJCgiI2VuY3J5cHRlZC1rZXktb3V0cHV0IikuY2xhc3NMaXN0LnJlbW92ZSgiaGlkZGVuIik7CgogICAgICAgIC8vIENsZWFuIHVwIHNlbnNpdGl2ZSBkYXRhCiAgICAgICAgLy8gbXlQcml2YXRlS2V5LmZpbGwoMCk7CiAgICAgICAgc2hhcmVkU2VjcmV0LmZpbGwoMCk7CiAgICAgICAgc2hhcmVkS2V5LmZpbGwoMCk7CgogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBhbGVydChgRXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7CiAgICAgIH0KICAgIH0pOwoKICAgICQoIiNjb3B5LWVuY3J5cHRlZC1rZXkiKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgY29uc3Qga2V5ID0gJCgiI2VuY3J5cHRlZC1rZXkiKS50ZXh0Q29udGVudDsKICAgICAgaWYgKGtleSkgY29weVRvQ2xpcGJvYXJkKGtleSwgJCgiI2NvcHktZW5jcnlwdGVkLWtleSIpKTsKICAgIH0pOwoKICA8L3NjcmlwdD4KPC9ib2R5PgoKPC9odG1sPg==
```

## Implemenation Notes

- Crypto was all self implemented in js, because there's no crypto.subtle in the data url context in browsers. I could have used an audited implementation, but this is for fun. Theres is a small test script that does a few simple sanity checks. To keep the sharable link small I would need to strip out just the code I need from an audited implementation. Or I could try build a minimal wasm package using a c or rust implementation.
- I wanted to try data url to see if this would work. An alternative would have been making an html file. That would still be pretty easy to share, and crypto.subtle is available when you open a local html file, so no js crypto needed. Since it would be sent as a file rather than cumbersome text, I could embed a much larger secret, like entire files. I might try it later if this project gets any interest.
- It would be cool to write this as a quine, so someone who receives a message could then send their own message. But it's better to link them to somewhere to get the trusted intitial data url.

## Key exchange
A random key `messageKey` is generated to encrypt the sender's message `m` into ciphertext `ct` with aes-256 gcm. A x25519 keypair is then generated `privA` and `pubA` as well as a salt `s`. `s`, `pubA`, `ct` are sent to the recipient. The recipient generates their own x25519 keypair `privB` and `pubB`, and send `pubB` to the sender. The sender derives the `sharedSecret` and uses the salt and hkdf to get the `sharedKey`, then uses aes-256 gcm to encrypt `messageKey` with `sharedKey` to make `messageKeyEncrypted`. They send `messageKeyEncrypted` to the recipient. The recipient also generates `sharedKey` and decryts `messageKeyEncrypted` to get `messageKey` then decrypts the `ct` to get `m`.

- This schema allows the secret payload to be in the data url. Using 2 channels in necessary since a mitm could simply change the recipients public key for their own.
- I'm unsure if the salt should be sent in the first step, or second.
- I need some form of authentication. Given the inital sending of the data url should happen over a different chanel, I can send a secret that can be used to authenticate the key exchange. It will provide warnings if something is wrong. This is a todo. Without this, if the sender responds to a mitm on the second channel, the mitm could then attempt to get `ct` at a later date and find `m`.


## Password
It uses 500k iters of pbkdf2 on the password. It then uses aes-256 gcm to encrypt the message.

- There's no point sending the url and password over the same channel. You're sending plain text at that point.
- I used pbkdf2 even though it's old as that's whats in subtle, and it's way easier than argon2 to make.

## Build
- The script is in python so no one needs to stuff around with npm. I wanted to avoid requiring installs. The crypto test file requires node to run it (or maybe just a browser console).
- The weird moduling system is so it's easy to build with just python, and so I can avoid the same script appearing in encode and decode templates. The tag lets me copy the code and saves space in the encode url. It was a quick hack, might be better as a iife module not sure.