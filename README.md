# CipherLink - Self contained data url based secret sharing tool

## Overview

This tool lets you share secret with a password or key with zero infrastructure and only requires a browser. It doesnt even require a network connection. It is not audited, and just for fun, I make no guarentees on security and take no responsibility anything you do with it.

## How to use

Build it by running build.py. Or use the build output url at the end of this readme. Input your secret message, and a password and generate a shareable url (it will be big). Send that url to the recipient. Then, on a different channel, send the password. Eg, send the data url by email, and password on whatsapp, set to disappear. Always build the url yourself or get it from this readme.

## Security Notes

- Crypto was all re-implemented in js, because there's no crypto.subtle in the data url context in browsers. Yes, I could have used an audited implementation, but this is for fun. Theres is a small test script that does a few simple sanity checks.
- There's no point sending the url and password over the same channel. You're sending plain text at that point.
- It would be cool to write this as a quine, so someone who receives a message could then send their own message. But it's better to link them to somewhere to get the trusted intitial data url.

# URL
Copy this url into your browser bar to use the tool:
```url
data:text/html;base64,PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsaW5pdGlhbC1zY2FsZT0xIiAvPgo8dGl0bGU+Q2lwaGVyTGluazwvdGl0bGU+CjxzdHlsZT4KICBib2R5IHsKICAgIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIFNlZ29lIFVJLCBSb2JvdG8sIEFyaWFsLCBzYW5zLXNlcmlmOwogICAgbWFyZ2luOiAycmVtOwogICAgbGluZS1oZWlnaHQ6IDEuNAogIH0KCiAgdGV4dGFyZWEgewogICAgd2lkdGg6IDEwMCU7CiAgICBtaW4taGVpZ2h0OiA4cmVtCiAgfQoKICBpbnB1dCwKICBidXR0b24sCiAgdGV4dGFyZWEgewogICAgZm9udDogaW5oZXJpdDsKICAgIHBhZGRpbmc6IC41cmVtOwogICAgYm9yZGVyOiAxcHggc29saWQgI2NjYzsKICAgIGJvcmRlci1yYWRpdXM6IC40cmVtCiAgfQoKICBidXR0b24gewogICAgY3Vyc29yOiBwb2ludGVyCiAgfQoKICAucm93IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IC41cmVtOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIG1hcmdpbjogLjVyZW0gMAogIH0KCiAgLm91dCB7CiAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgICBib3JkZXI6IDFweCBkYXNoZWQgI2RkZDsKICAgIHBhZGRpbmc6IDFyZW07CiAgICBib3JkZXItcmFkaXVzOiAuNXJlbTsKICAgIGJhY2tncm91bmQ6ICNmYWZhZmE7CiAgICB3b3JkLWJyZWFrOiBicmVhay1hbGwKICB9Cjwvc3R5bGU+Cgo8Ym9keT4KICA8aDE+Q2lwaGVyTGluazwvaDE+CiAgPHA+U2VuZCBzZWNyZXRzIHdpdGggYSBTZWxmLWNvbnRhaW5lZCBkYXRhIFVSTCB1c2luZyBQQktERjIgKyBBRVMtR0NNLjwvcD4KICA8cD4KICAgIDxzdHJvbmc+V2FybmluZzo8L3N0cm9uZz4gVXNlIHRoaXMgdG9vbCBhdCB5b3VyIG93biByaXNrLiBBbHdheXMgZW5zdXJlIHlvdSBnb3QgdGhlIGxpbmsgZnJvbQogICAgPGEgaHJlZj0iaHR0cHM6Ly9naXRodWIuY29tL2hpbGxhYy9DaXBoZXJMaW5rIj5odHRwczovL2dpdGh1Yi5jb20vaGlsbGFjL0NpcGhlckxpbms8L2E+IGFuZCB2ZXQgdGhlIGNvZGUgeW91cnNlbGYuCiAgPC9wPgogIDxwPk1ha2Ugc3VyZSB0byB1c2UgYSBzdHJvbmcgcGFzc3dvcmQuIFRoaXMgdG9vbCBkb2VzIG5vdCBlbmZvcmNlIGFueSBwYXNzd29yZCBzdHJlbmd0aCByZXF1aXJlbWVudHMuPC9wPgogIDxwPk1ha2Ugc3VyZSB5b3Ugc2VuZCB0aGUgcGFzc3dvcmQgb3ZlciBhIGRpZmZlcmVudCBjaGFubmVsIHRvIHRoZSBkYXRhIHVybC4gT3IgZWxzZSB5b3UncmUganVzdCBzZW5kaW5nIHBsYWluIHRleHQuCiAgICBFZyBzZW5kIGRhdGEgdXJsIG9uIGVtYWlsIGFuZCBwYXNzd29yZCBvbiB3aGF0c2FwcCBhcyBhIGRpc2FwcGVlcmluZyBtZXNzYWdlLjwvcD4KCiAgPGxhYmVsPlNlY3JldDwvbGFiZWw+CiAgPHRleHRhcmVhIGlkPSJzZWNyZXQiIHBsYWNlaG9sZGVyPSJUeXBlIHlvdXIgc2VjcmV0IGhlcmUuLi4iPjwvdGV4dGFyZWE+CgogIDxkaXYgY2xhc3M9InJvdyI+CiAgICA8bGFiZWwgZm9yPSJwdyI+UGFzc3dvcmQ6PC9sYWJlbD4KICAgIDxpbnB1dCBpZD0icHciIHR5cGU9InBhc3N3b3JkIiBwbGFjZWhvbGRlcj0iUGFzc3dvcmQiIC8+CiAgICA8YnV0dG9uIGlkPSJnZW5lcmF0ZS1wdyI+R2VuIHN0cm9uZyBwYXNzd29yZDwvYnV0dG9uPgogIDwvZGl2PgogIDxidXR0b24gaWQ9ImdvIj5FbmNyeXB0IG1lc3NhZ2U8L2J1dHRvbj4KCiAgPGgzPk91dHB1dDwvaDM+CiAgPGRpdiBjbGFzcz0icm93Ij4KICAgIDxidXR0b24gaWQ9ImNvcHktcHciIHR5cGU9ImJ1dHRvbiIgY2xhc3M9ImNvcHktYnRuIiBzdHlsZT0ibWFyZ2luLWxlZnQ6IDAuNXJlbTsiPkNvcHkgUGFzc3dvcmQ8L2J1dHRvbj4KICAgIDxidXR0b24gaWQ9ImNvcHktdXJsIiBjbGFzcz0iY29weS1idG4iIHN0eWxlPSJkaXNwbGF5OiBub25lOyI+Q29weSBVUkw8L2J1dHRvbj4KICA8L2Rpdj4KCiAgPGRpdiBpZD0idXJsIiBjbGFzcz0ib3V0Ij48L2Rpdj4KCiAgPHRlbXBsYXRlIGlkPSJkZWNvZGUtdGVtcGxhdGUiPgogICAgPCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CjxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsaW5pdGlhbC1zY2FsZT0xIiAvPgo8dGl0bGU+Q2lwaGVyTGluazwvdGl0bGU+CjxzdHlsZT4KICAgIGJvZHkgewogICAgICAgIGZvbnQtZmFtaWx5OiBzeXN0ZW0tdWksIFNlZ29lIFVJLCBSb2JvdG8sIEFyaWFsLCBzYW5zLXNlcmlmOwogICAgICAgIG1hcmdpbjogMnJlbTsKICAgICAgICBsaW5lLWhlaWdodDogMS40CiAgICB9CgogICAgaW5wdXQsCiAgICBidXR0b24sCiAgICB0ZXh0YXJlYSB7CiAgICAgICAgZm9udDogaW5oZXJpdDsKICAgICAgICBwYWRkaW5nOiAuNXJlbTsKICAgICAgICBib3JkZXI6IDFweCBzb2xpZCAjY2NjOwogICAgICAgIGJvcmRlci1yYWRpdXM6IC40cmVtCiAgICB9CgogICAgYnV0dG9uIHsKICAgICAgICBjdXJzb3I6IHBvaW50ZXIKICAgIH0KCiAgICAucm93IHsKICAgICAgICBkaXNwbGF5OiBmbGV4OwogICAgICAgIGdhcDogLjVyZW07CiAgICAgICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgICAgICBtYXJnaW46IC41cmVtIDAKICAgIH0KCiAgICAub3V0IHsKICAgICAgICB3aGl0ZS1zcGFjZTogcHJlLXdyYXA7CiAgICAgICAgYm9yZGVyOiAxcHggZGFzaGVkICNkZGQ7CiAgICAgICAgcGFkZGluZzogMXJlbTsKICAgICAgICBib3JkZXItcmFkaXVzOiAuNXJlbTsKICAgICAgICBiYWNrZ3JvdW5kOiAjZmFmYWZhCiAgICB9Cjwvc3R5bGU+Cgo8Ym9keT4KICAgIDxoMT5DaXBoZXJMaW5rPC9oMT4KICAgIDxwPkVudGVyIHBhc3N3b3JkIHRvIGRlY3J5cHQ8L3A+CiAgICA8Zm9ybSBpZD0iZm9ybSI+CiAgICAgICAgPGRpdiBjbGFzcz0icm93Ij4KICAgICAgICAgICAgPGlucHV0IGlkPSJwdyIgdHlwZT0icGFzc3dvcmQiIHBsYWNlaG9sZGVyPSJQYXNzd29yZCIgcmVxdWlyZWQgLz4KICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPSJzdWJtaXQiPkRlY3J5cHQ8L2J1dHRvbj4KICAgICAgICA8L2Rpdj4KICAgIDwvZm9ybT4KICAgIDxkaXYgaWQ9InN0YXR1cyI+PC9kaXY+CiAgICA8cCBpZD0iYWR2ZXJ0IiBzdHlsZT0iZGlzcGxheTogbm9uZTsiPklmIHlvdSB3YW50IHRvIHVzZSB0aGlzIHRvb2wgdG8gc2VuZCBzZWNyZXRzIHlvdXJzZWxmLCBnbyB0byA8YQogICAgICAgICAgICBocmVmPSJodHRwczovL2dpdGh1Yi5jb20vaGlsbGFjL0NpcGhlckxpbmsiPmh0dHBzOi8vZ2l0aHViLmNvbS9oaWxsYWMvQ2lwaGVyTGluazwvYT48L3A+CgogICAgPGgzPlJlc3VsdDwvaDM+CiAgICA8ZGl2IGlkPSJvdXQiIGNsYXNzPSJvdXQiPjwvZGl2PgoKICAgIDxzY3JpcHQgdHlwZT0ibW9kdWxlLXNvdXJjZSIgaWQ9ImFlczI1NmdjbS1zY3JpcHQiPgogICAgICAgIF9fSU5DTFVERV9BRVMyNTZHQ01fSlNfMl9fCiAgICA8L3NjcmlwdD4KCiAgICA8c2NyaXB0IHR5cGU9Im1vZHVsZS1zb3VyY2UiIGlkPSJwYmtkZjItc2NyaXB0Ij4KICAgICAgICBfX0lOQ0xVREVfUEJLREYyX0pTXzJfXwogICAgPC9zY3JpcHQ+CgogICAgPHNjcmlwdCB0eXBlPSJtb2R1bGUiPgogICAgICAgIGNvbnN0ICQgPSAocykgPT4gZG9jdW1lbnQucXVlcnlTZWxlY3RvcihzKTsKCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gbG9hZElubGluZU1vZHVsZShpZCkgewogICAgICAgICAgICBjb25zdCBjb2RlID0gJCgnIycgKyBpZCkudGV4dENvbnRlbnQ7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW2NvZGVdLCB7IHR5cGU6ICd0ZXh0L2phdmFzY3JpcHQnIH0pKTsKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGltcG9ydCh1cmwpOwogICAgICAgIH0KCiAgICAgICAgY29uc3QgYWVzMjU2Z2NtID0gYXdhaXQgbG9hZElubGluZU1vZHVsZSgnYWVzMjU2Z2NtLXNjcmlwdCcpOwogICAgICAgIGNvbnN0IHBia2RmMiA9IGF3YWl0IGxvYWRJbmxpbmVNb2R1bGUoJ3Bia2RmMi1zY3JpcHQnKTsKCiAgICAgICAgLy8gPT09IEZpbGxlZCBieSB0aGUgZ2VuZXJhdG9yID09PQogICAgICAgIGNvbnN0IENJUEhFUlRFWFRfQjY0ID0gIl9fQ0lQSEVSVEVYVF9CNjRfXyI7CiAgICAgICAgY29uc3QgSVZfQjY0ID0gIl9fSVZfQjY0X18iOwogICAgICAgIGNvbnN0IFNBTFRfQjY0ID0gIl9fU0FMVF9CNjRfXyI7CiAgICAgICAgY29uc3QgVEFHX0I2NCA9ICJfX1RBR19CNjRfXyI7CiAgICAgICAgY29uc3QgSVRFUkFUSU9OUyA9IF9fSVRFUkFUSU9OU19fOwoKICAgICAgICBjb25zdCBlbmMgPSBuZXcgVGV4dEVuY29kZXIoKTsKICAgICAgICBjb25zdCBkZWMgPSBuZXcgVGV4dERlY29kZXIoKTsKCiAgICAgICAgY29uc3QgYjY0VG9CeXRlcyA9IChiNjQpID0+IFVpbnQ4QXJyYXkuZnJvbShhdG9iKGI2NCksIGMgPT4gYy5jaGFyQ29kZUF0KDApKTsKCiAgICAgICAgYXN5bmMgZnVuY3Rpb24gZGVjcnlwdFNlY3JldChwYXNzd29yZCkgewogICAgICAgICAgICBjb25zdCBzYWx0ID0gYjY0VG9CeXRlcyhTQUxUX0I2NCk7CiAgICAgICAgICAgIGNvbnN0IGl2ID0gYjY0VG9CeXRlcyhJVl9CNjQpOwogICAgICAgICAgICBjb25zdCBjaXBoZXJ0ZXh0ID0gYjY0VG9CeXRlcyhDSVBIRVJURVhUX0I2NCk7CiAgICAgICAgICAgIGNvbnN0IHRhZyA9IGI2NFRvQnl0ZXMoVEFHX0I2NCk7CgogICAgICAgICAgICAvLyBEZXJpdmUga2V5IHVzaW5nIHB1cmUgSlMgUEJLREYyCiAgICAgICAgICAgIGNvbnN0IGtleSA9IHBia2RmMi5wYmtkZjJTaGEyNTYoewogICAgICAgICAgICAgICAgcGFzc3dvcmQ6IGVuYy5lbmNvZGUocGFzc3dvcmQpLAogICAgICAgICAgICAgICAgc2FsdDogc2FsdCwKICAgICAgICAgICAgICAgIGl0ZXJhdGlvbnM6IElURVJBVElPTlMsCiAgICAgICAgICAgICAgICBka0xlbjogMzIgLy8gMjU2IGJpdHMgZm9yIEFFUy0yNTYKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgLy8gRGVjcnlwdCB1c2luZyBBRVMtR0NNCiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBhZXMyNTZnY20uYWVzMjU2R2NtRGVjcnlwdCh7CiAgICAgICAgICAgICAgICAgICAga2V5OiBrZXksCiAgICAgICAgICAgICAgICAgICAgaXY6IGl2LAogICAgICAgICAgICAgICAgICAgIGNpcGhlcnRleHQ6IGNpcGhlcnRleHQsCiAgICAgICAgICAgICAgICAgICAgdGFnOiB0YWcKICAgICAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgICAgIGlmICghcmVzdWx0Lm9rKSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJEZWNyeXB0aW9uIGZhaWxlZCIpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiBkZWMuZGVjb2RlKHJlc3VsdC5wbGFpbnRleHQpOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkRlY3J5cHRpb24gZmFpbGVkICh3cm9uZyBwYXNzd29yZCBvciBjb3JydXB0ZWQgZGF0YSkuIik7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICQoIiNmb3JtIikuYWRkRXZlbnRMaXN0ZW5lcigic3VibWl0IiwgYXN5bmMgKGUpID0+IHsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCBzdGF0dXMgPSAkKCIjc3RhdHVzIik7CiAgICAgICAgICAgIGNvbnN0IG91dCA9ICQoIiNvdXQiKTsKICAgICAgICAgICAgc3RhdHVzLnRleHRDb250ZW50ID0gIkRlY3J5cHRpbmcuLi4iOwogICAgICAgICAgICBvdXQudGV4dENvbnRlbnQgPSAiIjsKICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgIGNvbnN0IHB3ID0gJCgiI3B3IikudmFsdWU7CiAgICAgICAgICAgICAgICBjb25zdCBwbGFpbnRleHQgPSBhd2FpdCBkZWNyeXB0U2VjcmV0KHB3KTsKICAgICAgICAgICAgICAgIG91dC50ZXh0Q29udGVudCA9IHBsYWludGV4dDsKICAgICAgICAgICAgICAgIHN0YXR1cy50ZXh0Q29udGVudCA9ICJTdWNjZXNzLiI7CiAgICAgICAgICAgICAgICAkKCIjYWR2ZXJ0Iikuc3R5bGUuZGlzcGxheSA9ICJibG9jayI7CiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewogICAgICAgICAgICAgICAgc3RhdHVzLnRleHRDb250ZW50ID0gZXJyLm1lc3NhZ2U7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIDwvc2NyaXB0Pgo8L2JvZHk+Cgo8L2h0bWw+CiAgPC90ZW1wbGF0ZT4KCiAgPCEtLSBub25zZW5zZSB0eXBlIHRvIGF2b2lkIGV4ZWN1dGlvbiAtLT4KICA8c2NyaXB0IHR5cGU9Im1vZHVsZS1zb3VyY2UiIGlkPSJhZXMyNTZnY20tc2NyaXB0Ij4KICAgIAoKCgpjb25zdCBSID0gMHhlMTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMG47IAoKZnVuY3Rpb24gdG9VOCh2KSB7CiAgcmV0dXJuIHYgaW5zdGFuY2VvZiBVaW50OEFycmF5ID8gdiA6IG5ldyBVaW50OEFycmF5KHYpOwp9CmZ1bmN0aW9uIHhvckJ5dGVzKGEsIGIpIHsKICBjb25zdCBvdXQgPSBuZXcgVWludDhBcnJheShhLmxlbmd0aCk7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSBvdXRbaV0gPSBhW2ldIF4gYltpXTsKICByZXR1cm4gb3V0Owp9CmZ1bmN0aW9uIHplcm8obikgewogIHJldHVybiBuZXcgVWludDhBcnJheShuKTsKfQoKZnVuY3Rpb24gYnl0ZXNUb0JpZ0ludEJFKGIpIHsKICBsZXQgeCA9IDBuOwogIGZvciAobGV0IGkgPSAwOyBpIDwgYi5sZW5ndGg7IGkrKykgeCA9ICh4IDw8IDhuKSB8IEJpZ0ludChiW2ldKTsKICByZXR1cm4geDsKfQpmdW5jdGlvbiBiaWdJbnRUb0J5dGVzQkUoeCwgbGVuKSB7CiAgY29uc3Qgb3V0ID0gbmV3IFVpbnQ4QXJyYXkobGVuKTsKICBmb3IgKGxldCBpID0gbGVuIC0gMTsgaSA+PSAwOyBpLS0pIHsKICAgIG91dFtpXSA9IE51bWJlcih4ICYgMHhmZm4pOwogICAgeCA+Pj0gOG47CiAgfQogIHJldHVybiBvdXQ7Cn0KCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKY29uc3QgYjY0VG9VOCA9IChiNjQpID0+IFVpbnQ4QXJyYXkuZnJvbShhdG9iKGI2NCksIChjKSA9PiBjLmNoYXJDb2RlQXQoMCkpOwoKY29uc3QgUyA9IGI2NFRvVTgoCiAgIlkzeDNlL0pyYjhVd0FXY3IvdGVyZHNxQ3lYMzZXVWZ3cmRTaXI1eWtjc0MzL1pNbU5qLzN6RFNsNWZGeDJERVZCTWNqd3hpV0Jab0hFb0RpNnlleWRRbURMQm9iYmxxZ1VqdldzeW5qTDRSVDBRRHRJUHl4VzJyTHZqbEtURmpQME8rcSswTk5NNFZGK1FKL1VEeWZxRkdqUUkrU25UajF2TGJhSVJELzg5TE5EQlBzWDVkRUY4U25majFrWFJsellJRlAzQ0lxa0loRzdyZ1UzbDRMMitBeU9ncEpCaVJjd3RPc1lwR1Y1SG5ueURkdGpkVk9xV3hXOU9wbGVxNEl1bmdsTGh5bXRNYm8zWFFmUzcyTGluQSt0V1pJQS9ZT1lUVlh1WWJCSFo3aCtKZ1JhZG1PbEpzZWgrbk9WU2pmaktHSkRiL21RbWhCbVMwUHNGUzdGZz09IgopOwpjb25zdCBSY29uID0gYjY0VG9VOCgiQUFFQ0JBZ1FJRUNBR3paczJLdE5tZz09Iik7CgpmdW5jdGlvbiByb3RXb3JkKHcpIHsKICByZXR1cm4gW3dbMV0sIHdbMl0sIHdbM10sIHdbMF1dOwp9CmZ1bmN0aW9uIHN1YldvcmQodykgewogIHJldHVybiB3Lm1hcCgoeCkgPT4gU1t4XSk7Cn0KCmZ1bmN0aW9uIGtleUV4cGFuZDI1NihrZXkpIHsKICBrZXkgPSB0b1U4KGtleSk7CiAgaWYgKGtleS5sZW5ndGggIT09IDMyKSB0aHJvdyBuZXcgRXJyb3IoIkFFUy0yNTYga2V5IG11c3QgYmUgMzIgYnl0ZXMiKTsKCiAgY29uc3QgTmsgPSA4LAogICAgTmIgPSA0LAogICAgTnIgPSAxNDsKICBjb25zdCB3ID0gbmV3IFVpbnQ4QXJyYXkoTmIgKiAoTnIgKyAxKSAqIDQpOwogIHcuc2V0KGtleSk7CiAgY29uc3QgdGVtcCA9IFswLCAwLCAwLCAwXTsKICBsZXQgYnl0ZXNHZW5lcmF0ZWQgPSAzMjsKICBsZXQgcmNvbkl0ZXIgPSAxOwoKICB3aGlsZSAoYnl0ZXNHZW5lcmF0ZWQgPCB3Lmxlbmd0aCkgewogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA0OyBpKyspIHRlbXBbaV0gPSB3W2J5dGVzR2VuZXJhdGVkIC0gNCArIGldOwogICAgaWYgKChieXRlc0dlbmVyYXRlZCAvIDQpICUgTmsgPT09IDApIHsKICAgICAgbGV0IHQgPSByb3RXb3JkKHRlbXApOwogICAgICB0ID0gc3ViV29yZCh0KTsKICAgICAgdFswXSBePSBSY29uW3Jjb25JdGVyKytdOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgdGVtcFtpXSA9IHRbaV07CiAgICB9IGVsc2UgaWYgKChieXRlc0dlbmVyYXRlZCAvIDQpICUgTmsgPT09IDQpIHsKICAgICAgbGV0IHQgPSBzdWJXb3JkKHRlbXApOwogICAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgdGVtcFtpXSA9IHRbaV07CiAgICB9CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IDQ7IGkrKykgewogICAgICB3W2J5dGVzR2VuZXJhdGVkXSA9IHdbYnl0ZXNHZW5lcmF0ZWQgLSAzMl0gXiB0ZW1wW2ldOwogICAgICBieXRlc0dlbmVyYXRlZCsrOwogICAgfQogIH0KICByZXR1cm4gdzsgCn0KCmZ1bmN0aW9uIGFkZFJvdW5kS2V5KHMsIHJrLCByb3VuZCkgewogIGZvciAobGV0IGMgPSAwOyBjIDwgNDsgYysrKSB7CiAgICBzWzAgKyA0ICogY10gXj0gcmtbcm91bmQgKiAxNiArIDQgKiBjICsgMF07CiAgICBzWzEgKyA0ICogY10gXj0gcmtbcm91bmQgKiAxNiArIDQgKiBjICsgMV07CiAgICBzWzIgKyA0ICogY10gXj0gcmtbcm91bmQgKiAxNiArIDQgKiBjICsgMl07CiAgICBzWzMgKyA0ICogY10gXj0gcmtbcm91bmQgKiAxNiArIDQgKiBjICsgM107CiAgfQp9CmZ1bmN0aW9uIHN1YkJ5dGVzKHMpIHsKICBmb3IgKGxldCBpID0gMDsgaSA8IDE2OyBpKyspIHNbaV0gPSBTW3NbaV1dOwp9CmZ1bmN0aW9uIHNoaWZ0Um93cyhzKSB7CiAgY29uc3QgdCA9IHMuc2xpY2UoKTsKICBzWzFdID0gdFs1XTsKICBzWzVdID0gdFs5XTsKICBzWzldID0gdFsxM107CiAgc1sxM10gPSB0WzFdOwogIHNbMl0gPSB0WzEwXTsKICBzWzZdID0gdFsxNF07CiAgc1sxMF0gPSB0WzJdOwogIHNbMTRdID0gdFs2XTsKICBzWzNdID0gdFsxNV07CiAgc1s3XSA9IHRbM107CiAgc1sxMV0gPSB0WzddOwogIHNbMTVdID0gdFsxMV07Cn0KZnVuY3Rpb24geHRpbWUoeCkgewogIHJldHVybiAoKHggPDwgMSkgXiAoeCAmIDB4ODAgPyAweDFiIDogMCkpICYgMHhmZjsKfQpmdW5jdGlvbiBtaXhDb2x1bW5zKHMpIHsKICBmb3IgKGxldCBjID0gMDsgYyA8IDQ7IGMrKykgewogICAgY29uc3QgaSA9IDQgKiBjOwogICAgY29uc3QgYTAgPSBzW2ldLAogICAgICBhMSA9IHNbaSArIDFdLAogICAgICBhMiA9IHNbaSArIDJdLAogICAgICBhMyA9IHNbaSArIDNdOwogICAgY29uc3QgcjAgPSB4dGltZShhMCkgXiAoYTEgXiB4dGltZShhMSkpIF4gYTIgXiBhMzsKICAgIGNvbnN0IHIxID0gYTAgXiB4dGltZShhMSkgXiAoYTIgXiB4dGltZShhMikpIF4gYTM7CiAgICBjb25zdCByMiA9IGEwIF4gYTEgXiB4dGltZShhMikgXiAoYTMgXiB4dGltZShhMykpOwogICAgY29uc3QgcjMgPSBhMCBeIHh0aW1lKGEwKSBeIGExIF4gYTIgXiB4dGltZShhMyk7CiAgICBzW2ldID0gcjAgJiAweGZmOwogICAgc1tpICsgMV0gPSByMSAmIDB4ZmY7CiAgICBzW2kgKyAyXSA9IHIyICYgMHhmZjsKICAgIHNbaSArIDNdID0gcjMgJiAweGZmOwogIH0KfQpmdW5jdGlvbiBhZXNFbmNyeXB0QmxvY2socmssIGJsb2NrMTYpIHsKICBjb25zdCBOciA9IDE0OwogIGNvbnN0IHMgPSBuZXcgVWludDhBcnJheShibG9jazE2KTsKICBhZGRSb3VuZEtleShzLCByaywgMCk7CiAgZm9yIChsZXQgcm91bmQgPSAxOyByb3VuZCA8IE5yOyByb3VuZCsrKSB7CiAgICBzdWJCeXRlcyhzKTsKICAgIHNoaWZ0Um93cyhzKTsKICAgIG1peENvbHVtbnMocyk7CiAgICBhZGRSb3VuZEtleShzLCByaywgcm91bmQpOwogIH0KICBzdWJCeXRlcyhzKTsKICBzaGlmdFJvd3Mocyk7CiAgYWRkUm91bmRLZXkocywgcmssIE5yKTsKICByZXR1cm4gczsKfQoKCmZ1bmN0aW9uIGluYzMyKGNvdW50ZXIxNikgewogIGNvbnN0IG91dCA9IGNvdW50ZXIxNi5zbGljZSgpOwogIAogIGxldCBjYXJyeSA9IDE7CiAgZm9yIChsZXQgaSA9IDE1OyBpID49IDEyOyBpLS0pIHsKICAgIGNvbnN0IHYgPSAob3V0W2ldIHwgMCkgKyBjYXJyeTsKICAgIG91dFtpXSA9IHYgJiAweGZmOwogICAgY2FycnkgPSB2ID4+PiA4OwogICAgaWYgKCFjYXJyeSkgYnJlYWs7CiAgfQogIHJldHVybiBvdXQ7Cn0KCgpmdW5jdGlvbiBnaGFzaE11bHRpcGx5KHgxMjgsIHkxMjgpIHsKICBsZXQgWiA9IDBuOwogIGxldCBWID0geTEyODsKICBmb3IgKGxldCBpID0gMDsgaSA8IDEyODsgaSsrKSB7CiAgICBjb25zdCBiaXQgPSAoeDEyOCA+PiBCaWdJbnQoMTI3IC0gaSkpICYgMW47CiAgICBpZiAoYml0KSBaIF49IFY7CiAgICBpZiAoKFYgJiAxbikgPT09IDBuKSB7CiAgICAgIFYgPj49IDFuOwogICAgfSBlbHNlIHsKICAgICAgViA9IChWID4+IDFuKSBeIFI7CiAgICB9CiAgfQogIHJldHVybiBaOwp9CgpmdW5jdGlvbiBnaGFzaChILCBBLCBDKSB7CiAgCiAgZnVuY3Rpb24gcGFkMTYodTgpIHsKICAgIGNvbnN0IHJlbSA9IHU4Lmxlbmd0aCAlIDE2OwogICAgcmV0dXJuIHJlbSA/IG5ldyBVaW50OEFycmF5KFsuLi51OCwgLi4ubmV3IFVpbnQ4QXJyYXkoMTYgLSByZW0pXSkgOiB1ODsKICB9CiAgY29uc3QgQV8gPSBwYWQxNihBKTsKICBjb25zdCBDXyA9IHBhZDE2KEMpOwoKICBsZXQgWSA9IDBuOwogIGNvbnN0IEhuID0gYnl0ZXNUb0JpZ0ludEJFKEgpOwoKICBmb3IgKGxldCBvZmYgPSAwOyBvZmYgPCBBXy5sZW5ndGg7IG9mZiArPSAxNikgewogICAgY29uc3QgWGkgPSBieXRlc1RvQmlnSW50QkUoQV8uc3ViYXJyYXkob2ZmLCBvZmYgKyAxNikpOwogICAgWSA9IGdoYXNoTXVsdGlwbHkoWSBeIFhpLCBIbik7CiAgfQogIGZvciAobGV0IG9mZiA9IDA7IG9mZiA8IENfLmxlbmd0aDsgb2ZmICs9IDE2KSB7CiAgICBjb25zdCBYaSA9IGJ5dGVzVG9CaWdJbnRCRShDXy5zdWJhcnJheShvZmYsIG9mZiArIDE2KSk7CiAgICBZID0gZ2hhc2hNdWx0aXBseShZIF4gWGksIEhuKTsKICB9CgogIGNvbnN0IGxlbkJsb2NrID0gbmV3IFVpbnQ4QXJyYXkoMTYpOwogIGNvbnN0IGFCaXRzID0gQmlnSW50KEEubGVuZ3RoKSAqIDhuOwogIGNvbnN0IGNCaXRzID0gQmlnSW50KEMubGVuZ3RoKSAqIDhuOwogIGxlbkJsb2NrLnNldChiaWdJbnRUb0J5dGVzQkUoYUJpdHMsIDgpLCAwKTsKICBsZW5CbG9jay5zZXQoYmlnSW50VG9CeXRlc0JFKGNCaXRzLCA4KSwgOCk7CgogIFkgPSBnaGFzaE11bHRpcGx5KFkgXiBieXRlc1RvQmlnSW50QkUobGVuQmxvY2spLCBIbik7CiAgcmV0dXJuIGJpZ0ludFRvQnl0ZXNCRShZLCAxNik7Cn0KCmZ1bmN0aW9uIGdjdHIocmssIGljYiwgaW5wdXQpIHsKICAKICBpZiAoaW5wdXQubGVuZ3RoID09PSAwKSByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoMCk7CiAgY29uc3Qgb3V0ID0gbmV3IFVpbnQ4QXJyYXkoaW5wdXQubGVuZ3RoKTsKICBsZXQgY3RyID0gaWNiLnNsaWNlKCk7CiAgZm9yIChsZXQgb2ZmID0gMDsgb2ZmIDwgaW5wdXQubGVuZ3RoOyBvZmYgKz0gMTYpIHsKICAgIGN0ciA9IGluYzMyKGN0cik7CiAgICBjb25zdCBrZXlzdHJlYW0gPSBhZXNFbmNyeXB0QmxvY2socmssIGN0cik7CiAgICBjb25zdCBjaHVuayA9IGlucHV0LnN1YmFycmF5KG9mZiwgTWF0aC5taW4ob2ZmICsgMTYsIGlucHV0Lmxlbmd0aCkpOwogICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjaHVuay5sZW5ndGg7IGkrKykgewogICAgICBvdXRbb2ZmICsgaV0gPSBjaHVua1tpXSBeIGtleXN0cmVhbVtpXTsKICAgIH0KICB9CiAgcmV0dXJuIG91dDsKfQoKCmV4cG9ydCBmdW5jdGlvbiBhZXMyNTZHY21FbmNyeXB0KHsKICBrZXksCiAgaXYsCiAgcGxhaW50ZXh0LAogIGFhZCA9IG5ldyBVaW50OEFycmF5KDApLAogIHRhZ0xlbmd0aCA9IDE2LAp9KSB7CiAga2V5ID0gdG9VOChrZXkpOwogIGl2ID0gdG9VOChpdik7CiAgcGxhaW50ZXh0ID0gdG9VOChwbGFpbnRleHQpOwogIGFhZCA9IHRvVTgoYWFkKTsKICBpZiAoa2V5Lmxlbmd0aCAhPT0gMzIpIHRocm93IG5ldyBFcnJvcigiQUVTLTI1NiBrZXkgbXVzdCBiZSAzMiBieXRlcyIpOwogIGlmICh0YWdMZW5ndGggIT09IDE2KQogICAgdGhyb3cgbmV3IEVycm9yKCJPbmx5IDEyOC1iaXQgdGFncyBzdXBwb3J0ZWQgaW4gdGhpcyByZWZlcmVuY2UiKTsKCiAgY29uc3QgcmsgPSBrZXlFeHBhbmQyNTYoa2V5KTsKICBjb25zdCBIID0gYWVzRW5jcnlwdEJsb2NrKHJrLCB6ZXJvKDE2KSk7IAoKICAKICBsZXQgSjA7CiAgaWYgKGl2Lmxlbmd0aCA9PT0gMTIpIHsKICAgIEowID0gbmV3IFVpbnQ4QXJyYXkoMTYpOwogICAgSjAuc2V0KGl2LCAwKTsKICAgIEowWzE1XSA9IDE7IAogIH0gZWxzZSB7CiAgICBjb25zdCBTID0gZ2hhc2goSCwgbmV3IFVpbnQ4QXJyYXkoMCksIGl2KTsKICAgIEowID0gUzsgCiAgfQoKICBjb25zdCBjaXBoZXJ0ZXh0ID0gZ2N0cihyaywgSjAsIHBsYWludGV4dCk7IAogIGNvbnN0IFMgPSBnaGFzaChILCBhYWQsIGNpcGhlcnRleHQpOwogIGNvbnN0IHRhZyA9IHhvckJ5dGVzKGFlc0VuY3J5cHRCbG9jayhyaywgSjApLCBTKS5zdWJhcnJheSgwLCB0YWdMZW5ndGgpOwoKICByZXR1cm4geyBjaXBoZXJ0ZXh0LCB0YWcgfTsKfQoKZXhwb3J0IGZ1bmN0aW9uIGFlczI1NkdjbURlY3J5cHQoewogIGtleSwKICBpdiwKICBjaXBoZXJ0ZXh0LAogIGFhZCA9IG5ldyBVaW50OEFycmF5KDApLAogIHRhZywKfSkgewogIGtleSA9IHRvVTgoa2V5KTsKICBpdiA9IHRvVTgoaXYpOwogIGNpcGhlcnRleHQgPSB0b1U4KGNpcGhlcnRleHQpOwogIGFhZCA9IHRvVTgoYWFkKTsKICB0YWcgPSB0b1U4KHRhZyk7CiAgaWYgKGtleS5sZW5ndGggIT09IDMyKSB0aHJvdyBuZXcgRXJyb3IoIkFFUy0yNTYga2V5IG11c3QgYmUgMzIgYnl0ZXMiKTsKICBpZiAodGFnLmxlbmd0aCAhPT0gMTYpCiAgICB0aHJvdyBuZXcgRXJyb3IoIk9ubHkgMTI4LWJpdCB0YWdzIHN1cHBvcnRlZCBpbiB0aGlzIHJlZmVyZW5jZSIpOwoKICBjb25zdCByayA9IGtleUV4cGFuZDI1NihrZXkpOwogIGNvbnN0IEggPSBhZXNFbmNyeXB0QmxvY2socmssIHplcm8oMTYpKTsKCiAgbGV0IEowOwogIGlmIChpdi5sZW5ndGggPT09IDEyKSB7CiAgICBKMCA9IG5ldyBVaW50OEFycmF5KDE2KTsKICAgIEowLnNldChpdiwgMCk7CiAgICBKMFsxNV0gPSAxOwogIH0gZWxzZSB7CiAgICBKMCA9IGdoYXNoKEgsIG5ldyBVaW50OEFycmF5KDApLCBpdik7CiAgfQoKICBjb25zdCBTID0gZ2hhc2goSCwgYWFkLCBjaXBoZXJ0ZXh0KTsKICBjb25zdCBleHBlY3RlZFRhZyA9IHhvckJ5dGVzKGFlc0VuY3J5cHRCbG9jayhyaywgSjApLCBTKS5zdWJhcnJheSgKICAgIDAsCiAgICB0YWcubGVuZ3RoCiAgKTsKCiAgCiAgaWYgKGV4cGVjdGVkVGFnLmxlbmd0aCAhPT0gdGFnLmxlbmd0aCkgcmV0dXJuIHsgb2s6IGZhbHNlLCBwbGFpbnRleHQ6IG51bGwgfTsKICBsZXQgZGlmZiA9IDA7CiAgZm9yIChsZXQgaSA9IDA7IGkgPCB0YWcubGVuZ3RoOyBpKyspIGRpZmYgfD0gZXhwZWN0ZWRUYWdbaV0gXiB0YWdbaV07CiAgaWYgKGRpZmYgIT09IDApIHJldHVybiB7IG9rOiBmYWxzZSwgcGxhaW50ZXh0OiBudWxsIH07CgogIGNvbnN0IHBsYWludGV4dCA9IGdjdHIocmssIEowLCBjaXBoZXJ0ZXh0KTsKICByZXR1cm4geyBvazogdHJ1ZSwgcGxhaW50ZXh0IH07Cn0KCiAgPC9zY3JpcHQ+CgogIDxzY3JpcHQgdHlwZT0ibW9kdWxlLXNvdXJjZSIgaWQ9InBia2RmMi1zY3JpcHQiPgogICAgCgoKY29uc3QgdG9VOCA9ICh2KSA9PiAodiBpbnN0YW5jZW9mIFVpbnQ4QXJyYXkgPyB2IDogbmV3IFVpbnQ4QXJyYXkodikpOwpjb25zdCBjb25jYXQgPSAoYSwgYikgPT4gewogIGNvbnN0IG91dCA9IG5ldyBVaW50OEFycmF5KGEubGVuZ3RoICsgYi5sZW5ndGgpOwogIG91dC5zZXQoYSwgMCk7CiAgb3V0LnNldChiLCBhLmxlbmd0aCk7CiAgcmV0dXJuIG91dDsKfTsKY29uc3QgaTMyYmUgPSAoeCkgPT4KICBuZXcgVWludDhBcnJheShbCiAgICAoeCA+Pj4gMjQpICYgMHhmZiwKICAgICh4ID4+PiAxNikgJiAweGZmLAogICAgKHggPj4+IDgpICYgMHhmZiwKICAgIHggJiAweGZmLAogIF0pOwoKCgpjb25zdCBLID0gbmV3IFVpbnQzMkFycmF5KFsKICAweDQyOGEyZjk4LCAweDcxMzc0NDkxLCAweGI1YzBmYmNmLCAweGU5YjVkYmE1LCAweDM5NTZjMjViLCAweDU5ZjExMWYxLAogIDB4OTIzZjgyYTQsIDB4YWIxYzVlZDUsIDB4ZDgwN2FhOTgsIDB4MTI4MzViMDEsIDB4MjQzMTg1YmUsIDB4NTUwYzdkYzMsCiAgMHg3MmJlNWQ3NCwgMHg4MGRlYjFmZSwgMHg5YmRjMDZhNywgMHhjMTliZjE3NCwgMHhlNDliNjljMSwgMHhlZmJlNDc4NiwKICAweDBmYzE5ZGM2LCAweDI0MGNhMWNjLCAweDJkZTkyYzZmLCAweDRhNzQ4NGFhLCAweDVjYjBhOWRjLCAweDc2Zjk4OGRhLAogIDB4OTgzZTUxNTIsIDB4YTgzMWM2NmQsIDB4YjAwMzI3YzgsIDB4YmY1OTdmYzcsIDB4YzZlMDBiZjMsIDB4ZDVhNzkxNDcsCiAgMHgwNmNhNjM1MSwgMHgxNDI5Mjk2NywgMHgyN2I3MGE4NSwgMHgyZTFiMjEzOCwgMHg0ZDJjNmRmYywgMHg1MzM4MGQxMywKICAweDY1MGE3MzU0LCAweDc2NmEwYWJiLCAweDgxYzJjOTJlLCAweDkyNzIyYzg1LCAweGEyYmZlOGExLCAweGE4MWE2NjRiLAogIDB4YzI0YjhiNzAsIDB4Yzc2YzUxYTMsIDB4ZDE5MmU4MTksIDB4ZDY5OTA2MjQsIDB4ZjQwZTM1ODUsIDB4MTA2YWEwNzAsCiAgMHgxOWE0YzExNiwgMHgxZTM3NmMwOCwgMHgyNzQ4Nzc0YywgMHgzNGIwYmNiNSwgMHgzOTFjMGNiMywgMHg0ZWQ4YWE0YSwKICAweDViOWNjYTRmLCAweDY4MmU2ZmYzLCAweDc0OGY4MmVlLCAweDc4YTU2MzZmLCAweDg0Yzg3ODE0LCAweDhjYzcwMjA4LAogIDB4OTBiZWZmZmEsIDB4YTQ1MDZjZWIsIDB4YmVmOWEzZjcsIDB4YzY3MTc4ZjIsCl0pOwpjb25zdCBST1RSID0gKHgsIG4pID0+ICh4ID4+PiBuKSB8ICh4IDw8ICgzMiAtIG4pKTsKY29uc3QgQ2ggPSAoeCwgeSwgeikgPT4gKHggJiB5KSBeICh+eCAmIHopOwpjb25zdCBNYWogPSAoeCwgeSwgeikgPT4gKHggJiB5KSBeICh4ICYgeikgXiAoeSAmIHopOwpjb25zdCBTaWdtYTAgPSAoeCkgPT4gUk9UUih4LCAyKSBeIFJPVFIoeCwgMTMpIF4gUk9UUih4LCAyMik7CmNvbnN0IFNpZ21hMSA9ICh4KSA9PiBST1RSKHgsIDYpIF4gUk9UUih4LCAxMSkgXiBST1RSKHgsIDI1KTsKY29uc3Qgc2lnbWEwID0gKHgpID0+IFJPVFIoeCwgNykgXiBST1RSKHgsIDE4KSBeICh4ID4+PiAzKTsKY29uc3Qgc2lnbWExID0gKHgpID0+IFJPVFIoeCwgMTcpIF4gUk9UUih4LCAxOSkgXiAoeCA+Pj4gMTApOwoKZXhwb3J0IGZ1bmN0aW9uIHNoYTI1Nihtc2dVOCkgewogIGNvbnN0IG0gPSB0b1U4KG1zZ1U4KTsKICAKICBsZXQgaDAgPSAweDZhMDllNjY3LAogICAgaDEgPSAweGJiNjdhZTg1LAogICAgaDIgPSAweDNjNmVmMzcyLAogICAgaDMgPSAweGE1NGZmNTNhOwogIGxldCBoNCA9IDB4NTEwZTUyN2YsCiAgICBoNSA9IDB4OWIwNTY4OGMsCiAgICBoNiA9IDB4MWY4M2Q5YWIsCiAgICBoNyA9IDB4NWJlMGNkMTk7CgogIAogIGNvbnN0IGJpdExlbkhpID0gTWF0aC5mbG9vcigobS5sZW5ndGggLyAweDIwMDAwMDAwKSA+Pj4gMCk7IAogIGNvbnN0IGJpdExlbkxvID0gKChtLmxlbmd0aCA+Pj4gMCkgKiA4KSA+Pj4gMDsgCiAgY29uc3QgayA9IC0obS5sZW5ndGggKyA5KSAmIDYzOwogIGNvbnN0IHBhZGRlZCA9IG5ldyBVaW50OEFycmF5KG0ubGVuZ3RoICsgMSArIGsgKyA4KTsKICBwYWRkZWQuc2V0KG0sIDApOwogIHBhZGRlZFttLmxlbmd0aF0gPSAweDgwOwogIAogIHBhZGRlZFtwYWRkZWQubGVuZ3RoIC0gOF0gPSAoYml0TGVuSGkgPj4+IDI0KSAmIDB4ZmY7CiAgcGFkZGVkW3BhZGRlZC5sZW5ndGggLSA3XSA9IChiaXRMZW5IaSA+Pj4gMTYpICYgMHhmZjsKICBwYWRkZWRbcGFkZGVkLmxlbmd0aCAtIDZdID0gKGJpdExlbkhpID4+PiA4KSAmIDB4ZmY7CiAgcGFkZGVkW3BhZGRlZC5sZW5ndGggLSA1XSA9IGJpdExlbkhpICYgMHhmZjsKICBwYWRkZWRbcGFkZGVkLmxlbmd0aCAtIDRdID0gKGJpdExlbkxvID4+PiAyNCkgJiAweGZmOwogIHBhZGRlZFtwYWRkZWQubGVuZ3RoIC0gM10gPSAoYml0TGVuTG8gPj4+IDE2KSAmIDB4ZmY7CiAgcGFkZGVkW3BhZGRlZC5sZW5ndGggLSAyXSA9IChiaXRMZW5MbyA+Pj4gOCkgJiAweGZmOwogIHBhZGRlZFtwYWRkZWQubGVuZ3RoIC0gMV0gPSBiaXRMZW5MbyAmIDB4ZmY7CgogIGNvbnN0IFcgPSBuZXcgVWludDMyQXJyYXkoNjQpOwoKICBmb3IgKGxldCBvZmYgPSAwOyBvZmYgPCBwYWRkZWQubGVuZ3RoOyBvZmYgKz0gNjQpIHsKICAgIAogICAgZm9yIChsZXQgaSA9IDA7IGkgPCAxNjsgaSsrKSB7CiAgICAgIGNvbnN0IGogPSBvZmYgKyAoaSA8PCAyKTsKICAgICAgV1tpXSA9CiAgICAgICAgKHBhZGRlZFtqXSA8PCAyNCkgfAogICAgICAgIChwYWRkZWRbaiArIDFdIDw8IDE2KSB8CiAgICAgICAgKHBhZGRlZFtqICsgMl0gPDwgOCkgfAogICAgICAgIHBhZGRlZFtqICsgM107CiAgICB9CiAgICBmb3IgKGxldCBpID0gMTY7IGkgPCA2NDsgaSsrKSB7CiAgICAgIFdbaV0gPQogICAgICAgIChzaWdtYTEoV1tpIC0gMl0pICsgV1tpIC0gN10gKyBzaWdtYTAoV1tpIC0gMTVdKSArIFdbaSAtIDE2XSkgPj4+IDA7CiAgICB9CgogICAgCiAgICBsZXQgYSA9IGgwLAogICAgICBiID0gaDEsCiAgICAgIGMgPSBoMiwKICAgICAgZCA9IGgzLAogICAgICBlID0gaDQsCiAgICAgIGYgPSBoNSwKICAgICAgZyA9IGg2LAogICAgICBoID0gaDc7CgogICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2NDsgaSsrKSB7CiAgICAgIGNvbnN0IHQxID0gKGggKyBTaWdtYTEoZSkgKyBDaChlLCBmLCBnKSArIEtbaV0gKyBXW2ldKSA+Pj4gMDsKICAgICAgY29uc3QgdDIgPSAoU2lnbWEwKGEpICsgTWFqKGEsIGIsIGMpKSA+Pj4gMDsKICAgICAgaCA9IGc7CiAgICAgIGcgPSBmOwogICAgICBmID0gZTsKICAgICAgZSA9IChkICsgdDEpID4+PiAwOwogICAgICBkID0gYzsKICAgICAgYyA9IGI7CiAgICAgIGIgPSBhOwogICAgICBhID0gKHQxICsgdDIpID4+PiAwOwogICAgfQoKICAgIGgwID0gKGgwICsgYSkgPj4+IDA7CiAgICBoMSA9IChoMSArIGIpID4+PiAwOwogICAgaDIgPSAoaDIgKyBjKSA+Pj4gMDsKICAgIGgzID0gKGgzICsgZCkgPj4+IDA7CiAgICBoNCA9IChoNCArIGUpID4+PiAwOwogICAgaDUgPSAoaDUgKyBmKSA+Pj4gMDsKICAgIGg2ID0gKGg2ICsgZykgPj4+IDA7CiAgICBoNyA9IChoNyArIGgpID4+PiAwOwogIH0KCiAgY29uc3Qgb3V0ID0gbmV3IFVpbnQ4QXJyYXkoMzIpOwogIGNvbnN0IEggPSBbaDAsIGgxLCBoMiwgaDMsIGg0LCBoNSwgaDYsIGg3XTsKICBmb3IgKGxldCBpID0gMDsgaSA8IDg7IGkrKykgb3V0LnNldChpMzJiZShIW2ldKSwgaSAqIDQpOwogIHJldHVybiBvdXQ7Cn0KCgoKCgpmdW5jdGlvbiBtYWtlSG1hY1NoYTI1NihrZXkpIHsKICBrZXkgPSB0b1U4KGtleSk7CiAgY29uc3QgYmxvY2sgPSA2NDsKICBpZiAoa2V5Lmxlbmd0aCA+IGJsb2NrKSBrZXkgPSBzaGEyNTYoa2V5KTsKICBpZiAoa2V5Lmxlbmd0aCA8IGJsb2NrKSB7CiAgICBjb25zdCBrID0gbmV3IFVpbnQ4QXJyYXkoYmxvY2spOwogICAgay5zZXQoa2V5KTsKICAgIGtleSA9IGs7CiAgfQogIGNvbnN0IGlwYWQgPSBuZXcgVWludDhBcnJheShibG9jayk7CiAgY29uc3Qgb3BhZCA9IG5ldyBVaW50OEFycmF5KGJsb2NrKTsKICBmb3IgKGxldCBpID0gMDsgaSA8IGJsb2NrOyBpKyspIHsKICAgIGlwYWRbaV0gPSBrZXlbaV0gXiAweDM2OwogICAgb3BhZFtpXSA9IGtleVtpXSBeIDB4NWM7CiAgfQogIHJldHVybiAobXNnKSA9PiBzaGEyNTYoY29uY2F0KG9wYWQsIHNoYTI1Nihjb25jYXQoaXBhZCwgdG9VOChtc2cpKSkpKTsKfQoKCgoKCmV4cG9ydCBmdW5jdGlvbiBwYmtkZjJTaGEyNTYoeyBwYXNzd29yZCwgc2FsdCwgaXRlcmF0aW9ucywgZGtMZW4gfSkgewogIGNvbnN0IFAgPSB0b1U4KHBhc3N3b3JkKTsKICBjb25zdCBTID0gdG9VOChzYWx0KTsKICBpZiAoIU51bWJlci5pc0ludGVnZXIoaXRlcmF0aW9ucykgfHwgaXRlcmF0aW9ucyA8PSAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIml0ZXJhdGlvbnMgbXVzdCBiZSBhIHBvc2l0aXZlIGludGVnZXIiKTsKICB9CiAgaWYgKCFOdW1iZXIuaXNJbnRlZ2VyKGRrTGVuKSB8fCBka0xlbiA8PSAwKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoImRrTGVuIG11c3QgYmUgYSBwb3NpdGl2ZSBpbnRlZ2VyIik7CiAgfQoKICBjb25zdCBoTGVuID0gMzI7IAogIGNvbnN0IGwgPSBNYXRoLmNlaWwoZGtMZW4gLyBoTGVuKTsKICBjb25zdCByID0gZGtMZW4gLSAobCAtIDEpICogaExlbjsKCiAgY29uc3QgUFJGID0gbWFrZUhtYWNTaGEyNTYoUCk7CiAgY29uc3QgREsgPSBuZXcgVWludDhBcnJheShka0xlbik7CiAgY29uc3QgYmxvY2tCdWYgPSBuZXcgVWludDhBcnJheShoTGVuKTsgCgogIGZvciAobGV0IGkgPSAxOyBpIDw9IGw7IGkrKykgewogICAgCiAgICBjb25zdCBVMSA9IFBSRihjb25jYXQoUywgaTMyYmUoaSkpKTsKICAgIGJsb2NrQnVmLnNldChVMSk7CiAgICBsZXQgVXByZXYgPSBVMTsKICAgIGZvciAobGV0IGogPSAyOyBqIDw9IGl0ZXJhdGlvbnM7IGorKykgewogICAgICBVcHJldiA9IFBSRihVcHJldik7CiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgaExlbjsgaysrKSBibG9ja0J1ZltrXSBePSBVcHJldltrXTsKICAgIH0KICAgIGNvbnN0IG9mZnNldCA9IChpIC0gMSkgKiBoTGVuOwogICAgREsuc2V0KGJsb2NrQnVmLnN1YmFycmF5KDAsIGkgPT09IGwgPyByIDogaExlbiksIG9mZnNldCk7CiAgfQogIAogIGJsb2NrQnVmLmZpbGwoMCk7CiAgcmV0dXJuIERLOwp9CgoKZXhwb3J0IGZ1bmN0aW9uIHBia2RmMlNoYTI1NkhleChvcHRzKSB7CiAgY29uc3Qgb3V0ID0gcGJrZGYyU2hhMjU2KG9wdHMpOwogIHJldHVybiBbLi4ub3V0XS5tYXAoKGIpID0+IGIudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsICIwIikpLmpvaW4oIiIpOwp9CgogIDwvc2NyaXB0PgoKICA8c2NyaXB0IHR5cGU9Im1vZHVsZSI+CgogICAgY29uc3QgJCA9IChzKSA9PiBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKHMpOwoKICAgIGFzeW5jIGZ1bmN0aW9uIGxvYWRJbmxpbmVNb2R1bGUoaWQpIHsKICAgICAgY29uc3QgY29kZSA9ICQoJyMnICsgaWQpLnRleHRDb250ZW50OwogICAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKG5ldyBCbG9iKFtjb2RlXSwgeyB0eXBlOiAndGV4dC9qYXZhc2NyaXB0JyB9KSk7CiAgICAgIHJldHVybiB7IG1vZHVsZTogYXdhaXQgaW1wb3J0KHVybCksIGNvZGUgfTsKICAgIH0KCiAgICBjb25zdCBhZXMyNTZnY20gPSBhd2FpdCBsb2FkSW5saW5lTW9kdWxlKCdhZXMyNTZnY20tc2NyaXB0Jyk7CiAgICBjb25zdCBwYmtkZjIgPSBhd2FpdCBsb2FkSW5saW5lTW9kdWxlKCdwYmtkZjItc2NyaXB0Jyk7CgogICAgY29uc3QgREVDT0RFX1RFTVBMQVRFID0gJCgiI2RlY29kZS10ZW1wbGF0ZSIpLmlubmVySFRNTDsKCiAgICAvLyAtLS0gaGVscGVycyAtLS0KICAgIGNvbnN0IGVuYyA9IG5ldyBUZXh0RW5jb2RlcigpOwogICAgY29uc3QgYjY0ID0gKGJ1ZikgPT4gYnRvYShTdHJpbmcuZnJvbUNoYXJDb2RlKC4uLm5ldyBVaW50OEFycmF5KGJ1ZikpKTsKICAgIGNvbnN0IHJhbmQgPSAobikgPT4gY3J5cHRvLmdldFJhbmRvbVZhbHVlcyhuZXcgVWludDhBcnJheShuKSk7CgogICAgYXN5bmMgZnVuY3Rpb24gZW5jcnlwdFNlY3JldChzZWNyZXQsIHBhc3N3b3JkLCBpdGVyYXRpb25zKSB7CiAgICAgIGNvbnN0IHNhbHQgPSByYW5kKDE2KTsKICAgICAgY29uc3QgaXYgPSByYW5kKDEyKTsKICAgICAgLy8gc3VidGxlIGlzIG5vdCBhdmFpbGFibGUgaW4gZGF0YSB1cmxzLiB1c2UgcHVyZSBKUyBpbXBsZW1lbnRhdGlvbnMuCiAgICAgIC8vIERlcml2ZSBrZXkgdXNpbmcgUEJLREYyCiAgICAgIGNvbnN0IGtleSA9IHBia2RmMi5tb2R1bGUucGJrZGYyU2hhMjU2KHsKICAgICAgICBwYXNzd29yZDogZW5jLmVuY29kZShwYXNzd29yZCksCiAgICAgICAgc2FsdDogc2FsdCwKICAgICAgICBpdGVyYXRpb25zOiBpdGVyYXRpb25zLAogICAgICAgIGRrTGVuOiAzMiAvLyAyNTYgYml0cyBmb3IgQUVTLTI1NgogICAgICB9KTsKCiAgICAgIC8vIEVuY3J5cHQgdXNpbmcgQUVTLUdDTQogICAgICBjb25zdCB7IGNpcGhlcnRleHQsIHRhZyB9ID0gYWVzMjU2Z2NtLm1vZHVsZS5hZXMyNTZHY21FbmNyeXB0KHsKICAgICAgICBrZXk6IGtleSwKICAgICAgICBpdjogaXYsCiAgICAgICAgcGxhaW50ZXh0OiBlbmMuZW5jb2RlKHNlY3JldCkKICAgICAgfSk7CgogICAgICByZXR1cm4geyBjdEI2NDogYjY0KGNpcGhlcnRleHQpLCBpdkI2NDogYjY0KGl2KSwgc2FsdEI2NDogYjY0KHNhbHQpLCB0YWdCNjQ6IGI2NCh0YWcpIH07CiAgICB9CgogICAgZnVuY3Rpb24gYnVpbGREZWNvZGVIVE1MKHRlbXBsYXRlLCB7IGN0QjY0LCBpdkI2NCwgc2FsdEI2NCwgdGFnQjY0IH0sIGl0ZXJhdGlvbnMpIHsKICAgICAgcmV0dXJuIHRlbXBsYXRlCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fQ0lQSEVSVEVYVF9CNjRfXyIsIGN0QjY0KQogICAgICAgIC5yZXBsYWNlQWxsKCJfX0lWX0I2NF9fIiwgaXZCNjQpCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fU0FMVF9CNjRfXyIsIHNhbHRCNjQpCiAgICAgICAgLnJlcGxhY2VBbGwoIl9fVEFHX0I2NF9fIiwgdGFnQjY0KQogICAgICAgIC5yZXBsYWNlQWxsKCJfX0lURVJBVElPTlNfXyIsIFN0cmluZyhpdGVyYXRpb25zKSkKICAgICAgICAucmVwbGFjZUFsbCgiX19JTkNMVURFX0FFUzI1NkdDTV9KU18yX18iLCBhZXMyNTZnY20uY29kZSkKICAgICAgICAucmVwbGFjZUFsbCgiX19JTkNMVURFX1BCS0RGMl9KU18yX18iLCBwYmtkZjIuY29kZSk7CiAgICB9CgogICAgZnVuY3Rpb24gdG9EYXRhVVJMKGh0bWwpIHsKICAgICAgLy8gQmFzZTY0LWVuY29kZSBVVEYtOCBzYWZlbHkKICAgICAgY29uc3QgdXRmOCA9IG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShodG1sKTsKICAgICAgbGV0IHMgPSAiIjsKICAgICAgZm9yIChjb25zdCBjIG9mIHV0ZjgpIHMgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShjKTsKICAgICAgY29uc3QgYjY0ID0gYnRvYShzKTsKICAgICAgcmV0dXJuIGBkYXRhOnRleHQvaHRtbDtiYXNlNjQsJHtiNjR9YDsKICAgIH0KCiAgICBhc3luYyBmdW5jdGlvbiBjb3B5VG9DbGlwYm9hcmQodGV4dCwgYnV0dG9uKSB7CiAgICAgIGNvbnN0IG9yaWdpbmFsVGV4dCA9IGJ1dHRvbi50ZXh0Q29udGVudDsKICAgICAgdHJ5IHsKICAgICAgICBhd2FpdCBuYXZpZ2F0b3IuY2xpcGJvYXJkLndyaXRlVGV4dCh0ZXh0KTsKICAgICAgfSBjYXRjaCAoZXJyKSB7CiAgICAgICAgY29uc3QgdGV4dGFyZWEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd0ZXh0YXJlYScpOwogICAgICAgIHRleHRhcmVhLnZhbHVlID0gdGV4dDsKICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRleHRhcmVhKTsKICAgICAgICB0ZXh0YXJlYS5zZWxlY3QoKTsKICAgICAgICBkb2N1bWVudC5leGVjQ29tbWFuZCgnY29weScpOwogICAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQodGV4dGFyZWEpOwogICAgICB9CiAgICAgIGJ1dHRvbi50ZXh0Q29udGVudCA9ICJDb3BpZWQhIjsKICAgICAgc2V0VGltZW91dCgoKSA9PiB7CiAgICAgICAgYnV0dG9uLnRleHRDb250ZW50ID0gb3JpZ2luYWxUZXh0OwogICAgICB9LCAyMDAwKTsKICAgIH0KCiAgICAkKCIjY29weS1wdyIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKCkgPT4gewogICAgICBjb25zdCBwdyA9ICQoIiNwdyIpLnZhbHVlOwogICAgICBpZiAocHcpIGNvcHlUb0NsaXBib2FyZChwdywgJCgiI2NvcHktcHciKSk7CiAgICB9KTsKCiAgICAkKCIjY29weS11cmwiKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsICgpID0+IHsKICAgICAgY29uc3QgdXJsID0gJCgiI3VybCIpLnRleHRDb250ZW50OwogICAgICBpZiAodXJsICYmIHVybCAhPT0gIkVuY3J5cHRpbmcuLi4iICYmICF1cmwuc3RhcnRzV2l0aCgiRXJyb3I6IikpIHsKICAgICAgICBjb3B5VG9DbGlwYm9hcmQodXJsLCAkKCIjY29weS11cmwiKSk7CiAgICAgIH0KICAgIH0pOwoKICAgICQoIiNnZW5lcmF0ZS1wdyIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgKCkgPT4gewogICAgICBjb25zdCBwdyA9IGI2NChyYW5kKDI0KSkucmVwbGFjZSgvXCsvZywgJ0EnKS5yZXBsYWNlKC9cLy9nLCAnQicpLnJlcGxhY2UoLz0vZywgJycpOwogICAgICAkKCIjcHciKS52YWx1ZSA9IHB3OwogICAgfSk7CgogICAgJCgiI2dvIikuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBhc3luYyAoKSA9PiB7CiAgICAgIGNvbnN0IHNlY3JldCA9ICgkKCIjc2VjcmV0IikudmFsdWUgfHwgIiIpOwogICAgICBjb25zdCBwdyA9ICgkKCIjcHciKS52YWx1ZSB8fCAiIik7CiAgICAgIGNvbnN0IGl0ZXJzID0gNTAwXzAwMDsKICAgICAgY29uc3Qgb3V0ID0gJCgiI3VybCIpOwogICAgICBjb25zdCBjb3B5VXJsQnRuID0gJCgiI2NvcHktdXJsIik7CgogICAgICBpZiAoIXB3KSB7IG91dC50ZXh0Q29udGVudCA9ICJQbGVhc2UgZW50ZXIgYSBwYXNzd29yZC4iOyByZXR1cm47IH0KCiAgICAgIG91dC50ZXh0Q29udGVudCA9ICJFbmNyeXB0aW5nLi4uIjsKICAgICAgY29weVVybEJ0bi5zdHlsZS5kaXNwbGF5ID0gIm5vbmUiOwoKICAgICAgdHJ5IHsKICAgICAgICBjb25zdCBwYXlsb2FkID0gYXdhaXQgZW5jcnlwdFNlY3JldChzZWNyZXQsIHB3LCBpdGVycyk7CiAgICAgICAgY29uc3QgZGVjb2RlSFRNTCA9IGJ1aWxkRGVjb2RlSFRNTChERUNPREVfVEVNUExBVEUsIHBheWxvYWQsIGl0ZXJzKTsKICAgICAgICBjb25zdCB1cmwgPSB0b0RhdGFVUkwoZGVjb2RlSFRNTCk7CiAgICAgICAgb3V0LnRleHRDb250ZW50ID0gdXJsOwogICAgICAgIGNvcHlVcmxCdG4uc3R5bGUuZGlzcGxheSA9ICJpbmxpbmUtYmxvY2siOwogICAgICB9IGNhdGNoIChlcnIpIHsKICAgICAgICBvdXQudGV4dENvbnRlbnQgPSBgRXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YDsKICAgICAgICBjb3B5VXJsQnRuLnN0eWxlLmRpc3BsYXkgPSAibm9uZSI7CiAgICAgIH0KICAgIH0pOwogIDwvc2NyaXB0Pgo8L2JvZHk+Cgo8L2h0bWw+
```